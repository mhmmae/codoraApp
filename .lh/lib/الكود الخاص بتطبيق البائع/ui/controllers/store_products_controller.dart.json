{
    "sourceFile": "lib/Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹/ui/controllers/store_products_controller.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752413026379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752413026379,
            "name": "Commit-0",
            "content": "import 'dart:async';\nimport 'package:flutter/material.dart';\nimport 'package:get/get.dart';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:get_storage/get_storage.dart';\nimport '../../../Model/SellerModel.dart';\nimport '../../addItem/editProducts/controllers/edit_product_controller.dart';\nimport '../../../XXX/xxx_firebase.dart';\nimport 'retail_cart_controller.dart';\nimport '../pages/product_details_page.dart';\n\nenum ProductViewType { grid, list, compact, detailed }\n\nclass StoreProductsController extends GetxController {\n  /// ØªØ­Ø¯ÙŠØ« Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†\n  void setPriceRange(RangeValues values) {\n    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù‚ÙŠÙ… Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØµØ­ÙŠØ­\n    final double min = minPrice.value;\n    final double max = maxPrice.value;\n    double start = values.start.clamp(min, max);\n    double end = values.end.clamp(min, max);\n    // Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰\n    if (start > end) {\n      final temp = start;\n      start = end;\n      end = temp;\n    }\n    currentMinPrice.value = start;\n    currentMaxPrice.value = end;\n    priceRange.value = RangeValues(start, end);\n    _filterProducts();\n  }\n\n  final SellerModel store;\n\n  StoreProductsController({required this.store});\n\n  // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ÙØ¶Ù„Ø©\n  final GetStorage _storage = GetStorage();\n\n  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©\n  final RxList<Map<String, dynamic>> allProducts = <Map<String, dynamic>>[].obs;\n  final RxList<Map<String, dynamic>> filteredProducts =\n      <Map<String, dynamic>>[].obs;\n  final RxBool isLoading = false.obs;\n  final RxBool isGridView = true.obs;\n  final RxString selectedCategory = 'Ø§Ù„ÙƒÙ„'.obs;\n  final RxList<String> categories = <String>['Ø§Ù„ÙƒÙ„'].obs;\n\n  // Ù…ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ±\n  final TextEditingController searchController = TextEditingController();\n  final FocusNode searchFocusNode = FocusNode();\n  final RxString searchQuery = ''.obs;\n  final RxString sortBy = 'Ø§Ù„Ø£Ø­Ø¯Ø«'.obs;\n  final RxBool showFilters = false.obs;\n  final RxBool showFavoritesOnly = false.obs;\n  final RxBool showDiscountedOnly = false.obs;\n  final RxDouble minRating = 0.0.obs;\n  final RxString currentSort = 'Ø§Ù„Ø£Ø­Ø¯Ø«'.obs;\n\n  // Ù…Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©\n  final RxList<String> favoriteProducts = <String>[].obs;\n  final RxMap<String, double> productRatings = <String, double>{}.obs;\n  final RxString voiceSearchQuery = ''.obs;\n  final RxBool isVoiceSearching = false.obs;\n  final RxList<String> searchSuggestions = <String>[].obs;\n\n  // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†\n  final RxList<Map<String, dynamic>> compareProducts =\n      <Map<String, dynamic>>[].obs;\n  final int maxCompareItems = 3;\n\n  // ÙÙ„Ø§ØªØ± Ø§Ù„Ø³Ø¹Ø±\n  final RxDouble minPrice = 0.0.obs;\n  final RxDouble maxPrice =\n      4000.0.obs; // Initialize maxPrice to 1000 to match RangeSlider\n  final RxDouble currentMinPrice = 0.0.obs;\n  final RxDouble currentMaxPrice =\n      2000.0.obs; // Initialize currentMaxPrice to 1000 to match RangeSlider\n\n  // New properties for product view and filters\n  final Rx<ProductViewType> productViewType = ProductViewType.grid.obs;\n  final Rx<RangeValues> priceRange = const RangeValues(0, 1000).obs;\n\n  // ÙÙ„Ø§ØªØ± Ø¬Ø¯ÙŠØ¯Ø©\n  final RxString selectedCountry = 'ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„'.obs;\n  // Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù…Ù† EditProductController\n  final List<String> countryOptions =\n      [\n        'ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„',\n        ...EditProductController.countryOfOriginOptions.entries\n            .map((e) => e.value['ar']!)\n            .toSet(),\n      ].toList();\n  final RxString selectedQuality = 'Ø§Ù„ÙƒÙ„'.obs;\n  final List<String> qualityOptions =\n      ['Ø§Ù„ÙƒÙ„', 'Ù…Ù…ØªØ§Ø²', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', 'Ø¬ÙŠØ¯', 'Ù…Ù‚Ø¨ÙˆÙ„'].obs;\n  final RxString selectedProductType = 'Ø§Ù„ÙƒÙ„'.obs;\n  final List<String> productTypeOptions = ['Ø§Ù„ÙƒÙ„', 'ØªØ¬Ø§Ø±ÙŠ', 'Ø£ØµÙ„ÙŠ'].obs;\n  final RxBool filterOnOffer = false.obs;\n\n  // ØªØªØ¨Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø©\n  final RxInt totalProductsInCart = 0.obs;\n\n  // Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø© (ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø³Ø±ÙŠØ¹)\n  final RxBool isProcessingCart = false.obs;\n\n  @override\n  void onInit() {\n    super.onInit();\n    loadProducts();\n    _updateCartCount();\n    _loadFavoritesFromStorage(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ\n    _loadCompareList(); // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ\n\n    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø­Ø«\n    searchController.addListener(() {\n      searchQuery.value = searchController.text;\n      _filterProducts();\n    });\n\n    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ±\n    ever(selectedCategory, (_) => _filterProducts());\n    ever(sortBy, (_) => _filterProducts());\n    ever(currentMinPrice, (_) => _filterProducts());\n    ever(currentMaxPrice, (_) => _filterProducts());\n    ever(showFavoritesOnly, (_) => _filterProducts());\n    ever(showDiscountedOnly, (_) => _filterProducts());\n    ever(minRating, (_) => _filterProducts());\n    ever(selectedCountry, (_) => _filterProducts());\n    ever(selectedQuality, (_) => _filterProducts());\n    ever(selectedProductType, (_) => _filterProducts());\n\n    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©\n    Timer.periodic(Duration(seconds: 1), (_) => _updateCartCount());\n  }\n\n  @override\n  void onClose() {\n    searchController.dispose();\n    searchFocusNode.dispose();\n    super.onClose();\n  }\n\n  /// ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±\n  Future<void> loadProducts() async {\n    try {\n      isLoading.value = true;\n      debugPrint('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±: ${store.shopName}');\n      debugPrint('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ UID: ${store.uid}');\n      debugPrint('ğŸ—‚ï¸ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©: ${FirebaseX.itemsCollection}');\n      debugPrint(\n        'ğŸª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±: Ø§Ø³Ù…=${store.shopName}, Ù†ÙˆØ¹=${store.sellerType}, ID=${store.uid}',\n      );\n\n      final QuerySnapshot snapshot =\n          await FirebaseFirestore.instance\n              .collection(FirebaseX.itemsCollection)\n              .where('uidAdd', isEqualTo: store.uid)\n              .where('addedBySellerType', isEqualTo: 'wholesale')\n              .get();\n\n      final List<Map<String, dynamic>> products = [];\n      final Set<String> categorySet = {'Ø§Ù„ÙƒÙ„'};\n\n      debugPrint('ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${snapshot.docs.length} Ù…Ø³ØªÙ†Ø¯');\n\n      // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù…Ù†ØªØ¬Ø§ØªØŒ Ø¬Ø±Ø¨ Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹\n      if (snapshot.docs.isEmpty) {\n        debugPrint(\n          'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹ØŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±...',\n        );\n        final fallbackSnapshot =\n            await FirebaseFirestore.instance\n                .collection(FirebaseX.itemsCollection)\n                .where('uidAdd', isEqualTo: store.uid)\n                .get();\n        debugPrint(\n          'ğŸ“Š Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ¬Ø¯ ${fallbackSnapshot.docs.length} Ù…Ø³ØªÙ†Ø¯',\n        );\n\n        for (var doc in fallbackSnapshot.docs) {\n          final data = doc.data();\n          data['id'] = doc.id;\n\n          debugPrint(\n            'ğŸ“ Ù…Ù†ØªØ¬ Ø§Ø­ØªÙŠØ§Ø·ÙŠ: ${data['nameOfItem']} - UID: ${data['uidAdd']} - Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹: ${data['addedBySellerType']}',\n          );\n\n          products.add(data);\n\n          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª\n          final category = data['selectedMainCategoryNameAr'] as String?;\n          if (category != null && category.isNotEmpty) {\n            categorySet.add(category);\n          }\n        }\n      } else {\n        for (var doc in snapshot.docs) {\n          final data = doc.data() as Map<String, dynamic>;\n          data['id'] = doc.id;\n\n          debugPrint(\n            'ğŸ“ Ù…Ù†ØªØ¬: ${data['nameOfItem']} - UID: ${data['uidAdd']} - Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹: ${data['addedBySellerType']}',\n          );\n\n          products.add(data);\n\n          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª\n          final category = data['selectedMainCategoryNameAr'] as String?;\n          if (category != null && category.isNotEmpty) {\n            categorySet.add(category);\n          }\n        }\n      }\n\n      debugPrint('ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${products.length}');\n      debugPrint('ğŸ·ï¸ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${categorySet.join(', ')}');\n\n      allProducts.value = products;\n      categories.value = categorySet.toList();\n\n      // ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±\n      if (products.isNotEmpty) {\n        final prices =\n            products\n                .map(\n                  (p) =>\n                      double.tryParse(p['priceOfItem']?.toString() ?? '0') ??\n                      0.0,\n                )\n                .where((price) => price > 0)\n                .toList();\n\n        if (prices.isNotEmpty) {\n          minPrice.value = 0.0;\n          maxPrice.value = prices.reduce((a, b) => a > b ? a : b);\n\n          // Ø§Ø¶Ø¨Ø· currentMinPrice ÙˆcurrentMaxPrice ÙˆpriceRange Ø­Ø³Ø¨ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯\n          currentMinPrice.value = minPrice.value;\n          currentMaxPrice.value = maxPrice.value;\n          priceRange.value = RangeValues(minPrice.value, maxPrice.value);\n        }\n      }\n\n      _filterProducts();\n\n      debugPrint(\n        'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} Ù…Ù†ØªØ¬ Ù…Ù† Ù…ØªØ¬Ø± ${store.shopName}',\n      );\n      debugPrint('ğŸ“Š Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${categories.join(', ')}');\n    } catch (e) {\n      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±: $e');\n      Get.snackbar(\n        'Ø®Ø·Ø£',\n        'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',\n        snackPosition: SnackPosition.BOTTOM,\n        backgroundColor: Colors.red.withOpacity(0.8),\n        colorText: Colors.white,\n      );\n    } finally {\n      isLoading.value = false;\n    }\n  }\n\n  /// ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª\n  void _filterProducts() {\n    // Ù…Ù†Ø·Ù‚ AND: Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­Ù‚Ù‚ ÙƒÙ„ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© Ù„ÙŠØ¸Ù‡Ø±\n    List<Map<String, dynamic>> filtered =\n        allProducts.where((product) {\n          // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«\n          if (searchQuery.value.isNotEmpty) {\n            final name = product['nameOfItem']?.toString().toLowerCase() ?? '';\n            final description =\n                product['descriptionOfItem']?.toString().toLowerCase() ?? '';\n            final query = searchQuery.value.toLowerCase();\n            if (!(name.contains(query) || description.contains(query))) {\n              return false;\n            }\n          }\n          // ÙÙ„ØªØ± Ø§Ù„ÙØ¦Ø© (ÙŠØ¹Ø±Ø¶ ÙƒÙ„ Ù…Ù†ØªØ¬ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)\n          if (selectedCategory.value != 'Ø§Ù„ÙƒÙ„') {\n            final String? mainCategoryId =\n                product['mainCategoryId']?.toString();\n            debugPrint(\n              'ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: selectedCategory=${selectedCategory.value} | mainCategoryId=$mainCategoryId | Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬=${product['nameOfItem']}',\n            );\n            if (mainCategoryId == null || mainCategoryId.isEmpty) {\n              debugPrint('âŒ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ mainCategoryId');\n              return false;\n            }\n            if (mainCategoryId != selectedCategory.value) {\n              debugPrint('âŒ mainCategoryId Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±');\n              return false;\n            }\n            debugPrint('âœ… Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');\n          }\n          // ÙÙ„ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø© (Ø¯Ø¹Ù… Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯)\n          if (selectedCountry.value != 'ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„') {\n            String? filterCountryCode;\n            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒÙˆØ¯ Ø¯ÙˆÙ„Ø© (Ø­Ø±ÙÙŠÙ†)\n            if (EditProductController.countryOfOriginOptions.containsKey(\n              selectedCountry.value,\n            )) {\n              filterCountryCode = selectedCountry.value;\n            } else {\n              // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ\n              final match = EditProductController.countryOfOriginOptions.entries\n                  .firstWhere(\n                    (e) => e.value['ar'] == selectedCountry.value,\n                    orElse: () => const MapEntry('', {'ar': '', 'en': ''}),\n                  );\n              filterCountryCode = match.key.isNotEmpty ? match.key : null;\n            }\n            final productCountryCode =\n                product['countryOfOrigin']?.toString() ?? '';\n            if (filterCountryCode == null) return false;\n            if (productCountryCode != filterCountryCode) return false;\n          }\n          // ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø±\n          final price =\n              double.tryParse(product['priceOfItem']?.toString() ?? '0') ?? 0.0;\n          if (price < currentMinPrice.value || price > currentMaxPrice.value) {\n            return false;\n          }\n          // ÙÙ„ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø©\n          if (selectedQuality.value != 'Ø§Ù„ÙƒÙ„') {\n            if ((product['qualityGrade']?.toString() ?? '') !=\n                selectedQuality.value) {\n              return false;\n            }\n          }\n          // ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ (ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯)\n          if (selectedProductType.value != 'Ø§Ù„ÙƒÙ„') {\n            String? typeKey;\n            if (selectedProductType.value == 'Ø£ØµÙ„ÙŠ') {\n              typeKey = 'original';\n            } else if (selectedProductType.value == 'ØªØ¬Ø§Ø±ÙŠ') {\n              typeKey = 'commercial';\n            } else {\n              typeKey = selectedProductType.value;\n            }\n            if ((product['itemCondition']?.toString() ?? '') != typeKey) {\n              return false;\n            }\n          }\n          return true;\n        }).toList();\n\n    // ÙÙ‚Ø· Ø§Ù„ØªØ±ØªÙŠØ¨\n    _sortProducts(filtered);\n\n    filteredProducts.value = filtered;\n    debugPrint('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ Ù…Ù†Ø·Ù‚ AND Ù„Ù„ÙÙ„Ø§ØªØ±: ${filtered.length}');\n  }\n\n  /// ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª\n  void _sortProducts(List<Map<String, dynamic>> products) {\n    switch (sortBy.value) {\n      case 'Ø§Ù„Ø£Ø­Ø¯Ø«':\n        products.sort((a, b) {\n          final aTime =\n              a['createdAt'] as Timestamp? ?? a['timestamp'] as Timestamp?;\n          final bTime =\n              b['createdAt'] as Timestamp? ?? b['timestamp'] as Timestamp?;\n          if (aTime == null || bTime == null) return 0;\n          return bTime.compareTo(aTime);\n        });\n        break;\n      case 'Ø§Ù„Ø£Ù‚Ø¯Ù…':\n        products.sort((a, b) {\n          final aTime =\n              a['createdAt'] as Timestamp? ?? a['timestamp'] as Timestamp?;\n          final bTime =\n              b['createdAt'] as Timestamp? ?? b['timestamp'] as Timestamp?;\n          if (aTime == null || bTime == null) return 0;\n          return aTime.compareTo(bTime);\n        });\n        break;\n      case 'Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰':\n        products.sort((a, b) {\n          final aPrice =\n              double.tryParse(a['priceOfItem']?.toString() ?? '0') ?? 0.0;\n          final bPrice =\n              double.tryParse(b['priceOfItem']?.toString() ?? '0') ?? 0.0;\n          return aPrice.compareTo(bPrice);\n        });\n        break;\n      case 'Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„':\n        products.sort((a, b) {\n          final aPrice =\n              double.tryParse(a['priceOfItem']?.toString() ?? '0') ?? 0.0;\n          final bPrice =\n              double.tryParse(b['priceOfItem']?.toString() ?? '0') ?? 0.0;\n          return bPrice.compareTo(aPrice);\n        });\n        break;\n      case 'Ø§Ù„Ø§Ø³Ù…: Ø£-ÙŠ':\n        products.sort((a, b) {\n          final aName = a['nameOfItem']?.toString() ?? '';\n          final bName = b['nameOfItem']?.toString() ?? '';\n          return aName.compareTo(bName);\n        });\n        break;\n      case 'Ø§Ù„Ø§Ø³Ù…: ÙŠ-Ø£':\n        products.sort((a, b) {\n          final aName = a['nameOfItem']?.toString() ?? '';\n          final bName = b['nameOfItem']?.toString() ?? '';\n          return bName.compareTo(aName);\n        });\n        break;\n    }\n  }\n\n  /// ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ±\n  void toggleFilters() {\n    showFilters.value = !showFilters.value;\n  }\n\n  /// Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±\n  void clearFilters() {\n    searchController.clear();\n    selectedCategory.value = 'Ø§Ù„ÙƒÙ„';\n    currentMinPrice.value = minPrice.value;\n    currentMaxPrice.value = maxPrice.value;\n    sortBy.value = 'Ø§Ù„Ø£Ø­Ø¯Ø«';\n    showFavoritesOnly.value = false;\n    showDiscountedOnly.value = false;\n    minRating.value = 0.0;\n    selectedCountry.value = 'ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„';\n    selectedQuality.value = 'Ø§Ù„ÙƒÙ„';\n    selectedProductType.value = 'Ø§Ù„ÙƒÙ„';\n    showFilters.value = false;\n  }\n\n  /// Ø§Ù„ØªØ­Ø¯ÙŠØ«\n  @override\n  Future<void> refresh() async {\n    await loadProducts();\n  }\n\n  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø©\n  bool get hasFilters {\n    return searchQuery.value.isNotEmpty ||\n        selectedCategory.value != 'Ø§Ù„ÙƒÙ„' ||\n        currentMinPrice.value != minPrice.value ||\n        currentMaxPrice.value != maxPrice.value ||\n        sortBy.value != 'Ø§Ù„Ø£Ø­Ø¯Ø«' ||\n        showFavoritesOnly.value ||\n        showDiscountedOnly.value ||\n        minRating.value > 0.0 ||\n        selectedCountry.value != 'ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„' ||\n        selectedQuality.value != 'Ø§Ù„ÙƒÙ„' ||\n        selectedProductType.value != 'Ø§Ù„ÙƒÙ„';\n  }\n\n  /// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬\n  void showProductDetails(Map<String, dynamic> product) {\n    Get.to(\n      () => const ProductDetailsPage(),\n      arguments: {'product': product, 'store': store},\n      transition: Transition.rightToLeft,\n      duration: const Duration(milliseconds: 300),\n    );\n  }\n\n  /// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø©\n  void _updateCartCount() {\n    try {\n      final cartController = Get.find<RetailCartController>();\n      totalProductsInCart.value = cartController.itemCount;\n    } catch (e) {\n      totalProductsInCart.value = 0;\n    }\n  }\n\n  /// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©\n  void addToCart(Map<String, dynamic> product) {\n    if (isProcessingCart.value) return;\n\n    try {\n      isProcessingCart.value = true;\n      final cartController = Get.find<RetailCartController>();\n      cartController.addToCart(product, store);\n\n      // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© ÙÙ‚Ø· Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„\n      _updateCartCount();\n    } catch (e) {\n      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Controller Ù…Ø³Ø¬Ù„ØŒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„Ù‡\n      Get.put(RetailCartController());\n      final cartController = Get.find<RetailCartController>();\n      cartController.addToCart(product, store);\n      _updateCartCount();\n    } finally {\n      isProcessingCart.value = false;\n    }\n  }\n\n  /// Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ù„Ø©\n  void setProcessingCart(bool processing) {\n    isProcessingCart.value = processing;\n  }\n\n  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ù„Ø©\n  bool get isCartProcessing => isProcessingCart.value;\n\n  // ===========================================\n  // ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª\n  // ===========================================\n\n  void rateProduct(String productId, double rating) {\n    productRatings[productId] = rating;\n    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¥Ù„Ù‰ Firebase\n    update(['rating_$productId']);\n  }\n\n  double getProductRating(String productId) {\n    return productRatings[productId] ??\n        (3.5 + (productId.hashCode % 20) / 10); // ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù‚Ø¹ÙŠ Ù…ØªÙ†ÙˆØ¹\n  }\n\n  int getReviewsCount(String productId) {\n    return 15 + (productId.hashCode % 85); // Ø¹Ø¯Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ÙˆØ§Ù‚Ø¹ÙŠ\n  }\n\n  // ===========================================\n  // ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…\n  // ===========================================\n\n  /// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©\n  void toggleFavorite(String productId) {\n    if (isFavorite(productId)) {\n      removeFromFavorites(productId);\n    } else {\n      addToFavorites(productId);\n    }\n  }\n\n  bool isFavorite(String productId) {\n    return favoriteProducts.contains(productId);\n  }\n\n  void addToFavorites(String productId) {\n    if (!favoriteProducts.contains(productId)) {\n      favoriteProducts.add(productId);\n      _saveFavoritesToStorage(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹\n    }\n    update(['favorites_$productId']); // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø¯ÙˆØ¯ Ù„Ù„Ù…ÙØ¶Ù„Ø© ÙÙ‚Ø·\n  }\n\n  void removeFromFavorites(String productId) {\n    favoriteProducts.remove(productId);\n    _saveFavoritesToStorage(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹\n    update(['favorites_$productId']); // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø¯ÙˆØ¯ Ù„Ù„Ù…ÙØ¶Ù„Ø© ÙÙ‚Ø·\n  }\n\n  void clearAllFavorites() {\n    favoriteProducts.clear();\n    _saveFavoritesToStorage(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹\n    update();\n  }\n\n  int get favoritesCount => favoriteProducts.length;\n\n  // ===========================================\n  // ğŸ’¾ Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GetStorage\n  // ===========================================\n\n  /// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ\n  void _loadFavoritesFromStorage() {\n    try {\n      final favoritesKey = 'favorites_${store.uid}'; // Ù…ÙØªØ§Ø­ Ø®Ø§Øµ Ù„ÙƒÙ„ Ù…ØªØ¬Ø±\n      final favoritesList = _storage.read<List<dynamic>>(favoritesKey);\n\n      if (favoritesList != null) {\n        favoriteProducts.value = favoritesList.cast<String>();\n        debugPrint(\n          'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${favoriteProducts.length} Ù…Ù†ØªØ¬ Ù…ÙØ¶Ù„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ',\n        );\n      } else {\n        debugPrint('ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹');\n      }\n    } catch (e) {\n      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ: $e');\n    }\n    update();\n  }\n\n  /// Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ\n  void _saveFavoritesToStorage() {\n    try {\n      final favoritesKey = 'favorites_${store.uid}'; // Ù…ÙØªØ§Ø­ Ø®Ø§Øµ Ù„ÙƒÙ„ Ù…ØªØ¬Ø±\n      _storage.write(favoritesKey, favoriteProducts.toList());\n      debugPrint(\n        'âœ… ØªÙ… Ø­ÙØ¸ ${favoriteProducts.length} Ù…Ù†ØªØ¬ Ù…ÙØ¶Ù„ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ',\n      );\n    } catch (e) {\n      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ: $e');\n    }\n  }\n\n  // ===========================================\n  // ğŸ¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª\n  // ===========================================\n\n  void startVoiceSearch() {\n    isVoiceSearching.value = true;\n\n    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ\n    Future.delayed(Duration(seconds: 3), () {\n      isVoiceSearching.value = false;\n      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ù…Ù†ØªØ¬ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©\n      if (allProducts.isNotEmpty) {\n        final randomProduct = allProducts[allProducts.length ~/ 2];\n        voiceSearchQuery.value = randomProduct['nameOfItem'] ?? '';\n        searchController.text = voiceSearchQuery.value;\n        searchProducts();\n      }\n    });\n  }\n\n  void searchProducts() {\n    generateSearchSuggestions();\n    _filterProducts();\n  }\n\n  void generateSearchSuggestions() {\n    if (searchController.text.isNotEmpty) {\n      searchSuggestions.clear();\n      Set<String> uniqueSuggestions = {};\n\n      for (var product in allProducts) {\n        String name = product['nameOfItem']?.toString() ?? '';\n        String category =\n            product['selectedMainCategoryNameAr']?.toString() ?? '';\n\n        if (name.toLowerCase().contains(searchController.text.toLowerCase())) {\n          uniqueSuggestions.add(name);\n        }\n        if (category.toLowerCase().contains(\n          searchController.text.toLowerCase(),\n        )) {\n          uniqueSuggestions.add(category);\n        }\n      }\n\n      searchSuggestions.value = uniqueSuggestions.take(5).toList();\n    } else {\n      searchSuggestions.clear();\n    }\n    update();\n  }\n\n  void selectSuggestion(String suggestion) {\n    searchController.text = suggestion;\n    searchQuery.value = suggestion;\n    searchSuggestions.clear();\n    _filterProducts();\n  }\n\n  // ===========================================\n  // ğŸ¯ ÙÙ„Ø§ØªØ± Ù…ØªÙ‚Ø¯Ù…Ø©\n  // ===========================================\n\n  /// ØªØ¨Ø¯ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ù…ÙØ¶Ù„Ø©\n  void toggleFavoritesFilter() {\n    showFavoritesOnly.value = !showFavoritesOnly.value;\n  }\n\n  /// ØªØ¨Ø¯ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª\n  void toggleDiscountFilter() {\n    showDiscountedOnly.value = !showDiscountedOnly.value;\n  }\n\n  /// ØªØ­Ø¯ÙŠØ« Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±\n  void updatePriceRange(double min, double max) {\n    currentMinPrice.value = min;\n    currentMaxPrice.value = max;\n  }\n\n  /// ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙ‚ÙŠÙŠÙ…\n  void setMinRating(double rating) {\n    minRating.value = rating;\n  }\n\n  /// ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©\n  void filterByCategory(String category) {\n    selectedCategory.value = category;\n  }\n\n  /// ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª\n  void sortProducts(String sortType) {\n    sortBy.value = sortType;\n    _sortProducts(filteredProducts);\n  }\n\n  /// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±\n  void applyFilters() {\n    _filterProducts();\n  }\n\n  /// Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±\n  void clearAllFilters() {\n    searchController.clear();\n    selectedCategory.value = '';\n    currentMinPrice.value = minPrice.value;\n    currentMaxPrice.value = maxPrice.value;\n    sortBy.value = 'Ø§Ù„Ø£Ø­Ø¯Ø«';\n    showFavoritesOnly.value = false;\n    showDiscountedOnly.value = false;\n    minRating.value = 0.0;\n    showFilters.value = false;\n  }\n\n  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø©\n  bool hasActiveFilters() {\n    return searchController.text.isNotEmpty ||\n        selectedCategory.value.isNotEmpty ||\n        currentMinPrice.value != minPrice.value ||\n        currentMaxPrice.value != maxPrice.value ||\n        sortBy.value != 'Ø§Ù„Ø£Ø­Ø¯Ø«' ||\n        showFavoritesOnly.value ||\n        showDiscountedOnly.value ||\n        minRating.value > 0.0;\n  }\n\n  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±\n  double getAveragePrice() {\n    if (filteredProducts.isEmpty) return 0.0;\n    double total = 0.0;\n    for (var product in filteredProducts) {\n      final price =\n          double.tryParse(product['priceOfItem']?.toString() ?? '0') ?? 0.0;\n      total += price;\n    }\n    return total / filteredProducts.length;\n  }\n\n  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†\n  double getTotalInventoryValue() {\n    double total = 0.0;\n    for (var product in filteredProducts) {\n      final price =\n          double.tryParse(product['priceOfItem']?.toString() ?? '0') ?? 0.0;\n      final quantity =\n          int.tryParse(product['quantity']?.toString() ?? '1') ?? 1;\n      total += price * quantity;\n    }\n    return total;\n  }\n\n  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹\n  double getExpectedProfit() {\n    double profit = 0.0;\n    for (var product in filteredProducts) {\n      final price =\n          double.tryParse(product['priceOfItem']?.toString() ?? '0') ?? 0.0;\n      final cost =\n          double.tryParse(product['cost']?.toString() ?? '0') ?? price * 0.7;\n      final quantity =\n          int.tryParse(product['quantity']?.toString() ?? '1') ?? 1;\n      profit += (price - cost) * quantity;\n    }\n    return profit;\n  }\n\n  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…\n  double getDiscountPercentage(double originalPrice) {\n    final discountedPrice = getDiscountedPrice(originalPrice);\n    if (discountedPrice >= originalPrice) return 0.0;\n    return ((originalPrice - discountedPrice) / originalPrice) * 100;\n  }\n\n  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø©\n  List<Map<String, dynamic>> getValidCoupons() {\n    return [\n      {\n        'code': 'SAVE10',\n        'discount': 10.0,\n        'type': 'percentage',\n        'description': 'Ø®ØµÙ… 10% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',\n        'minAmount': 50.0,\n      },\n      {\n        'code': 'FLAT20',\n        'discount': 20.0,\n        'type': 'fixed',\n        'description': 'Ø®ØµÙ… 20 Ø±ÙŠØ§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',\n        'minAmount': 100.0,\n      },\n      {\n        'code': 'WELCOME15',\n        'discount': 15.0,\n        'type': 'percentage',\n        'description': 'Ø®ØµÙ… ØªØ±Ø­ÙŠØ¨ÙŠ 15%',\n        'minAmount': 75.0,\n      },\n    ];\n  }\n\n  // ===========================================\n  // ğŸ¯ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø©\n  // ===========================================\n\n  void addToCompare(Map<String, dynamic> product) {\n    if (compareProducts.length < maxCompareItems &&\n        !isInCompare(product['id'] ?? '')) {\n      compareProducts.add(product);\n      _saveCompareList(); // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©\n      update(['compare', 'compare_${product['id']}']); // ØªØ­Ø¯ÙŠØ« UI Ø§Ù„Ù…Ø®ØµØµ\n    }\n  }\n\n  void removeFromCompare(Map<String, dynamic> product) {\n    compareProducts.removeWhere((p) => p['id'] == product['id']);\n    _saveCompareList(); // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©\n    update(['compare', 'compare_${product['id']}']); // ØªØ­Ø¯ÙŠØ« UI Ø§Ù„Ù…Ø®ØµØµ\n  }\n\n  bool isInCompare(String productId) {\n    return compareProducts.any((p) => p['id'] == productId);\n  }\n\n  /// Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©\n  void clearCompare() {\n    compareProducts.clear();\n    _saveCompareList(); // Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ§Ø±ØºØ©\n    update(['compare']);\n  }\n\n  /// Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ\n  void _saveCompareList() {\n    try {\n      final List<Map<String, dynamic>> compareData =\n          compareProducts.map((product) {\n            return {\n              'id': product['id'],\n              'nameOfItem': product['nameOfItem'],\n              'priceOfItem': product['priceOfItem'],\n              'url': product['url'],\n              'manyImages': product['manyImages'],\n              'storeId': store.uid, // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØ¬Ø±\n            };\n          }).toList();\n\n      _storage.write('compare_products_${store.uid}', compareData);\n      debugPrint('âœ… ØªÙ… Ø­ÙØ¸ ${compareProducts.length} Ù…Ù†ØªØ¬ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©');\n    } catch (e) {\n      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©: $e');\n    }\n  }\n\n  /// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ\n  void _loadCompareList() {\n    try {\n      final List<dynamic>? savedCompare = _storage.read(\n        'compare_products_${store.uid}',\n      );\n      if (savedCompare != null && savedCompare.isNotEmpty) {\n        compareProducts.clear();\n        for (var item in savedCompare) {\n          if (item is Map<String, dynamic>) {\n            compareProducts.add(Map<String, dynamic>.from(item));\n          }\n        }\n        debugPrint(\n          'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${compareProducts.length} Ù…Ù†ØªØ¬ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©',\n        );\n        update(['compare']); // ØªØ­Ø¯ÙŠØ« UI\n      }\n    } catch (e) {\n      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©: $e');\n    }\n  }\n\n  void showComparisonDialog() {\n    if (compareProducts.isEmpty) {\n      Get.snackbar(\n        'ØªÙ†Ø¨ÙŠÙ‡',\n        'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©',\n        backgroundColor: Colors.orange,\n        colorText: Colors.white,\n      );\n      return;\n    }\n\n    Get.dialog(\n      AlertDialog(\n        title: Text('Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (${compareProducts.length})'),\n        content: SizedBox(\n          width: double.maxFinite,\n          height: 400,\n          child: SingleChildScrollView(\n            child: Column(\n              children:\n                  compareProducts.map((product) {\n                    final price =\n                        double.tryParse(\n                          product['priceOfItem']?.toString() ?? '0',\n                        ) ??\n                        0.0;\n                    final rating = getProductRating(product['id'] ?? '');\n                    return Card(\n                      margin: EdgeInsets.symmetric(vertical: 8),\n                      child: ListTile(\n                        title: Text(product['nameOfItem'] ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),\n                        subtitle: Column(\n                          crossAxisAlignment: CrossAxisAlignment.start,\n                          children: [\n                            Text('Ø§Ù„Ø³Ø¹Ø±: ${price.toInt()} Ø±ÙŠØ§Ù„'),\n                            Text('Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${rating.toStringAsFixed(1)} â­'),\n                          ],\n                        ),\n                        trailing: IconButton(\n                          icon: Icon(Icons.remove_circle, color: Colors.red),\n                          onPressed: () => removeFromCompare(product),\n                        ),\n                      ),\n                    );\n                  }).toList(),\n            ),\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () => clearCompare(),\n            child: Text('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„', style: TextStyle(color: Colors.red)),\n          ),\n          TextButton(onPressed: () => Get.back(), child: Text('Ø¥ØºÙ„Ø§Ù‚')),\n        ],\n      ),\n    );\n  }\n\n  // ===========================================\n  // ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª\n  // ===========================================\n\n  final RxString appliedCoupon = ''.obs;\n  final RxDouble couponDiscount = 0.0.obs;\n  final RxDouble quickRatingValue = 3.0.obs;\n\n  void applyCoupon(String couponCode) {\n    Map<String, double> validCoupons = {\n      'welcome10': 0.10,\n      'save20': 0.20,\n      'summer15': 0.15,\n      'newuser': 0.25,\n      'loyal5': 0.05,\n    };\n\n    String code = couponCode.toLowerCase().trim();\n    if (validCoupons.containsKey(code)) {\n      appliedCoupon.value = couponCode.toUpperCase();\n      couponDiscount.value = validCoupons[code]!;\n    }\n    update(['coupon']);\n  }\n\n  void removeCoupon() {\n    appliedCoupon.value = '';\n    couponDiscount.value = 0.0;\n    update(['coupon']);\n  }\n\n  void setQuickRatingValue(double value) => quickRatingValue.value = value;\n\n  double getDiscountedPrice(double originalPrice) {\n    if (couponDiscount.value > 0) {\n      return originalPrice * (1 - couponDiscount.value);\n    }\n    return originalPrice;\n  }\n\n  // ===========================================\n  // ğŸ¯ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª\n  // ===========================================\n\n  Map<String, int> get categoryStats {\n    Map<String, int> stats = {};\n    for (var product in allProducts) {\n      String category = product['selectedMainCategoryNameAr'] ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';\n      stats[category] = (stats[category] ?? 0) + 1;\n    }\n    return stats;\n  }\n\n  String get mostPopularCategory {\n    var stats = categoryStats;\n    if (stats.isEmpty) return 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª';\n    return stats.entries.reduce((a, b) => a.value > b.value ? a : b).key;\n  }\n\n  double get averagePrice {\n    if (allProducts.isEmpty) return 0.0;\n    double total = allProducts.fold(0.0, (sum, product) {\n      return sum +\n          (double.tryParse(product['priceOfItem']?.toString() ?? '0') ?? 0.0);\n    });\n    return total / allProducts.length;\n  }\n\n  /// Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†\n  double get totalInventoryValue {\n    return allProducts.fold(0.0, (sum, product) {\n      final price =\n          double.tryParse(product['priceOfItem']?.toString() ?? '0') ?? 0.0;\n      return sum + price;\n    });\n  }\n\n  /// Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†\n  double get totalInventoryCost {\n    return allProducts.fold(0.0, (sum, product) {\n      final cost =\n          double.tryParse(product['costPrice']?.toString() ?? '0') ?? 0.0;\n      return sum + cost;\n    });\n  }\n\n  /// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹\n  double get expectedProfit {\n    return totalInventoryValue - totalInventoryCost;\n  }\n\n  /// Ø­Ø³Ø§Ø¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­\n  double get profitMargin {\n    return totalInventoryValue > 0\n        ? (expectedProfit / totalInventoryValue) * 100\n        : 0.0;\n  }\n\n  /// Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù†ØªØ¬\n  void shareProduct(Map<String, dynamic> product) {\n    String productName = product['nameOfItem'] ?? 'Ù…Ù†ØªØ¬ Ø±Ø§Ø¦Ø¹';\n    String price = product['priceOfItem']?.toString() ?? '0';\n    String storeName = store.shopName;\n\n    String shareText =\n        '''\nğŸ›ï¸ Ù…Ù†ØªØ¬ Ø±Ø§Ø¦Ø¹ Ù…Ù† $storeName\n\nğŸ“¦ $productName\nğŸ’° $price Ø¬Ù†ÙŠÙ‡\nâ­ ${getProductRating(product['id'] ?? '').toStringAsFixed(1)} Ù…Ù† 5\nğŸ‘¥ ${getReviewsCount(product['id'] ?? '')} ØªÙ‚ÙŠÙŠÙ…\n\n#Ù…Ù†ØªØ¬Ø§Øª_Ø¹Ø§Ù„ÙŠØ©_Ø§Ù„Ø¬ÙˆØ¯Ø© #ØªØ³ÙˆÙ‚_Ø¢Ù…Ù† #$storeName\n    '''.trim();\n\n    Get.bottomSheet(\n      Container(\n        padding: EdgeInsets.all(20),\n        decoration: BoxDecoration(\n          color: Colors.white,\n          borderRadius: BorderRadius.vertical(top: Radius.circular(20)),\n        ),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            Text(\n              'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n            ),\n            SizedBox(height: 15),\n            Container(\n              padding: EdgeInsets.all(15),\n              decoration: BoxDecoration(\n                color: Colors.grey[100],\n                borderRadius: BorderRadius.circular(10),\n              ),\n              child: Text(shareText, style: TextStyle(fontSize: 14)),\n            ),\n            SizedBox(height: 20),\n            Row(\n              mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n              children: [\n                _buildShareButton('ÙˆØ§ØªØ³Ø§Ø¨', Icons.message, Colors.green),\n                _buildShareButton('ÙÙŠØ³Ø¨ÙˆÙƒ', Icons.facebook, Colors.blue),\n                _buildShareButton(\n                  'ØªÙˆÙŠØªØ±',\n                  Icons.alternate_email,\n                  Colors.lightBlue,\n                ),\n                _buildShareButton('Ù†Ø³Ø®', Icons.copy, Colors.grey),\n              ],\n            ),\n          ],\n        ),\n      ),\n      backgroundColor: Colors.transparent,\n    );\n  }\n\n  Widget _buildShareButton(String name, IconData icon, Color color) {\n    return GestureDetector(\n      onTap: () {\n        Get.back();\n        Get.snackbar(\n          'ØªÙ… Ø§Ù„Ù†Ø³Ø®',\n          'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ $name',\n          backgroundColor: color.withOpacity(0.9),\n          colorText: Colors.white,\n        );\n      },\n      child: Column(\n        children: [\n          Container(\n            padding: EdgeInsets.all(12),\n            decoration: BoxDecoration(\n              color: color.withOpacity(0.1),\n              borderRadius: BorderRadius.circular(12),\n            ),\n            child: Icon(icon, color: color, size: 24),\n          ),\n          SizedBox(height: 5),\n          Text(name, style: TextStyle(fontSize: 12)),\n        ],\n      ),\n    );\n  }\n\n  /// Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø©\n  void goToCart() {\n    Get.toNamed('/retail-cart');\n  }\n\n  /// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©\n  void toggleView() {\n    isGridView.value = !isGridView.value;\n  }\n\n  // New methods for product view and filters\n  void changeViewType(ProductViewType type) {\n    productViewType.value = type;\n  }\n\n  void requestStockNotification(Map<String, dynamic> product) {\n    Get.snackbar(\n      'Ø·Ù„Ø¨ Ø¥Ø´Ø¹Ø§Ø± ØªÙˆÙØ±',\n      'Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø¹Ù†Ø¯ ØªÙˆÙØ± ${product['nameOfItem']}',\n      snackPosition: SnackPosition.BOTTOM,\n      backgroundColor: Colors.blueAccent,\n      colorText: Colors.white,\n    );\n  }\n\n  void setCountry(String country) {\n    selectedCountry.value = country;\n    _filterProducts();\n  }\n\n  void setQuality(String quality) {\n    selectedQuality.value = quality;\n    _filterProducts();\n  }\n\n  void toggleOnOffer() {\n    filterOnOffer.value = !filterOnOffer.value;\n    _filterProducts();\n  }\n}\n"
        }
    ]
}