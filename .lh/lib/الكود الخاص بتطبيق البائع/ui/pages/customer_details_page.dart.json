{
    "sourceFile": "lib/الكود الخاص بتطبيق البائع/ui/pages/customer_details_page.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752704601212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752704601212,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\nimport 'package:flutter_screenutil/flutter_screenutil.dart';\nimport 'package:get/get.dart';\nimport 'package:intl/intl.dart';\nimport '../../controllers/sales_analytics_controller.dart';\nimport '../../../Model/sales_analytics_model.dart';\n\n/// صفحة تفاصيل العميل مع سجل المشتريات\nclass CustomerDetailsPage extends StatelessWidget {\n  final String customerId;\n  final String customerName;\n  \n  const CustomerDetailsPage({\n    super.key,\n    required this.customerId,\n    required this.customerName,\n  });\n\n  @override\n  Widget build(BuildContext context) {\n    final SalesAnalyticsController salesController = Get.find<SalesAnalyticsController>();\n    final customerSales = salesController.getSalesByBuyer(customerId);\n    \n    // حساب إحصائيات العميل\n    final totalOrders = customerSales.length;\n    final totalSpent = customerSales.fold(0.0, (sum, sale) => sum + sale.totalAmount);\n    final totalProfit = customerSales.fold(0.0, (sum, sale) => sum + sale.sellerProfit);\n    final averageOrder = totalOrders > 0 ? totalSpent / totalOrders : 0.0;\n    final completedOrders = customerSales.where((sale) => sale.isDelivered).length;\n    final completionRate = totalOrders > 0 ? (completedOrders / totalOrders) * 100 : 0.0;\n\n    return Scaffold(\n      backgroundColor: const Color(0xFFF8F9FA),\n      appBar: AppBar(\n        title: Text(\n          'تفاصيل العميل',\n          style: TextStyle(\n            fontWeight: FontWeight.bold,\n            color: Colors.white,\n            fontSize: 18.sp,\n          ),\n        ),\n        backgroundColor: const Color(0xFF2E7D32),\n        elevation: 0,\n        leading: IconButton(\n          icon: const Icon(Icons.arrow_back, color: Colors.white),\n          onPressed: () => Get.back(),\n        ),\n      ),\n      body: SingleChildScrollView(\n        child: Column(\n          children: [\n            // معلومات العميل الأساسية\n            _buildCustomerHeader(customerName, customerSales.isNotEmpty ? customerSales.first : null),\n            \n            // إحصائيات العميل\n            _buildCustomerStats(totalOrders, totalSpent, totalProfit, averageOrder, completionRate),\n            \n            // سجل المشتريات\n            _buildPurchaseHistory(customerSales),\n          ],\n        ),\n      ),\n    );\n  }\n\n  /// بناء رأس معلومات العميل\n  Widget _buildCustomerHeader(String customerName, SalesAnalyticsModel? latestSale) {\n    return Container(\n      width: double.infinity,\n      decoration: const BoxDecoration(\n        gradient: LinearGradient(\n          colors: [Color(0xFF2E7D32), Color(0xFF4CAF50)],\n          begin: Alignment.topCenter,\n          end: Alignment.bottomCenter,\n        ),\n      ),\n      child: Padding(\n        padding: EdgeInsets.all(24.w),\n        child: Column(\n          children: [\n            // صورة العميل\n            CircleAvatar(\n              radius: 50.r,\n              backgroundImage: latestSale?.buyerImageUrl != null\n                  ? NetworkImage(latestSale!.buyerImageUrl!)\n                  : null,\n              backgroundColor: Colors.white.withOpacity(0.2),\n              child: latestSale?.buyerImageUrl == null\n                  ? Icon(\n                      Icons.person,\n                      size: 50.sp,\n                      color: Colors.white,\n                    )\n                  : null,\n            ),\n            SizedBox(height: 16.h),\n            \n            // اسم العميل\n            Text(\n              customerName,\n              style: TextStyle(\n                fontSize: 24.sp,\n                fontWeight: FontWeight.bold,\n                color: Colors.white,\n              ),\n              textAlign: TextAlign.center,\n            ),\n            SizedBox(height: 8.h),\n            \n            // رقم الهاتف إذا متوفر\n            if (latestSale?.buyerPhoneNumber != null)\n              Row(\n                mainAxisAlignment: MainAxisAlignment.center,\n                children: [\n                  Icon(\n                    Icons.phone,\n                    color: Colors.white.withOpacity(0.9),\n                    size: 16.sp,\n                  ),\n                  SizedBox(width: 4.w),\n                  Text(\n                    latestSale!.buyerPhoneNumber!,\n                    style: TextStyle(\n                      fontSize: 16.sp,\n                      color: Colors.white.withOpacity(0.9),\n                    ),\n                  ),\n                ],\n              ),\n            \n            SizedBox(height: 8.h),\n            \n            // تاريخ آخر طلب\n            if (latestSale != null)\n              Text(\n                'آخر طلب: ${DateFormat('dd/MM/yyyy').format(latestSale.orderDate)}',\n                style: TextStyle(\n                  fontSize: 14.sp,\n                  color: Colors.white.withOpacity(0.8),\n                ),\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  /// بناء إحصائيات العميل\n  Widget _buildCustomerStats(\n    int totalOrders,\n    double totalSpent,\n    double totalProfit,\n    double averageOrder,\n    double completionRate,\n  ) {\n    return Container(\n      margin: EdgeInsets.all(16.w),\n      child: Card(\n        elevation: 8,\n        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16.r)),\n        child: Padding(\n          padding: EdgeInsets.all(20.w),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              Text(\n                'إحصائيات العميل',\n                style: TextStyle(\n                  fontSize: 18.sp,\n                  fontWeight: FontWeight.bold,\n                  color: const Color(0xFF2E7D32),\n                ),\n              ),\n              SizedBox(height: 16.h),\n              \n              // الصف الأول من الإحصائيات\n              Row(\n                children: [\n                  Expanded(\n                    child: _buildStatCard(\n                      'إجمالي الطلبات',\n                      totalOrders.toString(),\n                      Icons.shopping_cart,\n                      const Color(0xFF1976D2),\n                    ),\n                  ),\n                  SizedBox(width: 12.w),\n                  Expanded(\n                    child: _buildStatCard(\n                      'إجمالي المبلغ',\n                      '${NumberFormat('#,###').format(totalSpent)} د.ع',\n                      Icons.attach_money,\n                      const Color(0xFF388E3C),\n                    ),\n                  ),\n                ],\n              ),\n              SizedBox(height: 12.h),\n              \n              // الصف الثاني من الإحصائيات\n              Row(\n                children: [\n                  Expanded(\n                    child: _buildStatCard(\n                      'متوسط الطلب',\n                      '${NumberFormat('#,###').format(averageOrder)} د.ع',\n                      Icons.calculate,\n                      const Color(0xFF7B1FA2),\n                    ),\n                  ),\n                  SizedBox(width: 12.w),\n                  Expanded(\n                    child: _buildStatCard(\n                      'نسبة الإكمال',\n                      '${completionRate.toStringAsFixed(1)}%',\n                      Icons.check_circle,\n                      const Color(0xFFFF9800),\n                    ),\n                  ),\n                ],\n              ),\n              SizedBox(height: 12.h),\n              \n              // بطاقة الأرباح\n              Container(\n                width: double.infinity,\n                padding: EdgeInsets.all(16.w),\n                decoration: BoxDecoration(\n                  gradient: const LinearGradient(\n                    colors: [Color(0xFF4CAF50), Color(0xFF8BC34A)],\n                    begin: Alignment.topLeft,\n                    end: Alignment.bottomRight,\n                  ),\n                  borderRadius: BorderRadius.circular(12.r),\n                ),\n                child: Column(\n                  children: [\n                    Icon(\n                      Icons.trending_up,\n                      color: Colors.white,\n                      size: 24.sp,\n                    ),\n                    SizedBox(height: 8.h),\n                    Text(\n                      'إجمالي الأرباح من العميل',\n                      style: TextStyle(\n                        fontSize: 14.sp,\n                        color: Colors.white.withOpacity(0.9),\n                      ),\n                    ),\n                    SizedBox(height: 4.h),\n                    Text(\n                      '${NumberFormat('#,###').format(totalProfit)} د.ع',\n                      style: TextStyle(\n                        fontSize: 20.sp,\n                        fontWeight: FontWeight.bold,\n                        color: Colors.white,\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  /// بناء بطاقة إحصائية\n  Widget _buildStatCard(String title, String value, IconData icon, Color color) {\n    return Container(\n      padding: EdgeInsets.all(16.w),\n      decoration: BoxDecoration(\n        color: color.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(12.r),\n        border: Border.all(color: color.withOpacity(0.3)),\n      ),\n      child: Column(\n        children: [\n          Icon(icon, color: color, size: 24.sp),\n          SizedBox(height: 8.h),\n          Text(\n            title,\n            style: TextStyle(\n              fontSize: 12.sp,\n              color: color,\n            ),\n            textAlign: TextAlign.center,\n          ),\n          SizedBox(height: 4.h),\n          Text(\n            value,\n            style: TextStyle(\n              fontSize: 14.sp,\n              fontWeight: FontWeight.bold,\n              color: color,\n            ),\n            textAlign: TextAlign.center,\n          ),\n        ],\n      ),\n    );\n  }\n\n  /// بناء سجل المشتريات\n  Widget _buildPurchaseHistory(List<SalesAnalyticsModel> sales) {\n    return Container(\n      margin: EdgeInsets.all(16.w),\n      child: Card(\n        elevation: 8,\n        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16.r)),\n        child: Padding(\n          padding: EdgeInsets.all(20.w),\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              Row(\n                children: [\n                  Icon(\n                    Icons.history,\n                    color: const Color(0xFF2E7D32),\n                    size: 20.sp,\n                  ),\n                  SizedBox(width: 8.w),\n                  Text(\n                    'سجل المشتريات (${sales.length})',\n                    style: TextStyle(\n                      fontSize: 18.sp,\n                      fontWeight: FontWeight.bold,\n                      color: const Color(0xFF2E7D32),\n                    ),\n                  ),\n                ],\n              ),\n              SizedBox(height: 16.h),\n              \n              if (sales.isEmpty)\n                _buildEmptyPurchaseHistory()\n              else\n                ListView.separated(\n                  shrinkWrap: true,\n                  physics: const NeverScrollableScrollPhysics(),\n                  itemCount: sales.length,\n                  separatorBuilder: (context, index) => SizedBox(height: 12.h),\n                  itemBuilder: (context, index) {\n                    final sale = sales[index];\n                    return _buildPurchaseCard(sale);\n                  },\n                ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  /// بناء حالة فارغة لسجل المشتريات\n  Widget _buildEmptyPurchaseHistory() {\n    return Container(\n      width: double.infinity,\n      padding: EdgeInsets.all(40.w),\n      child: Column(\n        children: [\n          Icon(\n            Icons.shopping_basket_outlined,\n            size: 64.sp,\n            color: Colors.grey[400],\n          ),\n          SizedBox(height: 16.h),\n          Text(\n            'لا توجد مشتريات',\n            style: TextStyle(\n              fontSize: 16.sp,\n              color: Colors.grey[600],\n              fontWeight: FontWeight.w500,\n            ),\n          ),\n          SizedBox(height: 8.h),\n          Text(\n            'لم يقم العميل بأي عملية شراء بعد',\n            style: TextStyle(\n              fontSize: 14.sp,\n              color: Colors.grey[500],\n            ),\n            textAlign: TextAlign.center,\n          ),\n        ],\n      ),\n    );\n  }\n\n  /// بناء بطاقة مشترى واحدة\n  Widget _buildPurchaseCard(SalesAnalyticsModel sale) {\n    return Container(\n      padding: EdgeInsets.all(16.w),\n      decoration: BoxDecoration(\n        color: Colors.grey[50],\n        borderRadius: BorderRadius.circular(12.r),\n        border: Border.all(color: Colors.grey[200]!),\n      ),\n      child: Column(\n        crossAxisAlignment: CrossAxisAlignment.start,\n        children: [\n          // رأس البطاقة\n          Row(\n            children: [\n              Container(\n                padding: EdgeInsets.symmetric(horizontal: 8.w, vertical: 4.h),\n                decoration: BoxDecoration(\n                  color: const Color(0xFF2E7D32),\n                  borderRadius: BorderRadius.circular(6.r),\n                ),\n                child: Text(\n                  'طلب #${sale.orderId.substring(0, 8)}',\n                  style: TextStyle(\n                    fontSize: 12.sp,\n                    color: Colors.white,\n                    fontWeight: FontWeight.bold,\n                  ),\n                ),\n              ),\n              const Spacer(),\n              Text(\n                DateFormat('dd/MM/yyyy').format(sale.orderDate),\n                style: TextStyle(\n                  fontSize: 12.sp,\n                  color: Colors.grey[600],\n                ),\n              ),\n            ],\n          ),\n          SizedBox(height: 12.h),\n          \n          // تفاصيل الطلب\n          Row(\n            children: [\n              Expanded(\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    Text(\n                      'المبلغ الإجمالي',\n                      style: TextStyle(\n                        fontSize: 12.sp,\n                        color: Colors.grey[600],\n                      ),\n                    ),\n                    Text(\n                      '${NumberFormat('#,###').format(sale.totalAmount)} د.ع',\n                      style: TextStyle(\n                        fontSize: 16.sp,\n                        fontWeight: FontWeight.bold,\n                        color: const Color(0xFF1976D2),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n              SizedBox(width: 16.w),\n              Expanded(\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    Text(\n                      'الربح',\n                      style: TextStyle(\n                        fontSize: 12.sp,\n                        color: Colors.grey[600],\n                      ),\n                    ),\n                    Text(\n                      '${NumberFormat('#,###').format(sale.sellerProfit)} د.ع',\n                      style: TextStyle(\n                        fontSize: 16.sp,\n                        fontWeight: FontWeight.bold,\n                        color: const Color(0xFF388E3C),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ],\n          ),\n          SizedBox(height: 12.h),\n          \n          // معلومات إضافية\n          Row(\n            children: [\n              _buildInfoChip(\n                '${sale.items.length} منتج',\n                Icons.inventory_2,\n                const Color(0xFF7B1FA2),\n              ),\n              SizedBox(width: 8.w),\n              _buildDeliveryStatusChip(sale.deliveryStatus),\n              if (sale.driverName != null) ...[\n                SizedBox(width: 8.w),\n                _buildInfoChip(\n                  sale.driverName!,\n                  Icons.delivery_dining,\n                  const Color(0xFFFF9800),\n                ),\n              ],\n            ],\n          ),\n          \n          // عرض المنتجات\n          if (sale.items.isNotEmpty) ...[\n            SizedBox(height: 12.h),\n            Text(\n              'المنتجات:',\n              style: TextStyle(\n                fontSize: 14.sp,\n                fontWeight: FontWeight.w500,\n                color: Colors.grey[700],\n              ),\n            ),\n            SizedBox(height: 8.h),\n            ...sale.items.take(3).map((item) => Padding(\n              padding: EdgeInsets.only(bottom: 4.h),\n              child: Text(\n                '• ${item.itemName} (${item.quantity})',\n                style: TextStyle(\n                  fontSize: 12.sp,\n                  color: Colors.grey[600],\n                ),\n              ),\n            )),\n            if (sale.items.length > 3)\n              Text(\n                '... و ${sale.items.length - 3} منتجات أخرى',\n                style: TextStyle(\n                  fontSize: 12.sp,\n                  color: Colors.grey[500],\n                  fontStyle: FontStyle.italic,\n                ),\n              ),\n          ],\n        ],\n      ),\n    );\n  }\n\n  /// بناء شريحة معلومات\n  Widget _buildInfoChip(String text, IconData icon, Color color) {\n    return Container(\n      padding: EdgeInsets.symmetric(horizontal: 8.w, vertical: 4.h),\n      decoration: BoxDecoration(\n        color: color.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(6.r),\n      ),\n      child: Row(\n        mainAxisSize: MainAxisSize.min,\n        children: [\n          Icon(icon, color: color, size: 12.sp),\n          SizedBox(width: 4.w),\n          Text(\n            text,\n            style: TextStyle(\n              fontSize: 10.sp,\n              color: color,\n              fontWeight: FontWeight.w500,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  /// بناء شريحة حالة التوصيل\n  Widget _buildDeliveryStatusChip(String status) {\n    Color color;\n    String statusText;\n    IconData icon;\n\n    switch (status) {\n      case 'delivered':\n        color = const Color(0xFF388E3C);\n        statusText = 'تم التوصيل';\n        icon = Icons.check_circle;\n        break;\n      case 'pending':\n      case 'company_pickup_request':\n        color = const Color(0xFFFF9800);\n        statusText = 'في الانتظار';\n        icon = Icons.hourglass_empty;\n        break;\n      default:\n        color = const Color(0xFF1976D2);\n        statusText = 'قيد التوصيل';\n        icon = Icons.local_shipping;\n        break;\n    }\n\n    return Container(\n      padding: EdgeInsets.symmetric(horizontal: 8.w, vertical: 4.h),\n      decoration: BoxDecoration(\n        color: color.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(6.r),\n      ),\n      child: Row(\n        mainAxisSize: MainAxisSize.min,\n        children: [\n          Icon(icon, color: color, size: 12.sp),\n          SizedBox(width: 4.w),\n          Text(\n            statusText,\n            style: TextStyle(\n              fontSize: 10.sp,\n              color: color,\n              fontWeight: FontWeight.w500,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n"
        }
    ]
}