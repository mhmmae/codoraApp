{
    "sourceFile": "lib/الكود الخاص بتطبيق البائع/ui/pages/top_customers_page.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1752704601226,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1752704601226,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\nimport 'package:flutter_screenutil/flutter_screenutil.dart';\nimport 'package:get/get.dart';\nimport 'package:intl/intl.dart';\nimport '../../controllers/sales_analytics_controller.dart';\nimport '../../../Model/sales_analytics_model.dart';\nimport 'customer_details_page.dart';\n\n/// صفحة أفضل العملاء\nclass TopCustomersPage extends StatelessWidget {\n  const TopCustomersPage({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    final SalesAnalyticsController salesController = Get.find<SalesAnalyticsController>();\n    \n    return Scaffold(\n      backgroundColor: const Color(0xFFF8F9FA),\n      appBar: AppBar(\n        title: const Text(\n          'أفضل العملاء',\n          style: TextStyle(\n            fontWeight: FontWeight.bold,\n            color: Colors.white,\n          ),\n        ),\n        backgroundColor: const Color(0xFF2E7D32),\n        elevation: 0,\n        leading: IconButton(\n          icon: const Icon(Icons.arrow_back, color: Colors.white),\n          onPressed: () => Get.back(),\n        ),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.refresh, color: Colors.white),\n            onPressed: () => salesController.refreshSalesData(),\n          ),\n        ],\n      ),\n      body: Obx(() {\n        if (salesController.isLoading.value) {\n          return const Center(\n            child: CircularProgressIndicator(\n              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF2E7D32)),\n            ),\n          );\n        }\n\n        final topCustomers = _getTopCustomers(salesController.currentSales);\n\n        if (topCustomers.isEmpty) {\n          return _buildEmptyState();\n        }\n\n        return SingleChildScrollView(\n          child: Padding(\n            padding: EdgeInsets.all(16.w),\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                // ملخص العملاء\n                _buildCustomersSummaryCard(topCustomers),\n                SizedBox(height: 20.h),\n                \n                // قائمة أفضل العملاء\n                _buildTopCustomersList(topCustomers),\n              ],\n            ),\n          ),\n        );\n      }),\n    );\n  }\n\n  /// الحصول على أفضل العملاء\n  List<CustomerSummary> _getTopCustomers(List<SalesAnalyticsModel> sales) {\n    Map<String, CustomerSummary> customerMap = {};\n\n    for (final sale in sales) {\n      if (customerMap.containsKey(sale.buyerId)) {\n        final customer = customerMap[sale.buyerId]!;\n        customerMap[sale.buyerId] = CustomerSummary(\n          customerId: customer.customerId,\n          customerName: customer.customerName,\n          customerPhone: customer.customerPhone,\n          customerImageUrl: customer.customerImageUrl,\n          totalOrders: customer.totalOrders + 1,\n          totalSpent: customer.totalSpent + sale.totalAmount,\n          totalProfit: customer.totalProfit + sale.sellerProfit,\n          lastOrderDate: sale.orderDate.isAfter(customer.lastOrderDate) ? sale.orderDate : customer.lastOrderDate,\n          completedOrders: customer.completedOrders + (sale.isDelivered ? 1 : 0),\n        );\n      } else {\n        customerMap[sale.buyerId] = CustomerSummary(\n          customerId: sale.buyerId,\n          customerName: sale.buyerName,\n          customerPhone: sale.buyerPhoneNumber,\n          customerImageUrl: sale.buyerImageUrl,\n          totalOrders: 1,\n          totalSpent: sale.totalAmount,\n          totalProfit: sale.sellerProfit,\n          lastOrderDate: sale.orderDate,\n          completedOrders: sale.isDelivered ? 1 : 0,\n        );\n      }\n    }\n\n    final customers = customerMap.values.toList();\n    customers.sort((a, b) => b.totalSpent.compareTo(a.totalSpent));\n    return customers;\n  }\n\n  /// بناء بطاقة ملخص العملاء\n  Widget _buildCustomersSummaryCard(List<CustomerSummary> customers) {\n    final totalCustomers = customers.length;\n    final totalRevenue = customers.fold(0.0, (sum, customer) => sum + customer.totalSpent);\n    final totalProfit = customers.fold(0.0, (sum, customer) => sum + customer.totalProfit);\n    final averageOrderValue = customers.isNotEmpty \n        ? customers.fold(0.0, (sum, customer) => sum + customer.averageOrderValue) / customers.length\n        : 0.0;\n\n    return Card(\n      elevation: 8,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16.r)),\n      child: Container(\n        padding: EdgeInsets.all(20.w),\n        decoration: BoxDecoration(\n          borderRadius: BorderRadius.circular(16.r),\n          gradient: const LinearGradient(\n            colors: [Color(0xFF2E7D32), Color(0xFF4CAF50)],\n            begin: Alignment.topLeft,\n            end: Alignment.bottomRight,\n          ),\n        ),\n        child: Column(\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            Row(\n              children: [\n                Icon(\n                  Icons.stars,\n                  color: Colors.white,\n                  size: 24.sp,\n                ),\n                SizedBox(width: 8.w),\n                Text(\n                  'ملخص أفضل العملاء',\n                  style: TextStyle(\n                    fontSize: 18.sp,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.white,\n                  ),\n                ),\n              ],\n            ),\n            SizedBox(height: 20.h),\n            Row(\n              children: [\n                Expanded(\n                  child: _buildSummaryItem(\n                    'إجمالي العملاء',\n                    totalCustomers.toString(),\n                    Icons.people,\n                  ),\n                ),\n                SizedBox(width: 16.w),\n                Expanded(\n                  child: _buildSummaryItem(\n                    'إجمالي المبيعات',\n                    '${NumberFormat('#,###').format(totalRevenue)} د.ع',\n                    Icons.attach_money,\n                  ),\n                ),\n              ],\n            ),\n            SizedBox(height: 16.h),\n            Row(\n              children: [\n                Expanded(\n                  child: _buildSummaryItem(\n                    'إجمالي الأرباح',\n                    '${NumberFormat('#,###').format(totalProfit)} د.ع',\n                    Icons.trending_up,\n                  ),\n                ),\n                SizedBox(width: 16.w),\n                Expanded(\n                  child: _buildSummaryItem(\n                    'متوسط قيمة الطلب',\n                    '${NumberFormat('#,###').format(averageOrderValue)} د.ع',\n                    Icons.calculate,\n                  ),\n                ),\n              ],\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  /// بناء عنصر الملخص\n  Widget _buildSummaryItem(String title, String value, IconData icon) {\n    return Container(\n      padding: EdgeInsets.all(12.w),\n      decoration: BoxDecoration(\n        color: Colors.white.withOpacity(0.2),\n        borderRadius: BorderRadius.circular(12.r),\n      ),\n      child: Column(\n        crossAxisAlignment: CrossAxisAlignment.start,\n        children: [\n          Row(\n            children: [\n              Icon(icon, color: Colors.white, size: 16.sp),\n              SizedBox(width: 4.w),\n              Expanded(\n                child: Text(\n                  title,\n                  style: TextStyle(\n                    fontSize: 12.sp,\n                    color: Colors.white.withOpacity(0.9),\n                  ),\n                  maxLines: 1,\n                  overflow: TextOverflow.ellipsis,\n                ),\n              ),\n            ],\n          ),\n          SizedBox(height: 4.h),\n          Text(\n            value,\n            style: TextStyle(\n              fontSize: 14.sp,\n              fontWeight: FontWeight.bold,\n              color: Colors.white,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n\n  /// بناء قائمة أفضل العملاء\n  Widget _buildTopCustomersList(List<CustomerSummary> customers) {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.start,\n      children: [\n        Text(\n          'أفضل العملاء (${customers.length})',\n          style: TextStyle(\n            fontSize: 18.sp,\n            fontWeight: FontWeight.bold,\n            color: const Color(0xFF2E7D32),\n          ),\n        ),\n        SizedBox(height: 12.h),\n        ListView.separated(\n          shrinkWrap: true,\n          physics: const NeverScrollableScrollPhysics(),\n          itemCount: customers.length,\n          separatorBuilder: (context, index) => SizedBox(height: 12.h),\n          itemBuilder: (context, index) {\n            final customer = customers[index];\n            return _buildCustomerCard(customer, index + 1);\n          },\n        ),\n      ],\n    );\n  }\n\n  /// بناء بطاقة عميل\n  Widget _buildCustomerCard(CustomerSummary customer, int rank) {\n    return Card(\n      elevation: 4,\n      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12.r)),\n      child: InkWell(\n        onTap: () {\n          Get.to(() => CustomerDetailsPage(\n            customerId: customer.customerId,\n            customerName: customer.customerName,\n          ));\n        },\n        borderRadius: BorderRadius.circular(12.r),\n        child: Container(\n          padding: EdgeInsets.all(16.w),\n          child: Column(\n            children: [\n              // رأس البطاقة\n              Row(\n                children: [\n                  // ترتيب العميل\n                  _buildRankBadge(rank),\n                  SizedBox(width: 12.w),\n                  \n                  // صورة العميل\n                  CircleAvatar(\n                    radius: 30.r,\n                    backgroundImage: customer.customerImageUrl != null\n                        ? NetworkImage(customer.customerImageUrl!)\n                        : null,\n                    backgroundColor: const Color(0xFF2E7D32),\n                    child: customer.customerImageUrl == null\n                        ? Icon(Icons.person, color: Colors.white, size: 30.sp)\n                        : null,\n                  ),\n                  SizedBox(width: 12.w),\n                  \n                  // معلومات العميل\n                  Expanded(\n                    child: Column(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      children: [\n                        Text(\n                          customer.customerName,\n                          style: TextStyle(\n                            fontSize: 16.sp,\n                            fontWeight: FontWeight.bold,\n                            color: const Color(0xFF2E7D32),\n                          ),\n                        ),\n                        if (customer.customerPhone != null)\n                          Text(\n                            customer.customerPhone!,\n                            style: TextStyle(\n                              fontSize: 12.sp,\n                              color: Colors.grey[600],\n                            ),\n                          ),\n                        Text(\n                          'آخر طلب: ${DateFormat('dd/MM/yyyy').format(customer.lastOrderDate)}',\n                          style: TextStyle(\n                            fontSize: 10.sp,\n                            color: Colors.grey[500],\n                          ),\n                        ),\n                      ],\n                    ),\n                  ),\n                  \n                  // أيقونة الانتقال\n                  Icon(\n                    Icons.arrow_forward_ios,\n                    color: Colors.grey[400],\n                    size: 16.sp,\n                  ),\n                ],\n              ),\n              SizedBox(height: 16.h),\n              \n              // إحصائيات العميل\n              Row(\n                children: [\n                  Expanded(\n                    child: _buildStatChip(\n                      'الطلبات',\n                      customer.totalOrders.toString(),\n                      Icons.shopping_cart,\n                      const Color(0xFF1976D2),\n                    ),\n                  ),\n                  SizedBox(width: 8.w),\n                  Expanded(\n                    child: _buildStatChip(\n                      'المبلغ الإجمالي',\n                      '${NumberFormat('#,###').format(customer.totalSpent)} د.ع',\n                      Icons.attach_money,\n                      const Color(0xFF388E3C),\n                    ),\n                  ),\n                ],\n              ),\n              SizedBox(height: 8.h),\n              Row(\n                children: [\n                  Expanded(\n                    child: _buildStatChip(\n                      'الأرباح',\n                      '${NumberFormat('#,###').format(customer.totalProfit)} د.ع',\n                      Icons.trending_up,\n                      const Color(0xFF7B1FA2),\n                    ),\n                  ),\n                  SizedBox(width: 8.w),\n                  Expanded(\n                    child: _buildStatChip(\n                      'متوسط الطلب',\n                      '${NumberFormat('#,###').format(customer.averageOrderValue)} د.ع',\n                      Icons.calculate,\n                      const Color(0xFFFF9800),\n                    ),\n                  ),\n                ],\n              ),\n              SizedBox(height: 8.h),\n              \n              // نسبة الإكمال\n              Container(\n                width: double.infinity,\n                padding: EdgeInsets.all(8.w),\n                decoration: BoxDecoration(\n                  color: customer.completionRate >= 80 \n                      ? Colors.green[50] \n                      : customer.completionRate >= 60 \n                          ? Colors.orange[50]\n                          : Colors.red[50],\n                  borderRadius: BorderRadius.circular(8.r),\n                ),\n                child: Row(\n                  mainAxisAlignment: MainAxisAlignment.center,\n                  children: [\n                    Icon(\n                      customer.completionRate >= 80 \n                          ? Icons.check_circle \n                          : customer.completionRate >= 60 \n                              ? Icons.warning\n                              : Icons.error,\n                      color: customer.completionRate >= 80 \n                          ? Colors.green \n                          : customer.completionRate >= 60 \n                              ? Colors.orange\n                              : Colors.red,\n                      size: 16.sp,\n                    ),\n                    SizedBox(width: 4.w),\n                    Text(\n                      'نسبة الإكمال: ${customer.completionRate.toStringAsFixed(1)}%',\n                      style: TextStyle(\n                        fontSize: 12.sp,\n                        fontWeight: FontWeight.w500,\n                        color: customer.completionRate >= 80 \n                            ? Colors.green[800] \n                            : customer.completionRate >= 60 \n                                ? Colors.orange[800]\n                                : Colors.red[800],\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n\n  /// بناء شارة الترتيب\n  Widget _buildRankBadge(int rank) {\n    Color color;\n    IconData icon;\n\n    switch (rank) {\n      case 1:\n        color = const Color(0xFFFFD700); // ذهبي\n        icon = Icons.workspace_premium;\n        break;\n      case 2:\n        color = const Color(0xFFC0C0C0); // فضي\n        icon = Icons.workspace_premium;\n        break;\n      case 3:\n        color = const Color(0xFFCD7F32); // برونزي\n        icon = Icons.workspace_premium;\n        break;\n      default:\n        color = const Color(0xFF2E7D32);\n        icon = Icons.star;\n        break;\n    }\n\n    return Container(\n      width: 40.w,\n      height: 40.h,\n      decoration: BoxDecoration(\n        color: color,\n        shape: BoxShape.circle,\n        boxShadow: [\n          BoxShadow(\n            color: color.withOpacity(0.3),\n            blurRadius: 4,\n            offset: const Offset(0, 2),\n          ),\n        ],\n      ),\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          if (rank <= 3)\n            Icon(icon, color: Colors.white, size: 16.sp)\n          else\n            Text(\n              rank.toString(),\n              style: TextStyle(\n                fontSize: 14.sp,\n                fontWeight: FontWeight.bold,\n                color: Colors.white,\n              ),\n            ),\n        ],\n      ),\n    );\n  }\n\n  /// بناء شريحة الإحصائيات\n  Widget _buildStatChip(String title, String value, IconData icon, Color color) {\n    return Container(\n      padding: EdgeInsets.symmetric(horizontal: 8.w, vertical: 6.h),\n      decoration: BoxDecoration(\n        color: color.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(8.r),\n      ),\n      child: Column(\n        children: [\n          Row(\n            mainAxisAlignment: MainAxisAlignment.center,\n            children: [\n              Icon(icon, color: color, size: 14.sp),\n              SizedBox(width: 4.w),\n              Flexible(\n                child: Text(\n                  title,\n                  style: TextStyle(\n                    fontSize: 10.sp,\n                    color: color,\n                  ),\n                  maxLines: 1,\n                  overflow: TextOverflow.ellipsis,\n                ),\n              ),\n            ],\n          ),\n          SizedBox(height: 2.h),\n          Text(\n            value,\n            style: TextStyle(\n              fontSize: 11.sp,\n              fontWeight: FontWeight.bold,\n              color: color,\n            ),\n            textAlign: TextAlign.center,\n          ),\n        ],\n      ),\n    );\n  }\n\n  /// بناء حالة فارغة\n  Widget _buildEmptyState() {\n    return Center(\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          Icon(\n            Icons.people_outline,\n            size: 100.sp,\n            color: Colors.grey[400],\n          ),\n          SizedBox(height: 24.h),\n          Text(\n            'لا توجد بيانات عملاء',\n            style: TextStyle(\n              fontSize: 20.sp,\n              fontWeight: FontWeight.bold,\n              color: Colors.grey[600],\n            ),\n          ),\n          SizedBox(height: 8.h),\n          Text(\n            'ابدأ ببيع منتجاتك لبناء قاعدة عملاء',\n            style: TextStyle(\n              fontSize: 16.sp,\n              color: Colors.grey[500],\n            ),\n            textAlign: TextAlign.center,\n          ),\n        ],\n      ),\n    );\n  }\n}\n\n/// نموذج ملخص العميل\nclass CustomerSummary {\n  final String customerId;\n  final String customerName;\n  final String? customerPhone;\n  final String? customerImageUrl;\n  final int totalOrders;\n  final double totalSpent;\n  final double totalProfit;\n  final DateTime lastOrderDate;\n  final int completedOrders;\n\n  CustomerSummary({\n    required this.customerId,\n    required this.customerName,\n    this.customerPhone,\n    this.customerImageUrl,\n    required this.totalOrders,\n    required this.totalSpent,\n    required this.totalProfit,\n    required this.lastOrderDate,\n    required this.completedOrders,\n  });\n\n  /// حساب متوسط قيمة الطلب\n  double get averageOrderValue => totalOrders > 0 ? totalSpent / totalOrders : 0.0;\n\n  /// حساب نسبة الإكمال\n  double get completionRate => totalOrders > 0 ? (completedOrders / totalOrders) * 100 : 0.0;\n}\n"
        }
    ]
}