{
    "sourceFile": "lib/الكود الخاص بتطبيق العميل /HomePage/class/BoxAddAndRemove.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1753065306913,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1753097375572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -86,9 +86,9 @@\n     String formattedInteger = '';\n     for (int i = integerPart.length - 1; i >= 0; i--) {\n       formattedInteger = integerPart[i] + formattedInteger;\n       if ((integerPart.length - i) % 3 == 0 && i != 0) {\n-        formattedInteger = ',' + formattedInteger;\n+        formattedInteger = ',$formattedInteger';\n       }\n     }\n \n     return formattedInteger + decimalPart;\n@@ -156,9 +156,9 @@\n                 size: priceFontSize * 0.8,\n                 color: theme.primaryColor,\n               ),\n               Text(\n-                '${_formatPrice(price)}',\n+                _formatPrice(price),\n                 style: TextStyle(\n                   fontSize: priceFontSize,\n                   fontWeight: FontWeight.bold,\n                   color: theme.primaryColor,\n@@ -212,9 +212,9 @@\n     double wi,\n     double hi,\n     ThemeData theme,\n   ) {\n-    return Container(\n+    return SizedBox(\n       key: const ValueKey('add_to_cart'),\n       width: wi * 0.315, // تقليل من 0.35 إلى 0.315 (تقليل 10%)\n       height: hi * 0.0230, // تقليل من 32 إلى 29 (تقليل 10%)\n       child: ElevatedButton(\n"
                }
            ],
            "date": 1753065306913,
            "name": "Commit-0",
            "content": "import 'package:flutter/material.dart';\nimport 'package:get/get.dart';\nimport 'package:uuid/uuid.dart';\n\nimport '../../../XXX/xxx_firebase.dart';\nimport '../Get-Controllar/Get-BoxAddAndRemover.dart'; // استورد المتحكم الصحيح\n\nclass BoxAddAndRemove extends StatelessWidget {\n  final String uidItem;\n  final double price; // يجب أن يكون السعر double\n  final String\n  name; // يبدو أن الاسم لا يستخدم هنا، يمكن إزالته إذا لم يكن ضرورياً\n  final bool isOffer; // استخدام isOffer\n  final String uidAdd;\n\n  // معرف فريد لكل مثيل widget لربطه بمثيل controller خاص به\n  final String _instanceDocId = const Uuid().v4();\n\n  BoxAddAndRemove({\n    super.key,\n    required this.uidItem,\n    required this.uidAdd,\n\n    required this.price, // تأكد أنك تمرر double\n    required this.name, //\n    this.isOffer = false, // قيمة افتراضية\n  });\n\n  // دالة مساعدة لبناء أزرار التحكم\n  Widget _buildActionButton({\n    required IconData icon,\n    required VoidCallback? onPressed,\n    required BuildContext context,\n    required double iconSize,\n    required AddRemoveController controller, // استمر في استقبال المتحكم\n    required bool isAddButton,\n    bool isDisabled = false,\n  }) {\n    final theme = Theme.of(context);\n\n    // ---!!! اقرأ القيمة مباشرة هنا !!!---\n    // Obx الخارجي سيضمن إعادة البناء عند تغير isAnimating.value\n    final bool isCurrentlyAnimating =\n        isAddButton && controller.isAnimating.value;\n    final Color currentIconColor =\n        isCurrentlyAnimating\n            ? theme\n                .colorScheme\n                .secondary // استخدم لون ثانوي\n            : (isDisabled ? theme.disabledColor : theme.colorScheme.primary);\n    // ------------------------------------\n\n    // ---!!! أزل Obx من هنا !!!---\n    return AnimatedScale(\n      // --- استخدم المتغير المحسوب ---\n      scale: isCurrentlyAnimating ? 1.3 : 1.0,\n      duration: const Duration(milliseconds: 150),\n      curve: Curves.easeInOut,\n      child: InkWell(\n        onTap: isDisabled ? null : onPressed,\n        borderRadius: BorderRadius.circular(8),\n        child: Padding(\n          padding: const EdgeInsets.all(5.0),\n          // --- استخدم المتغير المحسوب ---\n          child: Icon(icon, size: iconSize, color: currentIconColor),\n        ),\n      ),\n    );\n  }\n\n  // دالة لتنسيق السعر مع فاصلة للآلاف وإزالة الأصفار غير الضرورية\n  String _formatPrice(double price) {\n    String priceString;\n    if (price == price.toInt()) {\n      priceString = price.toInt().toString();\n    } else {\n      priceString = price.toStringAsFixed(2).replaceAll(RegExp(r'\\.?0+$'), '');\n    }\n\n    // إضافة فاصلة للآلاف\n    final parts = priceString.split('.');\n    String integerPart = parts[0];\n    String decimalPart = parts.length > 1 ? '.${parts[1]}' : '';\n\n    // إضافة فاصلة كل ثلاث خانات من اليمين\n    String formattedInteger = '';\n    for (int i = integerPart.length - 1; i >= 0; i--) {\n      formattedInteger = integerPart[i] + formattedInteger;\n      if ((integerPart.length - i) % 3 == 0 && i != 0) {\n        formattedInteger = ',' + formattedInteger;\n      }\n    }\n\n    return formattedInteger + decimalPart;\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final wi = MediaQuery.of(context).size.width;\n    final hi = MediaQuery.of(context).size.height;\n    final theme = Theme.of(context);\n\n    // تحديد أحجام الخطوط والأيقونات النسبية (تقليل 10%)\n    final double priceFontSize =\n        wi / 40; // تقليل من wi/30 إلى wi/33 (تقليل 10%)\n    final double numberFontSize =\n        wi / 25; // تقليل من wi/28 إلى wi/31 (تقليل 10%)\n    final double defaultIconSize =\n        wi / 25; // تقليل من wi/18 إلى wi/20 (تقليل 10%)\n\n    // استخدم نفس AddRemoveController، واربطه باستخدام tag الفريد instanceDocId\n    final AddRemoveController controller = Get.put(\n      AddRemoveController(\n        docId: _instanceDocId, // معرف المثيل لهذا العنصر في السلة\n        uidItem: uidItem, // معرف المنتج الفعلي\n        isOffer: isOffer,\n        uidAdd: uidAdd,\n      ),\n      tag: _instanceDocId, // ربط Widget بـ Controller\n      permanent: false, // احذفه عند إزالة الـ Widget\n    );\n\n    return Column(\n      mainAxisSize: MainAxisSize.min,\n      children: [\n        // عرض السعر بالعملة مع تنسيق محسن وتصميم جميل\n        Container(\n          padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),\n          decoration: BoxDecoration(\n            gradient: LinearGradient(\n              colors: [\n                theme.primaryColor.withOpacity(0.1),\n                theme.primaryColor.withOpacity(0.05),\n              ],\n              begin: Alignment.topLeft,\n              end: Alignment.bottomRight,\n            ),\n            borderRadius: BorderRadius.circular(15),\n            border: Border.all(\n              color: theme.primaryColor.withOpacity(0.3),\n              width: 1,\n            ),\n            boxShadow: [\n              BoxShadow(\n                color: theme.primaryColor.withOpacity(0.1),\n                blurRadius: 4,\n                offset: Offset(0, 2),\n              ),\n            ],\n          ),\n          child: Row(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              Icon(\n                Icons.attach_money_rounded,\n                size: priceFontSize * 0.8,\n                color: theme.primaryColor,\n              ),\n              Text(\n                '${_formatPrice(price)}',\n                style: TextStyle(\n                  fontSize: priceFontSize,\n                  fontWeight: FontWeight.bold,\n                  color: theme.primaryColor,\n                  letterSpacing: 0.5,\n                ),\n              ),\n              SizedBox(width: 4),\n              Text(\n                FirebaseX.currency,\n                style: TextStyle(\n                  fontSize: priceFontSize * 0.75,\n                  fontWeight: FontWeight.w600,\n                  color: theme.primaryColor.withOpacity(0.8),\n                ),\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 3),\n\n        // العرض الشرطي: زر \"إضافة إلى السلة\" أو أزرار التحكم\n        Obx(() {\n          final bool hasItems = controller.number.value > 0;\n\n          return AnimatedSwitcher(\n            duration: const Duration(milliseconds: 300),\n            switchInCurve: Curves.easeInOut,\n            switchOutCurve: Curves.easeInOut,\n            child:\n                hasItems\n                    ? _buildQuantityControls(\n                      context,\n                      controller,\n                      wi,\n                      hi,\n                      theme,\n                      numberFontSize,\n                      defaultIconSize,\n                    )\n                    : _buildAddToCartButton(context, controller, wi, hi, theme),\n          );\n        }),\n      ],\n    );\n  }\n\n  // بناء زر \"إضافة إلى السلة\"\n  Widget _buildAddToCartButton(\n    BuildContext context,\n    AddRemoveController controller,\n    double wi,\n    double hi,\n    ThemeData theme,\n  ) {\n    return Container(\n      key: const ValueKey('add_to_cart'),\n      width: wi * 0.315, // تقليل من 0.35 إلى 0.315 (تقليل 10%)\n      height: hi * 0.0230, // تقليل من 32 إلى 29 (تقليل 10%)\n      child: ElevatedButton(\n        onPressed: controller.addItem,\n        style: ElevatedButton.styleFrom(\n          backgroundColor: theme.primaryColor,\n          foregroundColor: Colors.white,\n          elevation: 2,\n          shadowColor: theme.primaryColor.withOpacity(0.3),\n          shape: RoundedRectangleBorder(\n            borderRadius: BorderRadius.circular(20),\n          ),\n          padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),\n        ),\n        child: Row(\n          mainAxisAlignment: MainAxisAlignment.center,\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            Icon(\n              Icons.add_shopping_cart_rounded,\n              size: 14, // تقليل من 16 إلى 14 (تقليل 10% تقريباً)\n            ),\n            SizedBox(width: 4),\n            Text(\n              'أضف للسلة',\n              style: TextStyle(\n                fontSize: wi / 39, // تقليل من wi/35 إلى wi/39 (تقليل 10%)\n                fontWeight: FontWeight.w600,\n              ),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  // بناء أزرار التحكم بالكمية\n  Widget _buildQuantityControls(\n    BuildContext context,\n    AddRemoveController controller,\n    double wi,\n    double hi,\n    ThemeData theme,\n    double numberFontSize,\n    double defaultIconSize,\n  ) {\n    return Container(\n      key: const ValueKey('quantity_controls'),\n      padding: EdgeInsets.symmetric(horizontal: 4, vertical: 2),\n      decoration: BoxDecoration(\n        color: theme.primaryColor.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(25),\n        border: Border.all(\n          color: theme.primaryColor.withOpacity(0.3),\n          width: 1,\n        ),\n      ),\n      child: Row(\n        mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n        mainAxisSize: MainAxisSize.min,\n        children: [\n          // زر الإزالة\n          _buildActionButton(\n            icon: Icons.remove_circle_outline,\n            onPressed:\n                controller.number.value > 0 ? controller.removeItem : null,\n            isDisabled: controller.number.value <= 0,\n            context: context,\n            iconSize: defaultIconSize * 0.8,\n            controller: controller,\n            isAddButton: false,\n          ),\n\n          // الرقم الحالي\n          Container(\n            width: wi * 0.045, // تقليل من 0.35 إلى 0.315 (تقليل 10%)\n            height: hi * 0.0230, // تقليل من 32 إلى 29 (تقليل 10%)\n            margin: EdgeInsets.symmetric(horizontal: 8),\n            decoration: BoxDecoration(\n              color: theme.primaryColor,\n              borderRadius: BorderRadius.circular(12),\n            ),\n            child: Center(\n              child: Text(\n                '${controller.number.value < 0 ? 0 : controller.number.value}',\n                style: TextStyle(\n                  fontSize: numberFontSize * 0.5,\n                  fontWeight: FontWeight.bold,\n                  color: Colors.white,\n                ),\n              ),\n            ),\n          ),\n\n          // زر الإضافة\n          _buildActionButton(\n            icon: Icons.add_circle_outline,\n            onPressed: controller.addItem,\n            isDisabled: false,\n            context: context,\n            iconSize: defaultIconSize * 0.8,\n            controller: controller,\n            isAddButton: true,\n          ),\n        ],\n      ),\n    );\n  }\n}\n"
        }
    ]
}