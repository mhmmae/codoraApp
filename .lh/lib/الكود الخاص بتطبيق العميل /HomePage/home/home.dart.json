{
    "sourceFile": "lib/الكود الخاص بتطبيق العميل /HomePage/home/home.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 9,
            "patches": [
                {
                    "date": 1752859416408,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752919676740,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,20 +22,22 @@\n   @override\n   Widget build(BuildContext context) {\n     // الحصول على المتحكمات (تفترض أنه تم حقنها مسبقًا)\n     final GetSearchController searchCtrl = Get.find<GetSearchController>();\n-    \n+\n     // محاولة استخدام النظام الجديد، وفي حالة عدم وجوده، استخدم النظام المبسط\n     try {\n       Get.find<EnhancedCategoryFilterController>();\n     } catch (e) {\n       debugPrint(\"النظام الجديد غير متاح، سيتم استخدام النظام المبسط\");\n       Get.put(EnhancedCategoryFilterController());\n     }\n-    \n+\n     final BrandFilterController brandCtrl = Get.put(BrandFilterController());\n-    final BarcodeFilterController barcodeCtrl = Get.put(BarcodeFilterController());\n-    \n+    final BarcodeFilterController barcodeCtrl = Get.put(\n+      BarcodeFilterController(),\n+    );\n+\n     // إضافة متحكم للفلاتر مع حالة الإظهار/الإخفاء\n     final RxBool showFilters = false.obs;\n \n     double hi = MediaQuery.of(context).size.height;\n@@ -43,101 +45,95 @@\n \n     return Scaffold(\n       backgroundColor: theme.scaffoldBackgroundColor,\n       appBar: AppBar(\n-        title: Text(\"الصفحة الرئيسية\", style: TextStyle(color: theme.textTheme.titleLarge?.color)),\n-        backgroundColor: theme.appBarTheme.backgroundColor ?? theme.scaffoldBackgroundColor,\n+        title: Text(\n+          \"الصفحة الرئيسية\",\n+          style: TextStyle(color: theme.textTheme.titleLarge?.color),\n+        ),\n+        backgroundColor:\n+            theme.appBarTheme.backgroundColor ?? theme.scaffoldBackgroundColor,\n         elevation: theme.appBarTheme.elevation ?? 0,\n-        foregroundColor: theme.appBarTheme.foregroundColor ?? theme.colorScheme.primary,\n+        foregroundColor:\n+            theme.appBarTheme.foregroundColor ?? theme.colorScheme.primary,\n         actions: [\n           // --- أيقونة البحث ---\n           IconButton(\n             icon: Icon(Icons.search),\n             tooltip: 'بحث',\n             onPressed: () {\n-              Get.to(() => SearchScreen(), transition: Transition.downToUp );\n+              Get.to(() => SearchScreen(), transition: Transition.downToUp);\n             },\n           ),\n \n           // --- أيقونة الفلاتر الجديدة ---\n-          Obx(() => AnimatedContainer(\n-            duration: const Duration(milliseconds: 300),\n-            margin: const EdgeInsets.only(right: 8),\n-            decoration: BoxDecoration(\n-              borderRadius: BorderRadius.circular(12),\n-              color: showFilters.value \n-                  ? theme.primaryColor.withValues(alpha: 0.1)\n-                  : Colors.transparent,\n-            ),\n-            child: IconButton(\n-              icon: AnimatedRotation(\n-                duration: const Duration(milliseconds: 300),\n-                turns: showFilters.value ? 0.5 : 0,\n-                child: Icon(\n-                  Icons.tune,\n-                  color: showFilters.value \n-                      ? theme.primaryColor \n-                      : theme.appBarTheme.foregroundColor,\n+          Obx(\n+            () => AnimatedContainer(\n+              duration: const Duration(milliseconds: 300),\n+              margin: const EdgeInsets.only(right: 8),\n+              decoration: BoxDecoration(\n+                borderRadius: BorderRadius.circular(12),\n+                color:\n+                    showFilters.value\n+                        ? theme.primaryColor.withValues(alpha: 0.1)\n+                        : Colors.transparent,\n+              ),\n+              child: IconButton(\n+                icon: AnimatedRotation(\n+                  duration: const Duration(milliseconds: 300),\n+                  turns: showFilters.value ? 0.5 : 0,\n+                  child: Icon(\n+                    Icons.tune,\n+                    color:\n+                        showFilters.value\n+                            ? theme.primaryColor\n+                            : theme.appBarTheme.foregroundColor,\n+                  ),\n                 ),\n+                tooltip: 'فلاتر البحث',\n+                onPressed: () {\n+                  showFilters.value = !showFilters.value;\n+                },\n               ),\n-              tooltip: 'فلاتر البحث',\n-              onPressed: () {\n-                showFilters.value = !showFilters.value;\n-              },\n             ),\n-          )),\n+          ),\n \n-          // --- أيقونة البحث بالباركود ---\n-          Obx(() => IconButton(\n-            icon: Icon(\n-              Icons.qr_code_scanner,\n-              color: barcodeCtrl.hasActiveFilter \n-                  ? theme.colorScheme.primary \n-                  : theme.appBarTheme.foregroundColor,\n-            ),\n-            tooltip: 'البحث بالباركود',\n-            onPressed: () {\n-              if (barcodeCtrl.hasActiveFilter) {\n-                barcodeCtrl.clearCurrentBarcode();\n-              } else {\n-                if (brandCtrl.isBrandModeActive.value) {\n-                  brandCtrl.deactivateBrandMode();\n-                }\n-                barcodeCtrl.activateBarcodeSearch();\n-              }\n-            },\n-          )),\n-\n           IconButton(\n             icon: Icon(Icons.favorite_border_rounded),\n             tooltip: 'المفضلة',\n             onPressed: () {\n               Get.to(() => FavoritesScreen());\n             },\n           ),\n-          \n+\n           // --- أيقونة الترتيب ---\n           PopupMenuButton<SortOption>(\n             icon: Icon(Icons.sort),\n             tooltip: 'ترتيب حسب',\n             onSelected: (SortOption result) {\n               searchCtrl.changeSortOption(result);\n             },\n-            itemBuilder: (BuildContext context) => <PopupMenuEntry<SortOption>>[\n-              for (final option in SortOption.values)\n-                PopupMenuItem<SortOption>(\n-                  value: option,\n-                  child: Obx(() => Text(\n-                    option.label,\n-                    style: TextStyle(\n-                      fontWeight: searchCtrl.currentSortOption.value == option\n-                          ? FontWeight.bold\n-                          : FontWeight.normal,\n+            itemBuilder:\n+                (BuildContext context) => <PopupMenuEntry<SortOption>>[\n+                  for (final option in SortOption.values)\n+                    PopupMenuItem<SortOption>(\n+                      value: option,\n+                      child: Obx(\n+                        () => Text(\n+                          option.label,\n+                          style: TextStyle(\n+                            fontWeight:\n+                                searchCtrl.currentSortOption.value == option\n+                                    ? FontWeight.bold\n+                                    : FontWeight.normal,\n+                          ),\n+                        ),\n+                      ),\n                     ),\n-                  )),\n-                ),\n-            ],\n-            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),\n+                ],\n+            shape: RoundedRectangleBorder(\n+              borderRadius: BorderRadius.circular(10),\n+            ),\n           ),\n         ],\n       ),\n       body: RefreshIndicator(\n@@ -146,16 +142,17 @@\n           await Future.delayed(Duration(seconds: 1));\n         },\n         child: ListView(\n           children: [\n-             SizedBox(height: hi/70),\n+            SizedBox(height: hi / 70),\n             // عروض - مرر الـ pageController من searchController\n             StreamBuilder(\n-              stream: FirebaseFirestore.instance\n-                  .collection(FirebaseX.offersCollection)\n-                  .where('appName', isEqualTo: FirebaseX.appName)\n-                  .limit(10)\n-                  .snapshots(),\n+              stream:\n+                  FirebaseFirestore.instance\n+                      .collection(FirebaseX.offersCollection)\n+                      .where('appName', isEqualTo: FirebaseX.appName)\n+                      .limit(10)\n+                      .snapshots(),\n               builder: (context, snapshot) {\n                 if (snapshot.connectionState == ConnectionState.waiting) {\n                   // يمكنك إرجاع شيمر أو لا شيء حسب رغبتك\n                   return SizedBox.shrink();\n@@ -169,155 +166,182 @@\n                 return OffersCarouselWidget();\n               },\n             ),\n \n-             SizedBox(height: hi/70),\n+            SizedBox(height: hi / 70),\n             const Divider(),\n \n             // الفلاتر المخفية/المظهرة مع انيميشن احترافي\n-            Obx(() => AnimatedSize(\n-              duration: const Duration(milliseconds: 500),\n-              curve: Curves.easeInOutCubic,\n-              child: AnimatedContainer(\n-                duration: const Duration(milliseconds: 400),\n-                height: showFilters.value ? null : 0,\n-                child: showFilters.value \n-                    ? AnimatedOpacity(\n-                        duration: const Duration(milliseconds: 600),\n-                        opacity: showFilters.value ? 1.0 : 0.0,\n-                        child: SlideTransition(\n-                          position: Tween<Offset>(\n-                            begin: const Offset(0, -0.3),\n-                            end: Offset.zero,\n-                          ).animate(CurvedAnimation(\n-                            parent: AlwaysStoppedAnimation(1.0),\n-                            curve: Curves.easeOutBack,\n-                          )),\n-                          child: Container(\n-                            margin: const EdgeInsets.symmetric(horizontal: 16),\n-                            padding: const EdgeInsets.all(16),\n-                            decoration: BoxDecoration(\n-                              color: theme.cardColor,\n-                              borderRadius: BorderRadius.circular(20),\n-                              boxShadow: [\n-                                BoxShadow(\n-                                  color: theme.primaryColor.withValues(alpha: 0.1),\n-                                  blurRadius: 20,\n-                                  offset: const Offset(0, 10),\n-                                  spreadRadius: 2,\n+            Obx(\n+              () => AnimatedSize(\n+                duration: const Duration(milliseconds: 500),\n+                curve: Curves.easeInOutCubic,\n+                child: AnimatedContainer(\n+                  duration: const Duration(milliseconds: 400),\n+                  height: showFilters.value ? null : 0,\n+                  child:\n+                      showFilters.value\n+                          ? AnimatedOpacity(\n+                            duration: const Duration(milliseconds: 600),\n+                            opacity: showFilters.value ? 1.0 : 0.0,\n+                            child: SlideTransition(\n+                              position: Tween<Offset>(\n+                                begin: const Offset(0, -0.3),\n+                                end: Offset.zero,\n+                              ).animate(\n+                                CurvedAnimation(\n+                                  parent: AlwaysStoppedAnimation(1.0),\n+                                  curve: Curves.easeOutBack,\n                                 ),\n-                                BoxShadow(\n-                                  color: Colors.black.withValues(alpha: 0.05),\n-                                  blurRadius: 10,\n-                                  offset: const Offset(0, 5),\n+                              ),\n+                              child: Container(\n+                                margin: const EdgeInsets.symmetric(\n+                                  horizontal: 16,\n                                 ),\n-                              ],\n-                            ),\n-                            child: Column(\n-                              children: [\n-                                // عنوان القسم مع رسوم متحركة\n-                                Row(\n-                                  children: [\n-                                    AnimatedContainer(\n-                                      duration: const Duration(milliseconds: 400),\n-                                      width: 40,\n-                                      height: 40,\n-                                      decoration: BoxDecoration(\n-                                        color: theme.primaryColor.withValues(alpha: 0.1),\n-                                        borderRadius: BorderRadius.circular(12),\n+                                padding: const EdgeInsets.all(16),\n+                                decoration: BoxDecoration(\n+                                  color: theme.cardColor,\n+                                  borderRadius: BorderRadius.circular(20),\n+                                  boxShadow: [\n+                                    BoxShadow(\n+                                      color: theme.primaryColor.withValues(\n+                                        alpha: 0.1,\n                                       ),\n-                                      child: Icon(\n-                                        Icons.filter_alt,\n-                                        color: theme.primaryColor,\n-                                        size: 24,\n-                                      ),\n+                                      blurRadius: 20,\n+                                      offset: const Offset(0, 10),\n+                                      spreadRadius: 2,\n                                     ),\n-                                    const SizedBox(width: 12),\n-                                    Text(\n-                                      'فلاتر البحث المتقدمة',\n-                                      style: TextStyle(\n-                                        fontSize: 18,\n-                                        fontWeight: FontWeight.bold,\n-                                        color: theme.primaryColor,\n+                                    BoxShadow(\n+                                      color: Colors.black.withValues(\n+                                        alpha: 0.05,\n                                       ),\n+                                      blurRadius: 10,\n+                                      offset: const Offset(0, 5),\n                                     ),\n-                                    const Spacer(),\n-                                    // زر الإغلاق\n-                                    InkWell(\n-                                      onTap: () => showFilters.value = false,\n-                                      borderRadius: BorderRadius.circular(20),\n-                                      child: Container(\n-                                        padding: const EdgeInsets.all(8),\n-                                        child: Icon(\n-                                          Icons.keyboard_arrow_up,\n-                                          color: theme.primaryColor,\n+                                  ],\n+                                ),\n+                                child: Column(\n+                                  children: [\n+                                    // عنوان القسم مع رسوم متحركة\n+                                    Row(\n+                                      children: [\n+                                        AnimatedContainer(\n+                                          duration: const Duration(\n+                                            milliseconds: 400,\n+                                          ),\n+                                          width: 40,\n+                                          height: 40,\n+                                          decoration: BoxDecoration(\n+                                            color: theme.primaryColor\n+                                                .withValues(alpha: 0.1),\n+                                            borderRadius: BorderRadius.circular(\n+                                              12,\n+                                            ),\n+                                          ),\n+                                          child: Icon(\n+                                            Icons.filter_alt,\n+                                            color: theme.primaryColor,\n+                                            size: 24,\n+                                          ),\n                                         ),\n-                                      ),\n+                                        const SizedBox(width: 12),\n+                                        Text(\n+                                          'فلاتر البحث المتقدمة',\n+                                          style: TextStyle(\n+                                            fontSize: 18,\n+                                            fontWeight: FontWeight.bold,\n+                                            color: theme.primaryColor,\n+                                          ),\n+                                        ),\n+                                        const Spacer(),\n+                                        // زر الإغلاق\n+                                        InkWell(\n+                                          onTap:\n+                                              () => showFilters.value = false,\n+                                          borderRadius: BorderRadius.circular(\n+                                            20,\n+                                          ),\n+                                          child: Container(\n+                                            padding: const EdgeInsets.all(8),\n+                                            child: Icon(\n+                                              Icons.keyboard_arrow_up,\n+                                              color: theme.primaryColor,\n+                                            ),\n+                                          ),\n+                                        ),\n+                                      ],\n                                     ),\n+\n+                                    const SizedBox(height: 16),\n+\n+                                    // محتوى الفلاتر\n+                                    const BrandFilterWidget(),\n                                   ],\n                                 ),\n-                                \n-                                const SizedBox(height: 16),\n-                                \n-                                // محتوى الفلاتر\n-                                const BrandFilterWidget(),\n-                              ],\n+                              ),\n                             ),\n-                          ),\n-                        ),\n-                      )\n-                    : const SizedBox.shrink(),\n+                          )\n+                          : const SizedBox.shrink(),\n+                ),\n               ),\n-            )),\n+            ),\n \n             // ويدجت البحث من خلال البراند والباركود\n             // تم نقلها للأعلى في الفلاتر المخفية\n             const Divider(),\n-             SizedBox(height: hi/70),\n+            SizedBox(height: hi / 70),\n \n             // عرض الأقسام (النظام الجديد أو القديم)\n-            Obx(() => (brandCtrl.isBrandModeActive.value || barcodeCtrl.isBarcodeSearchActive.value)\n-                ? const SizedBox.shrink()\n-                : _buildCategoriesWidget()),\n+            Obx(\n+              () =>\n+                  (brandCtrl.isBrandModeActive.value ||\n+                          barcodeCtrl.isBarcodeSearchActive.value)\n+                      ? const SizedBox.shrink()\n+                      : _buildCategoriesWidget(),\n+            ),\n             const Divider(),\n \n+            SizedBox(height: hi / 70),\n \n-\n-            SizedBox(height: hi/70),\n-\n             // شبكة المنتجات مع الفلترة المحسنة\n             Obx(() {\n               String filterKey = 'all_items'; // القيمة الافتراضية\n-              \n+\n               if (barcodeCtrl.hasActiveFilter) {\n                 filterKey = barcodeCtrl.getFilterKey();\n               } else if (brandCtrl.isBrandModeActive.value) {\n                 filterKey = brandCtrl.getFilterKey();\n               } else {\n                 // محاولة استخدام النظام الجديد أولاً\n                 try {\n-                  final filterCtrl = Get.find<EnhancedCategoryFilterController>();\n+                  final filterCtrl =\n+                      Get.find<EnhancedCategoryFilterController>();\n                   filterKey = filterCtrl.getFilterKey();\n-                                 } catch (e) {\n-                   // إذا فشل، استخدم النظام المبسط\n-                   try {\n-                     final categoryFilterCtrl = Get.find<EnhancedCategoryFilterController>();\n-                     filterKey = categoryFilterCtrl.getFilterKey();\n-                   } catch (e2) {\n-                     // إبقاء القيمة الافتراضية\n-                   }\n-                 }\n+                } catch (e) {\n+                  // إذا فشل، استخدم النظام المبسط\n+                  try {\n+                    final categoryFilterCtrl =\n+                        Get.find<EnhancedCategoryFilterController>();\n+                    filterKey = categoryFilterCtrl.getFilterKey();\n+                  } catch (e2) {\n+                    // إبقاء القيمة الافتراضية\n+                  }\n+                }\n               }\n-              \n+\n               final selectedSort = searchCtrl.currentSortOption.value;\n \n-              debugPrint(\"Rebuilding Product Grid: Filter='$filterKey', Sort='${selectedSort.label}'\");\n-              debugPrint(\"Brand Mode Active: ${brandCtrl.isBrandModeActive.value}\");\n-              debugPrint(\"Barcode Search Active: ${barcodeCtrl.hasActiveFilter}\");\n+              debugPrint(\n+                \"Rebuilding Product Grid: Filter='$filterKey', Sort='${selectedSort.label}'\",\n+              );\n+              debugPrint(\n+                \"Brand Mode Active: ${brandCtrl.isBrandModeActive.value}\",\n+              );\n+              debugPrint(\n+                \"Barcode Search Active: ${barcodeCtrl.hasActiveFilter}\",\n+              );\n \n-              return ProductGridWidgetOption(\n-                selectedSubtypeKey: filterKey,\n-              );\n+              return ProductGridWidgetOption(selectedSubtypeKey: filterKey);\n             }),\n \n             const SizedBox(height: 20),\n           ],\n@@ -325,19 +349,19 @@\n       ),\n     );\n   }\n \n-     // بناء ويدجت الأقسام (جديد أو مبسط)\n-   Widget _buildCategoriesWidget() {\n-     try {\n-       Get.find<EnhancedCategoryFilterController>();\n-       // إذا وُجد النظام الجديد، استخدمه\n-       return const SimpleMainCategoriesWidget();\n-     } catch (e) {\n-       // إذا لم يوجد النظام الجديد، استخدم النظام المبسط\n-       return const SimpleMainCategoriesWidget();\n-     }\n-   }\n+  // بناء ويدجت الأقسام (جديد أو مبسط)\n+  Widget _buildCategoriesWidget() {\n+    try {\n+      Get.find<EnhancedCategoryFilterController>();\n+      // إذا وُجد النظام الجديد، استخدمه\n+      return const SimpleMainCategoriesWidget();\n+    } catch (e) {\n+      // إذا لم يوجد النظام الجديد، استخدم النظام المبسط\n+      return const SimpleMainCategoriesWidget();\n+    }\n+  }\n }\n \n // --- شاشة البحث المنفصلة (مثال بسيط) ---\n class SearchScreen extends StatelessWidget {\n@@ -345,9 +369,10 @@\n \n   @override\n   Widget build(BuildContext context) {\n     // الحصول على نفس المتحكم الرئيسي أو إنشاء متحكم بحث خاص\n-    final GetSearchController searchController = Get.find<GetSearchController>();\n+    final GetSearchController searchController =\n+        Get.find<GetSearchController>();\n     // أو إنشاء واحد جديد: Get.put(SearchScreenController());\n \n     return Scaffold(\n       appBar: AppBar(\n@@ -359,20 +384,26 @@\n             hintText: \"ابحث عن المنتجات...\", // <<-- تعريب\n             border: InputBorder.none,\n             hintStyle: TextStyle(color: Colors.grey[600]),\n           ),\n-          style: TextStyle(color: Theme.of(context).textTheme.bodyLarge?.color, fontSize: 18),\n+          style: TextStyle(\n+            color: Theme.of(context).textTheme.bodyLarge?.color,\n+            fontSize: 18,\n+          ),\n           onChanged: (value) {\n             // قيمة البحث تتحدث تلقائياً في RxString في المتحكم بفضل المستمع\n             // searchController.searchQuery.value = value; // لا حاجة لهذا السطر إذا كان المستمع يعمل\n           },\n         ),\n         backgroundColor: Theme.of(context).appBarTheme.backgroundColor,\n         foregroundColor: Theme.of(context).appBarTheme.foregroundColor,\n       ),\n-      body: Obx(() { // مراقبة searchQuery\n+      body: Obx(() {\n+        // مراقبة searchQuery\n         // --- عرض النتائج باستخدام Widget البحث ---\n-        return SearchResultsListWidget(searchQuery: searchController.searchQuery.value);\n+        return SearchResultsListWidget(\n+          searchQuery: searchController.searchQuery.value,\n+        );\n       }),\n     );\n   }\n }\n"
                },
                {
                    "date": 1752922212089,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n import 'package:cloud_firestore/cloud_firestore.dart';\n import 'package:flutter/material.dart';\n import 'package:get/get.dart';\n+import 'package:flutter_screenutil/flutter_screenutil.dart';\n \n import '../../../XXX/xxx_firebase.dart';\n import '../controllers/enhanced_category_filter_controller.dart';\n import '../widgets/simple_main_categories_widget.dart';\n@@ -90,8 +91,34 @@\n                   ),\n                 ),\n                 tooltip: 'فلاتر البحث',\n                 onPressed: () {\n+                  // إذا كانت الفلاتر مفتوحة، أغلق جميع الفلاتر النشطة\n+                  if (showFilters.value) {\n+                    // مسح جميع الإشعارات أولاً\n+                    barcodeCtrl.clearAllNotifications();\n+                    \n+                    // إغلاق فلتر البراند إذا كان نشط\n+                    if (brandCtrl.isBrandModeActive.value) {\n+                      brandCtrl.deactivateBrandMode();\n+                    }\n+                    \n+                    // إغلاق فلتر الباركود إذا كان نشط\n+                    if (barcodeCtrl.isBarcodeSearchActive.value) {\n+                      barcodeCtrl.deactivateBarcodeSearch();\n+                    }\n+                    \n+                    // إيقاف الكاميرا إذا كانت تعمل\n+                    if (barcodeCtrl.isScanning.value) {\n+                      barcodeCtrl.stopCameraScanning();\n+                    }\n+                    \n+                    // مسح أي نتائج أو حالة للفلاتر\n+                    barcodeCtrl.clearCurrentBarcode();\n+                    brandCtrl.clearAllSelections();\n+                  }\n+                  \n+                  // تبديل حالة عرض الفلاتر\n                   showFilters.value = !showFilters.value;\n                 },\n               ),\n             ),\n@@ -284,11 +311,49 @@\n                 ),\n               ),\n             ),\n \n+            // Divider انيميتد يظهر ويختفي مع الفلاتر\n+            Obx(\n+              () => AnimatedSize(\n+                duration: const Duration(milliseconds: 600),\n+                curve: Curves.easeInOutCubic,\n+                child: AnimatedContainer(\n+                  duration: const Duration(milliseconds: 500),\n+                  height: showFilters.value ? null : 0,\n+                  child: showFilters.value\n+                      ? AnimatedOpacity(\n+                          duration: const Duration(milliseconds: 700),\n+                          opacity: showFilters.value ? 1.0 : 0.0,\n+                          child: Container(\n+                            margin: EdgeInsets.symmetric(vertical: 8.h),\n+                            child: AnimatedContainer(\n+                              duration: const Duration(milliseconds: 800),\n+                              width: showFilters.value ? double.infinity : 0,\n+                              child: Container(\n+                                height: 1,\n+                                decoration: BoxDecoration(\n+                                  gradient: LinearGradient(\n+                                    colors: [\n+                                      Colors.transparent,\n+                                      theme.primaryColor.withValues(alpha: 0.3),\n+                                      theme.primaryColor.withValues(alpha: 0.6),\n+                                      theme.primaryColor.withValues(alpha: 0.3),\n+                                      Colors.transparent,\n+                                    ],\n+                                  ),\n+                                ),\n+                              ),\n+                            ),\n+                          ),\n+                        )\n+                      : const SizedBox.shrink(),\n+                ),\n+              ),\n+            ),\n+\n             // ويدجت البحث من خلال البراند والباركود\n             // تم نقلها للأعلى في الفلاتر المخفية\n-            const Divider(),\n             SizedBox(height: hi / 70),\n \n             // عرض الأقسام (النظام الجديد أو القديم)\n             Obx(\n"
                },
                {
                    "date": 1752941662765,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,8 +39,10 @@\n     );\n \n     // إضافة متحكم للفلاتر مع حالة الإظهار/الإخفاء\n     final RxBool showFilters = false.obs;\n+    // إضافة متحكم منفصل لفلاتر الأقسام الرئيسية والفرعية\n+    final RxBool showCategoryFilters = false.obs;\n \n     double hi = MediaQuery.of(context).size.height;\n     final theme = Theme.of(context);\n \n@@ -65,16 +67,61 @@\n               Get.to(() => SearchScreen(), transition: Transition.downToUp);\n             },\n           ),\n \n-          // --- أيقونة الفلاتر الجديدة ---\n+          // --- أيقونة فلاتر الأقسام الرئيسية والفرعية ---\n           Obx(\n             () => AnimatedContainer(\n               duration: const Duration(milliseconds: 300),\n-              margin: const EdgeInsets.only(right: 8),\n+              margin: EdgeInsets.only(right: 8.w),\n               decoration: BoxDecoration(\n-                borderRadius: BorderRadius.circular(12),\n+                borderRadius: BorderRadius.circular(12.r),\n                 color:\n+                    showCategoryFilters.value\n+                        ? theme.primaryColor.withValues(alpha: 0.1)\n+                        : Colors.transparent,\n+              ),\n+              child: IconButton(\n+                icon: AnimatedRotation(\n+                  duration: const Duration(milliseconds: 300),\n+                  turns: showCategoryFilters.value ? 0.5 : 0,\n+                  child: Icon(\n+                    Icons.category,\n+                    size: 24.sp,\n+                    color:\n+                        showCategoryFilters.value\n+                            ? theme.primaryColor\n+                            : theme.appBarTheme.foregroundColor,\n+                  ),\n+                ),\n+                tooltip: 'فلاتر الأقسام',\n+                onPressed: () {\n+                  // إذا كانت فلاتر الأقسام مفتوحة، مسح الفلاتر النشطة\n+                  if (showCategoryFilters.value) {\n+                    try {\n+                      final EnhancedCategoryFilterController categoryCtrl =\n+                          Get.find<EnhancedCategoryFilterController>();\n+                      categoryCtrl.resetFilters();\n+                    } catch (e) {\n+                      debugPrint(\"تعذر العثور على متحكم فلاتر الأقسام\");\n+                    }\n+                  }\n+\n+                  // تبديل حالة عرض فلاتر الأقسام\n+                  showCategoryFilters.value = !showCategoryFilters.value;\n+                },\n+              ),\n+            ),\n+          ),\n+\n+          // --- أيقونة الفلاتر المتقدمة ---\n+          Obx(\n+            () => AnimatedContainer(\n+              duration: const Duration(milliseconds: 300),\n+              margin: EdgeInsets.only(right: 8.w),\n+              decoration: BoxDecoration(\n+                borderRadius: BorderRadius.circular(12.r),\n+                color:\n                     showFilters.value\n                         ? theme.primaryColor.withValues(alpha: 0.1)\n                         : Colors.transparent,\n               ),\n@@ -83,59 +130,60 @@\n                   duration: const Duration(milliseconds: 300),\n                   turns: showFilters.value ? 0.5 : 0,\n                   child: Icon(\n                     Icons.tune,\n+                    size: 24.sp,\n                     color:\n                         showFilters.value\n                             ? theme.primaryColor\n                             : theme.appBarTheme.foregroundColor,\n                   ),\n                 ),\n-                tooltip: 'فلاتر البحث',\n+                tooltip: 'فلاتر البحث المتقدمة',\n                 onPressed: () {\n                   // إذا كانت الفلاتر مفتوحة، أغلق جميع الفلاتر النشطة\n                   if (showFilters.value) {\n                     // مسح جميع الإشعارات أولاً\n                     barcodeCtrl.clearAllNotifications();\n-                    \n+\n                     // إغلاق فلتر البراند إذا كان نشط\n                     if (brandCtrl.isBrandModeActive.value) {\n                       brandCtrl.deactivateBrandMode();\n                     }\n-                    \n+\n                     // إغلاق فلتر الباركود إذا كان نشط\n                     if (barcodeCtrl.isBarcodeSearchActive.value) {\n                       barcodeCtrl.deactivateBarcodeSearch();\n                     }\n-                    \n+\n                     // إيقاف الكاميرا إذا كانت تعمل\n                     if (barcodeCtrl.isScanning.value) {\n                       barcodeCtrl.stopCameraScanning();\n                     }\n-                    \n+\n                     // مسح أي نتائج أو حالة للفلاتر\n                     barcodeCtrl.clearCurrentBarcode();\n                     brandCtrl.clearAllSelections();\n                   }\n-                  \n+\n                   // تبديل حالة عرض الفلاتر\n                   showFilters.value = !showFilters.value;\n                 },\n               ),\n             ),\n           ),\n \n           IconButton(\n-            icon: Icon(Icons.favorite_border_rounded),\n+            icon: Icon(Icons.favorite_border_rounded, size: 24.sp),\n             tooltip: 'المفضلة',\n             onPressed: () {\n               Get.to(() => FavoritesScreen());\n             },\n           ),\n \n           // --- أيقونة الترتيب ---\n           PopupMenuButton<SortOption>(\n-            icon: Icon(Icons.sort),\n+            icon: Icon(Icons.sort, size: 24.sp),\n             tooltip: 'ترتيب حسب',\n             onSelected: (SortOption result) {\n               searchCtrl.changeSortOption(result);\n             },\n@@ -147,8 +195,9 @@\n                       child: Obx(\n                         () => Text(\n                           option.label,\n                           style: TextStyle(\n+                            fontSize: 14.sp,\n                             fontWeight:\n                                 searchCtrl.currentSortOption.value == option\n                                     ? FontWeight.bold\n                                     : FontWeight.normal,\n@@ -157,9 +206,9 @@\n                       ),\n                     ),\n                 ],\n             shape: RoundedRectangleBorder(\n-              borderRadius: BorderRadius.circular(10),\n+              borderRadius: BorderRadius.circular(10.r),\n             ),\n           ),\n         ],\n       ),\n@@ -196,8 +245,265 @@\n \n             SizedBox(height: hi / 70),\n             const Divider(),\n \n+            // فلاتر الأقسام الرئيسية والفرعية مع انيميشن احترافي\n+            Obx(\n+              () => AnimatedSize(\n+                duration: const Duration(milliseconds: 600),\n+                curve: Curves.easeInOutCubic,\n+                child: AnimatedContainer(\n+                  duration: const Duration(milliseconds: 500),\n+                  height: showCategoryFilters.value ? null : 0,\n+                  child:\n+                      showCategoryFilters.value\n+                          ? AnimatedOpacity(\n+                            duration: const Duration(milliseconds: 700),\n+                            opacity: showCategoryFilters.value ? 1.0 : 0.0,\n+                            child: TweenAnimationBuilder<double>(\n+                              duration: const Duration(milliseconds: 800),\n+                              tween: Tween<double>(\n+                                begin: 0.0,\n+                                end: showCategoryFilters.value ? 1.0 : 0.0,\n+                              ),\n+                              curve: Curves.elasticOut,\n+                              builder: (context, value, child) {\n+                                return Transform.scale(\n+                                  scale: 0.8 + (0.2 * value),\n+                                  child: Transform.translate(\n+                                    offset: Offset(0, 20 * (1 - value)),\n+                                    child: Container(\n+                                      margin: EdgeInsets.symmetric(\n+                                        horizontal: 16.w,\n+                                        vertical: 8.h,\n+                                      ),\n+                                      padding: EdgeInsets.all(20.w),\n+                                      decoration: BoxDecoration(\n+                                        color: theme.cardColor,\n+                                        borderRadius: BorderRadius.circular(\n+                                          24.r,\n+                                        ),\n+                                        boxShadow: [\n+                                          BoxShadow(\n+                                            color: theme.primaryColor\n+                                                .withValues(alpha: 0.15),\n+                                            blurRadius: 25.r,\n+                                            offset: Offset(0, 15.h),\n+                                            spreadRadius: 3.r,\n+                                          ),\n+                                          BoxShadow(\n+                                            color: Colors.black.withValues(\n+                                              alpha: 0.08,\n+                                            ),\n+                                            blurRadius: 15.r,\n+                                            offset: Offset(0, 8.h),\n+                                          ),\n+                                        ],\n+                                        border: Border.all(\n+                                          color: theme.primaryColor.withValues(\n+                                            alpha: 0.1,\n+                                          ),\n+                                          width: 1.5.w,\n+                                        ),\n+                                      ),\n+                                      child: Column(\n+                                        children: [\n+                                          // عنوان فلاتر الأقسام مع رسوم متحركة\n+                                          Row(\n+                                            children: [\n+                                              AnimatedContainer(\n+                                                duration: const Duration(\n+                                                  milliseconds: 600,\n+                                                ),\n+                                                width: 45.w,\n+                                                height: 45.h,\n+                                                decoration: BoxDecoration(\n+                                                  gradient: LinearGradient(\n+                                                    colors: [\n+                                                      theme.primaryColor,\n+                                                      theme.primaryColor\n+                                                          .withValues(\n+                                                            alpha: 0.7,\n+                                                          ),\n+                                                    ],\n+                                                    begin: Alignment.topLeft,\n+                                                    end: Alignment.bottomRight,\n+                                                  ),\n+                                                  borderRadius:\n+                                                      BorderRadius.circular(\n+                                                        15.r,\n+                                                      ),\n+                                                  boxShadow: [\n+                                                    BoxShadow(\n+                                                      color: theme.primaryColor\n+                                                          .withValues(\n+                                                            alpha: 0.3,\n+                                                          ),\n+                                                      blurRadius: 12.r,\n+                                                      offset: Offset(0, 6.h),\n+                                                    ),\n+                                                  ],\n+                                                ),\n+                                                child: Icon(\n+                                                  Icons.category_rounded,\n+                                                  color: Colors.white,\n+                                                  size: 26.sp,\n+                                                ),\n+                                              ),\n+                                              SizedBox(width: 15.w),\n+                                              Expanded(\n+                                                child: Column(\n+                                                  crossAxisAlignment:\n+                                                      CrossAxisAlignment.start,\n+                                                  children: [\n+                                                    Text(\n+                                                      'فلاتر الأقسام',\n+                                                      style: TextStyle(\n+                                                        fontSize: 20.sp,\n+                                                        fontWeight:\n+                                                            FontWeight.bold,\n+                                                        color:\n+                                                            theme.primaryColor,\n+                                                      ),\n+                                                    ),\n+                                                    SizedBox(height: 2.h),\n+                                                    Text(\n+                                                      'اختر القسم الرئيسي والفرعي',\n+                                                      style: TextStyle(\n+                                                        fontSize: 14.sp,\n+                                                        color: Colors.grey[600],\n+                                                        fontWeight:\n+                                                            FontWeight.w500,\n+                                                      ),\n+                                                    ),\n+                                                  ],\n+                                                ),\n+                                              ),\n+                                              // زر الإغلاق مع انيميشن\n+                                              InkWell(\n+                                                onTap:\n+                                                    () =>\n+                                                        showCategoryFilters\n+                                                            .value = false,\n+                                                borderRadius:\n+                                                    BorderRadius.circular(25.r),\n+                                                child: AnimatedContainer(\n+                                                  duration: const Duration(\n+                                                    milliseconds: 300,\n+                                                  ),\n+                                                  padding: EdgeInsets.all(12.w),\n+                                                  decoration: BoxDecoration(\n+                                                    color: Colors.grey[100],\n+                                                    borderRadius:\n+                                                        BorderRadius.circular(\n+                                                          25.r,\n+                                                        ),\n+                                                  ),\n+                                                  child: AnimatedRotation(\n+                                                    duration: const Duration(\n+                                                      milliseconds: 300,\n+                                                    ),\n+                                                    turns: 0.5,\n+                                                    child: Icon(\n+                                                      Icons.keyboard_arrow_up,\n+                                                      color: theme.primaryColor,\n+                                                      size: 24.sp,\n+                                                    ),\n+                                                  ),\n+                                                ),\n+                                              ),\n+                                            ],\n+                                          ),\n+\n+                                          SizedBox(height: 20.h),\n+\n+                                          // محتوى فلاتر الأقسام\n+                                          const SimpleMainCategoriesWidget(),\n+                                        ],\n+                                      ),\n+                                    ),\n+                                  ),\n+                                );\n+                              },\n+                            ),\n+                          )\n+                          : const SizedBox.shrink(),\n+                ),\n+              ),\n+            ),\n+\n+            // Divider انيميتد يظهر ويختفي مع فلاتر الأقسام\n+            Obx(\n+              () => AnimatedSize(\n+                duration: const Duration(milliseconds: 700),\n+                curve: Curves.easeInOutCubic,\n+                child: AnimatedContainer(\n+                  duration: const Duration(milliseconds: 600),\n+                  height: showCategoryFilters.value ? null : 0,\n+                  child:\n+                      showCategoryFilters.value\n+                          ? AnimatedOpacity(\n+                            duration: const Duration(milliseconds: 800),\n+                            opacity: showCategoryFilters.value ? 1.0 : 0.0,\n+                            child: TweenAnimationBuilder<double>(\n+                              duration: const Duration(milliseconds: 900),\n+                              tween: Tween<double>(\n+                                begin: 0.0,\n+                                end: showCategoryFilters.value ? 1.0 : 0.0,\n+                              ),\n+                              curve: Curves.easeOutBack,\n+                              builder: (context, value, child) {\n+                                return Container(\n+                                  margin: EdgeInsets.symmetric(\n+                                    vertical: 12.h * value,\n+                                    horizontal: 20 * value,\n+                                  ),\n+                                  child: AnimatedContainer(\n+                                    duration: const Duration(\n+                                      milliseconds: 1000,\n+                                    ),\n+                                    width: (double.infinity) * value,\n+                                    child: Container(\n+                                      height: 2.h,\n+                                      decoration: BoxDecoration(\n+                                        borderRadius: BorderRadius.circular(\n+                                          2.r,\n+                                        ),\n+                                        gradient: LinearGradient(\n+                                          colors: [\n+                                            Colors.transparent,\n+                                            theme.primaryColor.withValues(\n+                                              alpha: 0.2 * value,\n+                                            ),\n+                                            theme.primaryColor.withValues(\n+                                              alpha: 0.8 * value,\n+                                            ),\n+                                            theme.primaryColor.withValues(\n+                                              alpha: 0.2 * value,\n+                                            ),\n+                                            Colors.transparent,\n+                                          ],\n+                                        ),\n+                                        boxShadow: [\n+                                          BoxShadow(\n+                                            color: theme.primaryColor\n+                                                .withValues(alpha: 0.3 * value),\n+                                            blurRadius: 8.r * value,\n+                                            offset: Offset(0, 2.h * value),\n+                                          ),\n+                                        ],\n+                                      ),\n+                                    ),\n+                                  ),\n+                                );\n+                              },\n+                            ),\n+                          )\n+                          : const SizedBox.shrink(),\n+                ),\n+              ),\n+            ),\n+\n             // الفلاتر المخفية/المظهرة مع انيميشن احترافي\n             Obx(\n               () => AnimatedSize(\n                 duration: const Duration(milliseconds: 500),\n@@ -220,30 +526,28 @@\n                                   curve: Curves.easeOutBack,\n                                 ),\n                               ),\n                               child: Container(\n-                                margin: const EdgeInsets.symmetric(\n-                                  horizontal: 16,\n-                                ),\n-                                padding: const EdgeInsets.all(16),\n+                                margin: EdgeInsets.symmetric(horizontal: 16.w),\n+                                padding: EdgeInsets.all(16.w),\n                                 decoration: BoxDecoration(\n                                   color: theme.cardColor,\n-                                  borderRadius: BorderRadius.circular(20),\n+                                  borderRadius: BorderRadius.circular(20.r),\n                                   boxShadow: [\n                                     BoxShadow(\n                                       color: theme.primaryColor.withValues(\n                                         alpha: 0.1,\n                                       ),\n-                                      blurRadius: 20,\n-                                      offset: const Offset(0, 10),\n-                                      spreadRadius: 2,\n+                                      blurRadius: 20.r,\n+                                      offset: Offset(0, 10.h),\n+                                      spreadRadius: 2.r,\n                                     ),\n                                     BoxShadow(\n                                       color: Colors.black.withValues(\n                                         alpha: 0.05,\n                                       ),\n-                                      blurRadius: 10,\n-                                      offset: const Offset(0, 5),\n+                                      blurRadius: 10.r,\n+                                      offset: Offset(0, 5.h),\n                                     ),\n                                   ],\n                                 ),\n                                 child: Column(\n@@ -254,28 +558,28 @@\n                                         AnimatedContainer(\n                                           duration: const Duration(\n                                             milliseconds: 400,\n                                           ),\n-                                          width: 40,\n-                                          height: 40,\n+                                          width: 40.w,\n+                                          height: 40.h,\n                                           decoration: BoxDecoration(\n                                             color: theme.primaryColor\n                                                 .withValues(alpha: 0.1),\n                                             borderRadius: BorderRadius.circular(\n-                                              12,\n+                                              12.r,\n                                             ),\n                                           ),\n                                           child: Icon(\n                                             Icons.filter_alt,\n                                             color: theme.primaryColor,\n-                                            size: 24,\n+                                            size: 24.sp,\n                                           ),\n                                         ),\n-                                        const SizedBox(width: 12),\n+                                        SizedBox(width: 12.w),\n                                         Text(\n                                           'فلاتر البحث المتقدمة',\n                                           style: TextStyle(\n-                                            fontSize: 18,\n+                                            fontSize: 18.sp,\n                                             fontWeight: FontWeight.bold,\n                                             color: theme.primaryColor,\n                                           ),\n                                         ),\n@@ -284,22 +588,23 @@\n                                         InkWell(\n                                           onTap:\n                                               () => showFilters.value = false,\n                                           borderRadius: BorderRadius.circular(\n-                                            20,\n+                                            20.r,\n                                           ),\n                                           child: Container(\n-                                            padding: const EdgeInsets.all(8),\n+                                            padding: EdgeInsets.all(8.w),\n                                             child: Icon(\n                                               Icons.keyboard_arrow_up,\n                                               color: theme.primaryColor,\n+                                              size: 24.sp,\n                                             ),\n                                           ),\n                                         ),\n                                       ],\n                                     ),\n \n-                                    const SizedBox(height: 16),\n+                                    SizedBox(height: 16.h),\n \n                                     // محتوى الفلاتر\n                                     const BrandFilterWidget(),\n                                   ],\n@@ -319,55 +624,50 @@\n                 curve: Curves.easeInOutCubic,\n                 child: AnimatedContainer(\n                   duration: const Duration(milliseconds: 500),\n                   height: showFilters.value ? null : 0,\n-                  child: showFilters.value\n-                      ? AnimatedOpacity(\n-                          duration: const Duration(milliseconds: 700),\n-                          opacity: showFilters.value ? 1.0 : 0.0,\n-                          child: Container(\n-                            margin: EdgeInsets.symmetric(vertical: 8.h),\n-                            child: AnimatedContainer(\n-                              duration: const Duration(milliseconds: 800),\n-                              width: showFilters.value ? double.infinity : 0,\n-                              child: Container(\n-                                height: 1,\n-                                decoration: BoxDecoration(\n-                                  gradient: LinearGradient(\n-                                    colors: [\n-                                      Colors.transparent,\n-                                      theme.primaryColor.withValues(alpha: 0.3),\n-                                      theme.primaryColor.withValues(alpha: 0.6),\n-                                      theme.primaryColor.withValues(alpha: 0.3),\n-                                      Colors.transparent,\n-                                    ],\n+                  child:\n+                      showFilters.value\n+                          ? AnimatedOpacity(\n+                            duration: const Duration(milliseconds: 700),\n+                            opacity: showFilters.value ? 1.0 : 0.0,\n+                            child: Container(\n+                              margin: EdgeInsets.symmetric(vertical: 8.h),\n+                              child: AnimatedContainer(\n+                                duration: const Duration(milliseconds: 800),\n+                                width: showFilters.value ? double.infinity : 0,\n+                                child: Container(\n+                                  height: 1.h,\n+                                  decoration: BoxDecoration(\n+                                    gradient: LinearGradient(\n+                                      colors: [\n+                                        Colors.transparent,\n+                                        theme.primaryColor.withValues(\n+                                          alpha: 0.3,\n+                                        ),\n+                                        theme.primaryColor.withValues(\n+                                          alpha: 0.6,\n+                                        ),\n+                                        theme.primaryColor.withValues(\n+                                          alpha: 0.3,\n+                                        ),\n+                                        Colors.transparent,\n+                                      ],\n+                                    ),\n                                   ),\n                                 ),\n                               ),\n                             ),\n-                          ),\n-                        )\n-                      : const SizedBox.shrink(),\n+                          )\n+                          : const SizedBox.shrink(),\n                 ),\n               ),\n             ),\n \n             // ويدجت البحث من خلال البراند والباركود\n             // تم نقلها للأعلى في الفلاتر المخفية\n             SizedBox(height: hi / 70),\n \n-            // عرض الأقسام (النظام الجديد أو القديم)\n-            Obx(\n-              () =>\n-                  (brandCtrl.isBrandModeActive.value ||\n-                          barcodeCtrl.isBarcodeSearchActive.value)\n-                      ? const SizedBox.shrink()\n-                      : _buildCategoriesWidget(),\n-            ),\n-            const Divider(),\n-\n-            SizedBox(height: hi / 70),\n-\n             // شبكة المنتجات مع الفلترة المحسنة\n             Obx(() {\n               String filterKey = 'all_items'; // القيمة الافتراضية\n \n@@ -407,26 +707,14 @@\n \n               return ProductGridWidgetOption(selectedSubtypeKey: filterKey);\n             }),\n \n-            const SizedBox(height: 20),\n+            SizedBox(height: 20.h),\n           ],\n         ),\n       ),\n     );\n   }\n-\n-  // بناء ويدجت الأقسام (جديد أو مبسط)\n-  Widget _buildCategoriesWidget() {\n-    try {\n-      Get.find<EnhancedCategoryFilterController>();\n-      // إذا وُجد النظام الجديد، استخدمه\n-      return const SimpleMainCategoriesWidget();\n-    } catch (e) {\n-      // إذا لم يوجد النظام الجديد، استخدم النظام المبسط\n-      return const SimpleMainCategoriesWidget();\n-    }\n-  }\n }\n \n // --- شاشة البحث المنفصلة (مثال بسيط) ---\n class SearchScreen extends StatelessWidget {\n@@ -451,9 +739,9 @@\n             hintStyle: TextStyle(color: Colors.grey[600]),\n           ),\n           style: TextStyle(\n             color: Theme.of(context).textTheme.bodyLarge?.color,\n-            fontSize: 18,\n+            fontSize: 18.sp,\n           ),\n           onChanged: (value) {\n             // قيمة البحث تتحدث تلقائياً في RxString في المتحكم بفضل المستمع\n             // searchController.searchQuery.value = value; // لا حاجة لهذا السطر إذا كان المستمع يعمل\n"
                },
                {
                    "date": 1752944467988,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -41,176 +41,59 @@\n     // إضافة متحكم للفلاتر مع حالة الإظهار/الإخفاء\n     final RxBool showFilters = false.obs;\n     // إضافة متحكم منفصل لفلاتر الأقسام الرئيسية والفرعية\n     final RxBool showCategoryFilters = false.obs;\n+    // متحكم انيميشن الإيقونات الاحترافي\n+    final RxBool isMenuExpanded = false.obs;\n \n     double hi = MediaQuery.of(context).size.height;\n     final theme = Theme.of(context);\n \n     return Scaffold(\n       backgroundColor: theme.scaffoldBackgroundColor,\n       appBar: AppBar(\n-        title: Text(\n-          \"الصفحة الرئيسية\",\n-          style: TextStyle(color: theme.textTheme.titleLarge?.color),\n+        title: Obx(\n+          () => AnimatedSwitcher(\n+            duration: const Duration(milliseconds: 800),\n+            transitionBuilder: (Widget child, Animation<double> animation) {\n+              return SlideTransition(\n+                position: Tween<Offset>(\n+                  begin: const Offset(0, -1),\n+                  end: Offset.zero,\n+                ).animate(\n+                  CurvedAnimation(parent: animation, curve: Curves.elasticOut),\n+                ),\n+                child: FadeTransition(opacity: animation, child: child),\n+              );\n+            },\n+            child: Text(\n+              isMenuExpanded.value ? \"\" : \"الصفحة الرئيسية\",\n+              key: ValueKey<bool>(isMenuExpanded.value),\n+              style: TextStyle(\n+                color: theme.textTheme.titleLarge?.color,\n+                fontSize: 20.sp,\n+                fontWeight: FontWeight.bold,\n+              ),\n+            ),\n+          ),\n         ),\n         backgroundColor:\n             theme.appBarTheme.backgroundColor ?? theme.scaffoldBackgroundColor,\n         elevation: theme.appBarTheme.elevation ?? 0,\n         foregroundColor:\n             theme.appBarTheme.foregroundColor ?? theme.colorScheme.primary,\n         actions: [\n-          // --- أيقونة البحث ---\n-          IconButton(\n-            icon: Icon(Icons.search),\n-            tooltip: 'بحث',\n-            onPressed: () {\n-              Get.to(() => SearchScreen(), transition: Transition.downToUp);\n-            },\n+          // نظام الإيقونات الاحترافي الجديد\n+          _buildAdvancedIconSystem(\n+            context,\n+            theme,\n+            isMenuExpanded,\n+            showCategoryFilters,\n+            showFilters,\n+            searchCtrl,\n+            brandCtrl,\n+            barcodeCtrl,\n           ),\n-\n-          // --- أيقونة فلاتر الأقسام الرئيسية والفرعية ---\n-          Obx(\n-            () => AnimatedContainer(\n-              duration: const Duration(milliseconds: 300),\n-              margin: EdgeInsets.only(right: 8.w),\n-              decoration: BoxDecoration(\n-                borderRadius: BorderRadius.circular(12.r),\n-                color:\n-                    showCategoryFilters.value\n-                        ? theme.primaryColor.withValues(alpha: 0.1)\n-                        : Colors.transparent,\n-              ),\n-              child: IconButton(\n-                icon: AnimatedRotation(\n-                  duration: const Duration(milliseconds: 300),\n-                  turns: showCategoryFilters.value ? 0.5 : 0,\n-                  child: Icon(\n-                    Icons.category,\n-                    size: 24.sp,\n-                    color:\n-                        showCategoryFilters.value\n-                            ? theme.primaryColor\n-                            : theme.appBarTheme.foregroundColor,\n-                  ),\n-                ),\n-                tooltip: 'فلاتر الأقسام',\n-                onPressed: () {\n-                  // إذا كانت فلاتر الأقسام مفتوحة، مسح الفلاتر النشطة\n-                  if (showCategoryFilters.value) {\n-                    try {\n-                      final EnhancedCategoryFilterController categoryCtrl =\n-                          Get.find<EnhancedCategoryFilterController>();\n-                      categoryCtrl.resetFilters();\n-                    } catch (e) {\n-                      debugPrint(\"تعذر العثور على متحكم فلاتر الأقسام\");\n-                    }\n-                  }\n-\n-                  // تبديل حالة عرض فلاتر الأقسام\n-                  showCategoryFilters.value = !showCategoryFilters.value;\n-                },\n-              ),\n-            ),\n-          ),\n-\n-          // --- أيقونة الفلاتر المتقدمة ---\n-          Obx(\n-            () => AnimatedContainer(\n-              duration: const Duration(milliseconds: 300),\n-              margin: EdgeInsets.only(right: 8.w),\n-              decoration: BoxDecoration(\n-                borderRadius: BorderRadius.circular(12.r),\n-                color:\n-                    showFilters.value\n-                        ? theme.primaryColor.withValues(alpha: 0.1)\n-                        : Colors.transparent,\n-              ),\n-              child: IconButton(\n-                icon: AnimatedRotation(\n-                  duration: const Duration(milliseconds: 300),\n-                  turns: showFilters.value ? 0.5 : 0,\n-                  child: Icon(\n-                    Icons.tune,\n-                    size: 24.sp,\n-                    color:\n-                        showFilters.value\n-                            ? theme.primaryColor\n-                            : theme.appBarTheme.foregroundColor,\n-                  ),\n-                ),\n-                tooltip: 'فلاتر البحث المتقدمة',\n-                onPressed: () {\n-                  // إذا كانت الفلاتر مفتوحة، أغلق جميع الفلاتر النشطة\n-                  if (showFilters.value) {\n-                    // مسح جميع الإشعارات أولاً\n-                    barcodeCtrl.clearAllNotifications();\n-\n-                    // إغلاق فلتر البراند إذا كان نشط\n-                    if (brandCtrl.isBrandModeActive.value) {\n-                      brandCtrl.deactivateBrandMode();\n-                    }\n-\n-                    // إغلاق فلتر الباركود إذا كان نشط\n-                    if (barcodeCtrl.isBarcodeSearchActive.value) {\n-                      barcodeCtrl.deactivateBarcodeSearch();\n-                    }\n-\n-                    // إيقاف الكاميرا إذا كانت تعمل\n-                    if (barcodeCtrl.isScanning.value) {\n-                      barcodeCtrl.stopCameraScanning();\n-                    }\n-\n-                    // مسح أي نتائج أو حالة للفلاتر\n-                    barcodeCtrl.clearCurrentBarcode();\n-                    brandCtrl.clearAllSelections();\n-                  }\n-\n-                  // تبديل حالة عرض الفلاتر\n-                  showFilters.value = !showFilters.value;\n-                },\n-              ),\n-            ),\n-          ),\n-\n-          IconButton(\n-            icon: Icon(Icons.favorite_border_rounded, size: 24.sp),\n-            tooltip: 'المفضلة',\n-            onPressed: () {\n-              Get.to(() => FavoritesScreen());\n-            },\n-          ),\n-\n-          // --- أيقونة الترتيب ---\n-          PopupMenuButton<SortOption>(\n-            icon: Icon(Icons.sort, size: 24.sp),\n-            tooltip: 'ترتيب حسب',\n-            onSelected: (SortOption result) {\n-              searchCtrl.changeSortOption(result);\n-            },\n-            itemBuilder:\n-                (BuildContext context) => <PopupMenuEntry<SortOption>>[\n-                  for (final option in SortOption.values)\n-                    PopupMenuItem<SortOption>(\n-                      value: option,\n-                      child: Obx(\n-                        () => Text(\n-                          option.label,\n-                          style: TextStyle(\n-                            fontSize: 14.sp,\n-                            fontWeight:\n-                                searchCtrl.currentSortOption.value == option\n-                                    ? FontWeight.bold\n-                                    : FontWeight.normal,\n-                          ),\n-                        ),\n-                      ),\n-                    ),\n-                ],\n-            shape: RoundedRectangleBorder(\n-              borderRadius: BorderRadius.circular(10.r),\n-            ),\n-          ),\n         ],\n       ),\n       body: RefreshIndicator(\n         onRefresh: () async {\n@@ -713,8 +596,612 @@\n         ),\n       ),\n     );\n   }\n+\n+  /// نظام الإيقونات الاحترافي مع انيميشن الأفعى\n+  Widget _buildAdvancedIconSystem(\n+    BuildContext context,\n+    ThemeData theme,\n+    RxBool isMenuExpanded,\n+    RxBool showCategoryFilters,\n+    RxBool showFilters,\n+    GetSearchController searchCtrl,\n+    BrandFilterController brandCtrl,\n+    BarcodeFilterController barcodeCtrl,\n+  ) {\n+    return Obx(\n+      () => AnimatedContainer(\n+        duration: const Duration(milliseconds: 700),\n+        curve: Curves.easeInOutCubic,\n+        width: isMenuExpanded.value ? 280.w : 65.w, // تصغير العرض\n+        height: 50.h, // تصغير الارتفاع\n+        margin: EdgeInsets.only(right: 10.w),\n+        child: Stack(\n+          children: [\n+            // الخلفية المتحركة المحسنة\n+            AnimatedPositioned(\n+              duration: const Duration(milliseconds: 850),\n+              curve: Curves.easeOutBack,\n+              right: 0,\n+              top: 0,\n+              bottom: 0,\n+              width: isMenuExpanded.value ? 280.w : 55.w,\n+              child: Container(\n+                decoration: BoxDecoration(\n+                  borderRadius: BorderRadius.circular(25.r),\n+                  gradient: LinearGradient(\n+                    colors:\n+                        isMenuExpanded.value\n+                            ? [\n+                              theme.primaryColor.withValues(alpha: 0.08),\n+                              theme.primaryColor.withValues(alpha: 0.15),\n+                              theme.primaryColor.withValues(alpha: 0.22),\n+                              theme.primaryColor.withValues(alpha: 0.15),\n+                              theme.primaryColor.withValues(alpha: 0.08),\n+                            ]\n+                            : [\n+                              Colors.transparent,\n+                              Colors.transparent,\n+                              Colors.transparent,\n+                              Colors.transparent,\n+                              Colors.transparent,\n+                            ],\n+                    stops: const [0.0, 0.25, 0.5, 0.75, 1.0],\n+                  ),\n+                  border:\n+                      isMenuExpanded.value\n+                          ? Border.all(\n+                            color: theme.primaryColor.withValues(alpha: 0.2),\n+                            width: 1.w,\n+                          )\n+                          : null,\n+                  boxShadow:\n+                      isMenuExpanded.value\n+                          ? [\n+                            BoxShadow(\n+                              color: theme.primaryColor.withValues(alpha: 0.2),\n+                              blurRadius: 20.r,\n+                              offset: Offset(0, 8.h),\n+                              spreadRadius: 2.r,\n+                            ),\n+                            BoxShadow(\n+                              color: Colors.black.withValues(alpha: 0.05),\n+                              blurRadius: 10.r,\n+                              offset: Offset(0, 4.h),\n+                            ),\n+                          ]\n+                          : [],\n+                ),\n+              ),\n+            ),\n+\n+            // الإيقونات مع انيميشن الأفعى المحسن\n+            AnimatedPositioned(\n+              duration: const Duration(milliseconds: 600),\n+              curve: Curves.easeInOutBack,\n+              right: isMenuExpanded.value ? 12.w : 7.w,\n+              top: 6.h,\n+              bottom: 6.h,\n+              child: Row(\n+                mainAxisSize: MainAxisSize.min,\n+                children: [\n+                  // إيقونة البحث\n+                  _buildSnakeIcon(\n+                    icon: Icons.search_rounded,\n+                    index: 0,\n+                    isExpanded: isMenuExpanded.value,\n+                    theme: theme,\n+                    onTap: () {\n+                      Get.to(\n+                        () => SearchScreen(),\n+                        transition: Transition.downToUp,\n+                      );\n+                    },\n+                    tooltip: 'البحث',\n+                  ),\n+\n+                  // إيقونة فلاتر الأقسام\n+                  _buildSnakeIcon(\n+                    icon: Icons.category_rounded,\n+                    index: 1,\n+                    isExpanded: isMenuExpanded.value,\n+                    theme: theme,\n+                    isActive: showCategoryFilters.value,\n+                    onTap: () {\n+                      if (showCategoryFilters.value) {\n+                        try {\n+                          final EnhancedCategoryFilterController categoryCtrl =\n+                              Get.find<EnhancedCategoryFilterController>();\n+                          categoryCtrl.resetFilters();\n+                        } catch (e) {\n+                          debugPrint(\"تعذر العثور على متحكم فلاتر الأقسام\");\n+                        }\n+                      }\n+                      showCategoryFilters.value = !showCategoryFilters.value;\n+                    },\n+                    tooltip: 'فلاتر الأقسام',\n+                  ),\n+\n+                  // إيقونة الفلاتر المتقدمة\n+                  _buildSnakeIcon(\n+                    icon: Icons.tune_rounded,\n+                    index: 2,\n+                    isExpanded: isMenuExpanded.value,\n+                    theme: theme,\n+                    isActive: showFilters.value,\n+                    onTap: () {\n+                      if (showFilters.value) {\n+                        barcodeCtrl.clearAllNotifications();\n+                        if (brandCtrl.isBrandModeActive.value) {\n+                          brandCtrl.deactivateBrandMode();\n+                        }\n+                        if (barcodeCtrl.isBarcodeSearchActive.value) {\n+                          barcodeCtrl.deactivateBarcodeSearch();\n+                        }\n+                        if (barcodeCtrl.isScanning.value) {\n+                          barcodeCtrl.stopCameraScanning();\n+                        }\n+                        barcodeCtrl.clearCurrentBarcode();\n+                        brandCtrl.clearAllSelections();\n+                      }\n+                      showFilters.value = !showFilters.value;\n+                    },\n+                    tooltip: 'فلاتر البحث المتقدمة',\n+                  ),\n+\n+                  // إيقونة المفضلة\n+                  _buildSnakeIcon(\n+                    icon: Icons.favorite_rounded,\n+                    index: 3,\n+                    isExpanded: isMenuExpanded.value,\n+                    theme: theme,\n+                    onTap: () {\n+                      Get.to(() => FavoritesScreen());\n+                    },\n+                    tooltip: 'المفضلة',\n+                  ),\n+\n+                  // إيقونة الترتيب\n+                  _buildSnakeIcon(\n+                    icon: Icons.sort_rounded,\n+                    index: 4,\n+                    isExpanded: isMenuExpanded.value,\n+                    theme: theme,\n+                    onTap: () {\n+                      _showSortMenu(context, searchCtrl, theme);\n+                    },\n+                    tooltip: 'ترتيب حسب',\n+                  ),\n+\n+                  // مسافة إضافية قبل الإيقونة الرئيسية\n+                  SizedBox(width: 8.w),\n+\n+                  // الإيقونة الرئيسية (رأس الأفعى)\n+                  _buildMainIcon(isMenuExpanded, theme),\n+                ],\n+              ),\n+            ),\n+          ],\n+        ),\n+      ),\n+    );\n+  }\n+\n+  /// بناء إيقونة من إيقونات الأفعى\n+  Widget _buildSnakeIcon({\n+    required IconData icon,\n+    required int index,\n+    required bool isExpanded,\n+    required ThemeData theme,\n+    required VoidCallback onTap,\n+    required String tooltip,\n+    bool isActive = false,\n+  }) {\n+    return TweenAnimationBuilder<double>(\n+      duration: Duration(milliseconds: 400 + (index * 100)),\n+      curve: Curves.easeOutBack,\n+      tween: Tween<double>(begin: 0.0, end: isExpanded ? 1.0 : 0.0),\n+      builder: (context, value, child) {\n+        // تأكد من أن القيم في النطاق الصحيح\n+        final clampedValue = value.clamp(0.0, 1.0);\n+        final scale = (0.3 + (0.7 * clampedValue)).clamp(0.0, 1.0);\n+        final opacity = clampedValue;\n+\n+        return Transform.scale(\n+          scale: scale,\n+          child: Transform.translate(\n+            offset: Offset(-30.w * (1 - clampedValue), 0),\n+            child: Opacity(\n+              opacity: opacity,\n+              child: Container(\n+                width: 38.w, // تصغير الحجم\n+                height: 38.h,\n+                margin: EdgeInsets.only(\n+                  right: 6.w,\n+                ), // تقليل المسافة بين الإيقونات\n+                child: Tooltip(\n+                  message: tooltip,\n+                  preferBelow: false,\n+                  verticalOffset: 50.h,\n+                  decoration: BoxDecoration(\n+                    color: theme.primaryColor.withValues(alpha: 0.9),\n+                    borderRadius: BorderRadius.circular(10.r),\n+                    boxShadow: [\n+                      BoxShadow(\n+                        color: Colors.black.withValues(alpha: 0.15),\n+                        blurRadius: 6.r,\n+                        offset: Offset(0, 3.h),\n+                      ),\n+                    ],\n+                  ),\n+                  textStyle: TextStyle(\n+                    color: Colors.white,\n+                    fontSize: 11.sp,\n+                    fontWeight: FontWeight.w600,\n+                  ),\n+                  child: Material(\n+                    color: Colors.transparent,\n+                    elevation: isActive ? 6 : 3,\n+                    borderRadius: BorderRadius.circular(19.r),\n+                    shadowColor: theme.primaryColor.withValues(alpha: 0.25),\n+                    child: InkWell(\n+                      onTap: isExpanded ? onTap : null,\n+                      borderRadius: BorderRadius.circular(19.r),\n+                      splashColor: theme.primaryColor.withValues(alpha: 0.15),\n+                      highlightColor: theme.primaryColor.withValues(\n+                        alpha: 0.08,\n+                      ),\n+                      child: AnimatedContainer(\n+                        duration: const Duration(milliseconds: 300),\n+                        curve: Curves.easeInOutCubic,\n+                        decoration: BoxDecoration(\n+                          borderRadius: BorderRadius.circular(19.r),\n+                          gradient: LinearGradient(\n+                            colors:\n+                                isActive\n+                                    ? [\n+                                      theme.primaryColor.withValues(alpha: 0.2),\n+                                      theme.primaryColor.withValues(\n+                                        alpha: 0.12,\n+                                      ),\n+                                    ]\n+                                    : [\n+                                      Colors.white.withValues(alpha: 0.12),\n+                                      Colors.white.withValues(alpha: 0.06),\n+                                    ],\n+                            begin: Alignment.topLeft,\n+                            end: Alignment.bottomRight,\n+                          ),\n+                          border: Border.all(\n+                            color:\n+                                isActive\n+                                    ? theme.primaryColor.withValues(alpha: 0.6)\n+                                    : theme.primaryColor.withValues(alpha: 0.2),\n+                            width: isActive ? 2.w : 1.w,\n+                          ),\n+                          boxShadow: [\n+                            BoxShadow(\n+                              color:\n+                                  isActive\n+                                      ? theme.primaryColor.withValues(\n+                                        alpha: 0.25,\n+                                      )\n+                                      : theme.primaryColor.withValues(\n+                                        alpha: 0.1,\n+                                      ),\n+                              blurRadius: isActive ? 8.r : 5.r,\n+                              offset: Offset(0, isActive ? 4.h : 2.h),\n+                              spreadRadius: isActive ? 0.5.r : 0,\n+                            ),\n+                            // إضافة لمعان خفيف للتأثير الجمالي\n+                            BoxShadow(\n+                              color: Colors.white.withValues(alpha: 0.03),\n+                              blurRadius: 1.r,\n+                              offset: Offset(0, -1.h),\n+                            ),\n+                          ],\n+                        ),\n+                        child: Center(\n+                          child: AnimatedContainer(\n+                            duration: const Duration(milliseconds: 250),\n+                            padding: EdgeInsets.all(isActive ? 10.w : 9.w),\n+                            child: Icon(\n+                              icon,\n+                              color:\n+                                  isActive\n+                                      ? theme.primaryColor\n+                                      : theme.appBarTheme.foregroundColor\n+                                          ?.withValues(alpha: 0.8),\n+                              size:\n+                                  isActive\n+                                      ? 18.sp\n+                                      : 16.sp, // تصغير حجم الإيقونة\n+                            ),\n+                          ),\n+                        ),\n+                      ),\n+                    ),\n+                  ),\n+                ),\n+              ),\n+            ),\n+          ),\n+        );\n+      },\n+    );\n+  }\n+\n+  /// بناء الإيقونة الرئيسية (رأس الأفعى)\n+  Widget _buildMainIcon(RxBool isMenuExpanded, ThemeData theme) {\n+    return TweenAnimationBuilder<double>(\n+      duration: const Duration(milliseconds: 550),\n+      curve: Curves.easeOutBack,\n+      tween: Tween<double>(begin: 1.0, end: isMenuExpanded.value ? 1.2 : 1.0),\n+      builder: (context, scale, child) {\n+        return Transform.scale(\n+          scale: scale,\n+          child: Container(\n+            width: 42.w, // تصغير الحجم\n+            height: 42.h,\n+            margin: EdgeInsets.only(left: 3.w), // تقليل المسافة\n+            child: Material(\n+              elevation: isMenuExpanded.value ? 10 : 5,\n+              borderRadius: BorderRadius.circular(21.r),\n+              shadowColor: theme.primaryColor.withValues(alpha: 0.3),\n+              child: InkWell(\n+                onTap: () {\n+                  isMenuExpanded.value = !isMenuExpanded.value;\n+                },\n+                borderRadius: BorderRadius.circular(21.r),\n+                splashColor: Colors.white.withValues(alpha: 0.25),\n+                highlightColor: Colors.white.withValues(alpha: 0.08),\n+                child: AnimatedContainer(\n+                  duration: const Duration(milliseconds: 450),\n+                  curve: Curves.easeInOutCubic,\n+                  decoration: BoxDecoration(\n+                    borderRadius: BorderRadius.circular(21.r),\n+                    gradient: LinearGradient(\n+                      colors:\n+                          isMenuExpanded.value\n+                              ? [\n+                                theme.primaryColor,\n+                                theme.primaryColor.withValues(alpha: 0.8),\n+                                theme.primaryColor.withValues(alpha: 0.65),\n+                              ]\n+                              : [\n+                                theme.primaryColor.withValues(alpha: 0.1),\n+                                theme.primaryColor.withValues(alpha: 0.15),\n+                                theme.primaryColor.withValues(alpha: 0.2),\n+                              ],\n+                      begin: Alignment.topLeft,\n+                      end: Alignment.bottomRight,\n+                      stops: const [0.0, 0.5, 1.0],\n+                    ),\n+                    border: Border.all(\n+                      color:\n+                          isMenuExpanded.value\n+                              ? Colors.white.withValues(alpha: 0.25)\n+                              : theme.primaryColor.withValues(alpha: 0.5),\n+                      width: isMenuExpanded.value ? 2.w : 1.5.w,\n+                    ),\n+                    boxShadow: [\n+                      BoxShadow(\n+                        color: theme.primaryColor.withValues(\n+                          alpha: isMenuExpanded.value ? 0.3 : 0.15,\n+                        ),\n+                        blurRadius: isMenuExpanded.value ? 15.r : 8.r,\n+                        offset: Offset(0, isMenuExpanded.value ? 6.h : 4.h),\n+                        spreadRadius: isMenuExpanded.value ? 1.r : 0.5.r,\n+                      ),\n+                      // ظل إضافي للعمق\n+                      BoxShadow(\n+                        color: Colors.black.withValues(alpha: 0.08),\n+                        blurRadius: 6.r,\n+                        offset: Offset(0, 3.h),\n+                      ),\n+                    ],\n+                  ),\n+                  child: Stack(\n+                    children: [\n+                      // خلفية مضيئة للتأثير\n+                      if (isMenuExpanded.value)\n+                        Positioned.fill(\n+                          child: AnimatedOpacity(\n+                            duration: const Duration(milliseconds: 350),\n+                            opacity: isMenuExpanded.value ? 0.12 : 0.0,\n+                            child: Container(\n+                              decoration: BoxDecoration(\n+                                borderRadius: BorderRadius.circular(21.r),\n+                                gradient: RadialGradient(\n+                                  colors: [\n+                                    Colors.white.withValues(alpha: 0.25),\n+                                    Colors.transparent,\n+                                  ],\n+                                  center: const Alignment(-0.3, -0.3),\n+                                ),\n+                              ),\n+                            ),\n+                          ),\n+                        ),\n+\n+                      // الإيقونة الرئيسية\n+                      Center(\n+                        child: AnimatedRotation(\n+                          duration: const Duration(milliseconds: 500),\n+                          turns: isMenuExpanded.value ? 0.5 : 0,\n+                          child: TweenAnimationBuilder<double>(\n+                            duration: const Duration(milliseconds: 350),\n+                            tween: Tween<double>(\n+                              begin: 1.0,\n+                              end: isMenuExpanded.value ? 1.05 : 1.0,\n+                            ),\n+                            builder: (context, iconScale, child) {\n+                              return Transform.scale(\n+                                scale: iconScale,\n+                                child: Icon(\n+                                  isMenuExpanded.value\n+                                      ? Icons.close_rounded\n+                                      : Icons.apps_rounded,\n+                                  color:\n+                                      isMenuExpanded.value\n+                                          ? Colors.white\n+                                          : theme.primaryColor,\n+                                  size: 22.sp, // تصغير حجم الإيقونة\n+                                  shadows:\n+                                      isMenuExpanded.value\n+                                          ? [\n+                                            Shadow(\n+                                              color: Colors.black.withValues(\n+                                                alpha: 0.25,\n+                                              ),\n+                                              offset: const Offset(0.5, 0.5),\n+                                              blurRadius: 1.5,\n+                                            ),\n+                                          ]\n+                                          : [],\n+                                ),\n+                              );\n+                            },\n+                          ),\n+                        ),\n+                      ),\n+                    ],\n+                  ),\n+                ),\n+              ),\n+            ),\n+          ),\n+        );\n+      },\n+    );\n+  }\n+\n+  /// عرض قائمة الترتيب\n+  void _showSortMenu(\n+    BuildContext context,\n+    GetSearchController searchCtrl,\n+    ThemeData theme,\n+  ) {\n+    showModalBottomSheet(\n+      context: context,\n+      backgroundColor: Colors.transparent,\n+      builder:\n+          (context) => Container(\n+            margin: EdgeInsets.all(16.w),\n+            decoration: BoxDecoration(\n+              color: theme.cardColor,\n+              borderRadius: BorderRadius.circular(25.r),\n+              boxShadow: [\n+                BoxShadow(\n+                  color: theme.primaryColor.withValues(alpha: 0.2),\n+                  blurRadius: 20.r,\n+                  offset: Offset(0, 10.h),\n+                ),\n+              ],\n+            ),\n+            child: Column(\n+              mainAxisSize: MainAxisSize.min,\n+              children: [\n+                Container(\n+                  width: 50.w,\n+                  height: 5.h,\n+                  margin: EdgeInsets.only(top: 10.h),\n+                  decoration: BoxDecoration(\n+                    color: Colors.grey[300],\n+                    borderRadius: BorderRadius.circular(2.5.r),\n+                  ),\n+                ),\n+                Padding(\n+                  padding: EdgeInsets.all(20.w),\n+                  child: Column(\n+                    children: [\n+                      Text(\n+                        'ترتيب حسب',\n+                        style: TextStyle(\n+                          fontSize: 18.sp,\n+                          fontWeight: FontWeight.bold,\n+                          color: theme.primaryColor,\n+                        ),\n+                      ),\n+                      SizedBox(height: 15.h),\n+                      ...SortOption.values.map(\n+                        (option) => Obx(\n+                          () => Container(\n+                            margin: EdgeInsets.only(bottom: 8.h),\n+                            child: Material(\n+                              color: Colors.transparent,\n+                              child: InkWell(\n+                                onTap: () {\n+                                  searchCtrl.changeSortOption(option);\n+                                  Navigator.pop(context);\n+                                },\n+                                borderRadius: BorderRadius.circular(15.r),\n+                                child: Container(\n+                                  padding: EdgeInsets.symmetric(\n+                                    vertical: 12.h,\n+                                    horizontal: 16.w,\n+                                  ),\n+                                  decoration: BoxDecoration(\n+                                    borderRadius: BorderRadius.circular(15.r),\n+                                    color:\n+                                        searchCtrl.currentSortOption.value ==\n+                                                option\n+                                            ? theme.primaryColor.withValues(\n+                                              alpha: 0.1,\n+                                            )\n+                                            : Colors.transparent,\n+                                    border: Border.all(\n+                                      color:\n+                                          searchCtrl.currentSortOption.value ==\n+                                                  option\n+                                              ? theme.primaryColor\n+                                              : Colors.transparent,\n+                                      width: 2.w,\n+                                    ),\n+                                  ),\n+                                  child: Row(\n+                                    children: [\n+                                      Icon(\n+                                        searchCtrl.currentSortOption.value ==\n+                                                option\n+                                            ? Icons.radio_button_checked\n+                                            : Icons.radio_button_unchecked,\n+                                        color: theme.primaryColor,\n+                                        size: 20.sp,\n+                                      ),\n+                                      SizedBox(width: 12.w),\n+                                      Text(\n+                                        option.label,\n+                                        style: TextStyle(\n+                                          fontSize: 16.sp,\n+                                          fontWeight:\n+                                              searchCtrl\n+                                                          .currentSortOption\n+                                                          .value ==\n+                                                      option\n+                                                  ? FontWeight.bold\n+                                                  : FontWeight.normal,\n+                                          color:\n+                                              theme.textTheme.bodyLarge?.color,\n+                                        ),\n+                                      ),\n+                                    ],\n+                                  ),\n+                                ),\n+                              ),\n+                            ),\n+                          ),\n+                        ),\n+                      ),\n+                    ],\n+                  ),\n+                ),\n+              ],\n+            ),\n+          ),\n+    );\n+  }\n }\n \n // --- شاشة البحث المنفصلة (مثال بسيط) ---\n class SearchScreen extends StatelessWidget {\n"
                },
                {
                    "date": 1752945030018,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -612,11 +612,14 @@\n     return Obx(\n       () => AnimatedContainer(\n         duration: const Duration(milliseconds: 700),\n         curve: Curves.easeInOutCubic,\n-        width: isMenuExpanded.value ? 280.w : 65.w, // تصغير العرض\n-        height: 50.h, // تصغير الارتفاع\n-        margin: EdgeInsets.only(right: 10.w),\n+        width:\n+            isMenuExpanded.value\n+                ? 320.w\n+                : 85.w, // زيادة العرض لاستيعاب جميع الإيقونات\n+        height: 50.h,\n+        margin: EdgeInsets.only(right: 8.w),\n         child: Stack(\n           children: [\n             // الخلفية المتحركة المحسنة\n             AnimatedPositioned(\n@@ -624,9 +627,12 @@\n               curve: Curves.easeOutBack,\n               right: 0,\n               top: 0,\n               bottom: 0,\n-              width: isMenuExpanded.value ? 280.w : 55.w,\n+              width:\n+                  isMenuExpanded.value\n+                      ? 320.w\n+                      : 75.w, // زيادة عرض الخلفية أيضاً\n               child: Container(\n                 decoration: BoxDecoration(\n                   borderRadius: BorderRadius.circular(25.r),\n                   gradient: LinearGradient(\n@@ -678,9 +684,9 @@\n             // الإيقونات مع انيميشن الأفعى المحسن\n             AnimatedPositioned(\n               duration: const Duration(milliseconds: 600),\n               curve: Curves.easeInOutBack,\n-              right: isMenuExpanded.value ? 12.w : 7.w,\n+              right: isMenuExpanded.value ? 15.w : 8.w, // تحسين الموضع\n               top: 6.h,\n               bottom: 6.h,\n               child: Row(\n                 mainAxisSize: MainAxisSize.min,\n@@ -773,10 +779,9 @@\n                     tooltip: 'ترتيب حسب',\n                   ),\n \n                   // مسافة إضافية قبل الإيقونة الرئيسية\n-                  SizedBox(width: 8.w),\n-\n+                  SizedBox(width: 10.w), // زيادة المسافة قليلاً\n                   // الإيقونة الرئيسية (رأس الأفعى)\n                   _buildMainIcon(isMenuExpanded, theme),\n                 ],\n               ),\n@@ -942,9 +947,11 @@\n           scale: scale,\n           child: Container(\n             width: 42.w, // تصغير الحجم\n             height: 42.h,\n-            margin: EdgeInsets.only(left: 3.w), // تقليل المسافة\n+            margin: EdgeInsets.only(\n+              left: 5.w,\n+            ), // زيادة المسافة قليلاً لضمان الظهور الكامل\n             child: Material(\n               elevation: isMenuExpanded.value ? 10 : 5,\n               borderRadius: BorderRadius.circular(21.r),\n               shadowColor: theme.primaryColor.withValues(alpha: 0.3),\n"
                },
                {
                    "date": 1752949592545,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -120,16 +120,19 @@\n                 if (docs.isEmpty) {\n                   // لا يوجد عروض: لا ترجع أي ويدجت (لا تأخذ أي مساحة)\n                   return SizedBox.shrink();\n                 }\n-                // يوجد عروض: أظهر ويدجت العروض\n-                return OffersCarouselWidget();\n+                // يوجد عروض: أظهر ويدجت العروض مع Divider\n+                return Column(\n+                  children: [\n+                    OffersCarouselWidget(),\n+                    SizedBox(height: hi / 70),\n+                    const Divider(),\n+                  ],\n+                );\n               },\n             ),\n \n-            SizedBox(height: hi / 70),\n-            const Divider(),\n-\n             // فلاتر الأقسام الرئيسية والفرعية مع انيميشن احترافي\n             Obx(\n               () => AnimatedSize(\n                 duration: const Duration(milliseconds: 600),\n"
                },
                {
                    "date": 1753065306983,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,9 +44,8 @@\n     final RxBool showCategoryFilters = false.obs;\n     // متحكم انيميشن الإيقونات الاحترافي\n     final RxBool isMenuExpanded = false.obs;\n \n-    double hi = MediaQuery.of(context).size.height;\n     final theme = Theme.of(context);\n \n     return Scaffold(\n       backgroundColor: theme.scaffoldBackgroundColor,\n@@ -101,9 +100,9 @@\n           await Future.delayed(Duration(seconds: 1));\n         },\n         child: ListView(\n           children: [\n-            SizedBox(height: hi / 70),\n+            SizedBox(height: 12.h), // استخدام ScreenUtil بدلاً من hi / 70\n             // عروض - مرر الـ pageController من searchController\n             StreamBuilder(\n               stream:\n                   FirebaseFirestore.instance\n@@ -124,9 +123,9 @@\n                 // يوجد عروض: أظهر ويدجت العروض مع Divider\n                 return Column(\n                   children: [\n                     OffersCarouselWidget(),\n-                    SizedBox(height: hi / 70),\n+                    SizedBox(height: 12.h), // استخدام ScreenUtil\n                     const Divider(),\n                   ],\n                 );\n               },\n@@ -550,10 +549,9 @@\n             ),\n \n             // ويدجت البحث من خلال البراند والباركود\n             // تم نقلها للأعلى في الفلاتر المخفية\n-            SizedBox(height: hi / 70),\n-\n+            SizedBox(height: 12.h), // استخدام ScreenUtil\n             // شبكة المنتجات مع الفلترة المحسنة\n             Obx(() {\n               String filterKey = 'all_items'; // القيمة الافتراضية\n \n@@ -593,9 +591,11 @@\n \n               return ProductGridWidgetOption(selectedSubtypeKey: filterKey);\n             }),\n \n-            SizedBox(height: 20.h),\n+            SizedBox(\n+              height: 20.h,\n+            ), // استخدام ScreenUtil بدلاً من القيمة الثابتة\n           ],\n         ),\n       ),\n     );\n"
                },
                {
                    "date": 1753068346602,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,8 +8,9 @@\n import '../widgets/simple_main_categories_widget.dart';\n import '../controllers/brand_filter_controller.dart';\n import '../controllers/barcode_filter_controller.dart';\n import '../widgets/brand_filter_widget.dart';\n+import '../class/FiltersGridWidget.dart';\n \n import '../Get-Controllar/GetSerchController.dart';\n import '../class/FavoritesScreen.dart';\n import '../class/OffersCarouselWidget.dart';\n@@ -41,8 +42,10 @@\n     // إضافة متحكم للفلاتر مع حالة الإظهار/الإخفاء\n     final RxBool showFilters = false.obs;\n     // إضافة متحكم منفصل لفلاتر الأقسام الرئيسية والفرعية\n     final RxBool showCategoryFilters = false.obs;\n+    // إضافة متحكم لعرض الفلاتر بدلاً من المنتجات\n+    final RxBool showFiltersGrid = false.obs;\n     // متحكم انيميشن الإيقونات الاحترافي\n     final RxBool isMenuExpanded = false.obs;\n \n     final theme = Theme.of(context);\n@@ -79,8 +82,78 @@\n             theme.appBarTheme.backgroundColor ?? theme.scaffoldBackgroundColor,\n         elevation: theme.appBarTheme.elevation ?? 0,\n         foregroundColor:\n             theme.appBarTheme.foregroundColor ?? theme.colorScheme.primary,\n+        leading:\n+        // إيقونة عرض جميع الفلاتر (خارج نظام الإيقونات الرئيسي)\n+        Obx(\n+          () => Tooltip(\n+            message:\n+                showFiltersGrid.value\n+                    ? 'إخفاء الفلاتر وعرض المنتجات'\n+                    : 'عرض جميع الفلاتر المتاحة',\n+            preferBelow: true,\n+            child: Container(\n+              margin: EdgeInsets.all(8.w),\n+              child: Material(\n+                elevation: showFiltersGrid.value ? 5 : 3,\n+                borderRadius: BorderRadius.circular(12.r),\n+                shadowColor: theme.primaryColor.withOpacity(0.3),\n+                child: InkWell(\n+                  onTap: () {\n+                    showFiltersGrid.value = !showFiltersGrid.value;\n+                    debugPrint(\n+                      '🔄 تبديل عرض الفلاتر: ${showFiltersGrid.value ? 'مرئي' : 'مخفي'}',\n+                    );\n+                  },\n+                  borderRadius: BorderRadius.circular(12.r),\n+                  splashColor: theme.primaryColor.withOpacity(0.1),\n+                  highlightColor: theme.primaryColor.withOpacity(0.05),\n+                  child: AnimatedContainer(\n+                    duration: const Duration(milliseconds: 300),\n+                    decoration: BoxDecoration(\n+                      borderRadius: BorderRadius.circular(12.r),\n+                      gradient: LinearGradient(\n+                        colors:\n+                            showFiltersGrid.value\n+                                ? [\n+                                  theme.primaryColor.withOpacity(0.2),\n+                                  theme.primaryColor.withOpacity(0.1),\n+                                ]\n+                                : [\n+                                  theme.primaryColor.withOpacity(0.1),\n+                                  theme.primaryColor.withOpacity(0.05),\n+                                ],\n+                        begin: Alignment.topLeft,\n+                        end: Alignment.bottomRight,\n+                      ),\n+                      border: Border.all(\n+                        color:\n+                            showFiltersGrid.value\n+                                ? theme.primaryColor.withOpacity(0.4)\n+                                : theme.primaryColor.withOpacity(0.2),\n+                        width: 1.w,\n+                      ),\n+                    ),\n+                    child: Center(\n+                      child: AnimatedSwitcher(\n+                        duration: const Duration(milliseconds: 250),\n+                        child: Icon(\n+                          showFiltersGrid.value\n+                              ? Icons.grid_off_rounded\n+                              : Icons.grid_view_rounded,\n+                          key: ValueKey(showFiltersGrid.value),\n+                          color: theme.primaryColor,\n+                          size: 22.sp,\n+                        ),\n+                      ),\n+                    ),\n+                  ),\n+                ),\n+              ),\n+            ),\n+          ),\n+        ),\n         actions: [\n           // نظام الإيقونات الاحترافي الجديد\n           _buildAdvancedIconSystem(\n             context,\n@@ -550,10 +623,16 @@\n \n             // ويدجت البحث من خلال البراند والباركود\n             // تم نقلها للأعلى في الفلاتر المخفية\n             SizedBox(height: 12.h), // استخدام ScreenUtil\n-            // شبكة المنتجات مع الفلترة المحسنة\n+            // شبكة المنتجات أو الفلاتر مع الفلترة المحسنة\n             Obx(() {\n+              // إذا كان عرض الفلاتر مفعل، أظهر الفلاتر بدلاً من المنتجات\n+              if (showFiltersGrid.value) {\n+                return const FiltersGridWidget();\n+              }\n+\n+              // عرض المنتجات العادي\n               String filterKey = 'all_items'; // القيمة الافتراضية\n \n               if (barcodeCtrl.hasActiveFilter) {\n                 filterKey = barcodeCtrl.getFilterKey();\n"
                },
                {
                    "date": 1753149650147,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,8 +9,9 @@\n import '../controllers/brand_filter_controller.dart';\n import '../controllers/barcode_filter_controller.dart';\n import '../widgets/brand_filter_widget.dart';\n import '../class/FiltersGridWidget.dart';\n+import '../controllers/filters_view_controller.dart';\n \n import '../Get-Controllar/GetSerchController.dart';\n import '../class/FavoritesScreen.dart';\n import '../class/OffersCarouselWidget.dart';\n@@ -38,14 +39,17 @@\n     final BarcodeFilterController barcodeCtrl = Get.put(\n       BarcodeFilterController(),\n     );\n \n+    // إنشاء controller منفصل لإدارة عرض الفلاتر\n+    final FiltersViewController filtersViewController = Get.put(\n+      FiltersViewController(),\n+    );\n+\n     // إضافة متحكم للفلاتر مع حالة الإظهار/الإخفاء\n     final RxBool showFilters = false.obs;\n     // إضافة متحكم منفصل لفلاتر الأقسام الرئيسية والفرعية\n     final RxBool showCategoryFilters = false.obs;\n-    // إضافة متحكم لعرض الفلاتر بدلاً من المنتجات\n-    final RxBool showFiltersGrid = false.obs;\n     // متحكم انيميشن الإيقونات الاحترافي\n     final RxBool isMenuExpanded = false.obs;\n \n     final theme = Theme.of(context);\n@@ -87,24 +91,21 @@\n         // إيقونة عرض جميع الفلاتر (خارج نظام الإيقونات الرئيسي)\n         Obx(\n           () => Tooltip(\n             message:\n-                showFiltersGrid.value\n+                filtersViewController.showFiltersGrid.value\n                     ? 'إخفاء الفلاتر وعرض المنتجات'\n                     : 'عرض جميع الفلاتر المتاحة',\n             preferBelow: true,\n             child: Container(\n               margin: EdgeInsets.all(8.w),\n               child: Material(\n-                elevation: showFiltersGrid.value ? 5 : 3,\n+                elevation: filtersViewController.showFiltersGrid.value ? 5 : 3,\n                 borderRadius: BorderRadius.circular(12.r),\n                 shadowColor: theme.primaryColor.withOpacity(0.3),\n                 child: InkWell(\n                   onTap: () {\n-                    showFiltersGrid.value = !showFiltersGrid.value;\n-                    debugPrint(\n-                      '🔄 تبديل عرض الفلاتر: ${showFiltersGrid.value ? 'مرئي' : 'مخفي'}',\n-                    );\n+                    filtersViewController.toggleFiltersView();\n                   },\n                   borderRadius: BorderRadius.circular(12.r),\n                   splashColor: theme.primaryColor.withOpacity(0.1),\n                   highlightColor: theme.primaryColor.withOpacity(0.05),\n@@ -113,9 +114,9 @@\n                     decoration: BoxDecoration(\n                       borderRadius: BorderRadius.circular(12.r),\n                       gradient: LinearGradient(\n                         colors:\n-                            showFiltersGrid.value\n+                            filtersViewController.showFiltersGrid.value\n                                 ? [\n                                   theme.primaryColor.withOpacity(0.2),\n                                   theme.primaryColor.withOpacity(0.1),\n                                 ]\n@@ -127,9 +128,9 @@\n                         end: Alignment.bottomRight,\n                       ),\n                       border: Border.all(\n                         color:\n-                            showFiltersGrid.value\n+                            filtersViewController.showFiltersGrid.value\n                                 ? theme.primaryColor.withOpacity(0.4)\n                                 : theme.primaryColor.withOpacity(0.2),\n                         width: 1.w,\n                       ),\n@@ -137,12 +138,14 @@\n                     child: Center(\n                       child: AnimatedSwitcher(\n                         duration: const Duration(milliseconds: 250),\n                         child: Icon(\n-                          showFiltersGrid.value\n+                          filtersViewController.showFiltersGrid.value\n                               ? Icons.grid_off_rounded\n                               : Icons.grid_view_rounded,\n-                          key: ValueKey(showFiltersGrid.value),\n+                          key: ValueKey(\n+                            filtersViewController.showFiltersGrid.value,\n+                          ),\n                           color: theme.primaryColor,\n                           size: 22.sp,\n                         ),\n                       ),\n@@ -625,13 +628,27 @@\n             // تم نقلها للأعلى في الفلاتر المخفية\n             SizedBox(height: 12.h), // استخدام ScreenUtil\n             // شبكة المنتجات أو الفلاتر مع الفلترة المحسنة\n             Obx(() {\n+              debugPrint(\n+                '🔴 Obx rebuild - showFiltersGrid: ${filtersViewController.showFiltersGrid.value}',\n+              );\n+\n               // إذا كان عرض الفلاتر مفعل، أظهر الفلاتر بدلاً من المنتجات\n-              if (showFiltersGrid.value) {\n-                return const FiltersGridWidget();\n+              if (filtersViewController.showFiltersGrid.value) {\n+                debugPrint('🔴 شرط الفلاتر صحيح - سيتم عرض FiltersGridWidget');\n+                debugPrint(\n+                  '🔴 🚨 CRITICAL: About to return FiltersGridWidget()',\n+                );\n+                final widget = FiltersGridWidget();\n+                debugPrint(\n+                  '🔴 🚨 CRITICAL: FiltersGridWidget created successfully',\n+                );\n+                return widget;\n               }\n \n+              debugPrint('🔴 شرط الفلاتر خطأ - سيتم عرض المنتجات العادية');\n+\n               // عرض المنتجات العادي\n               String filterKey = 'all_items'; // القيمة الافتراضية\n \n               if (barcodeCtrl.hasActiveFilter) {\n"
                }
            ],
            "date": 1752859416407,
            "name": "Commit-0",
            "content": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:get/get.dart';\n\nimport '../../../XXX/xxx_firebase.dart';\nimport '../controllers/enhanced_category_filter_controller.dart';\nimport '../widgets/simple_main_categories_widget.dart';\nimport '../controllers/brand_filter_controller.dart';\nimport '../controllers/barcode_filter_controller.dart';\nimport '../widgets/brand_filter_widget.dart';\n\nimport '../Get-Controllar/GetSerchController.dart';\nimport '../class/FavoritesScreen.dart';\nimport '../class/OffersCarouselWidget.dart';\nimport '../class/ProductGridWidget.dart';\nimport '../class/SearchResultsListWidget.dart';\n// النظام المبسط تم حذفه واستبداله بالنظام المحسن\n\nclass HomeScreen extends StatelessWidget {\n  const HomeScreen({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    // الحصول على المتحكمات (تفترض أنه تم حقنها مسبقًا)\n    final GetSearchController searchCtrl = Get.find<GetSearchController>();\n    \n    // محاولة استخدام النظام الجديد، وفي حالة عدم وجوده، استخدم النظام المبسط\n    try {\n      Get.find<EnhancedCategoryFilterController>();\n    } catch (e) {\n      debugPrint(\"النظام الجديد غير متاح، سيتم استخدام النظام المبسط\");\n      Get.put(EnhancedCategoryFilterController());\n    }\n    \n    final BrandFilterController brandCtrl = Get.put(BrandFilterController());\n    final BarcodeFilterController barcodeCtrl = Get.put(BarcodeFilterController());\n    \n    // إضافة متحكم للفلاتر مع حالة الإظهار/الإخفاء\n    final RxBool showFilters = false.obs;\n\n    double hi = MediaQuery.of(context).size.height;\n    final theme = Theme.of(context);\n\n    return Scaffold(\n      backgroundColor: theme.scaffoldBackgroundColor,\n      appBar: AppBar(\n        title: Text(\"الصفحة الرئيسية\", style: TextStyle(color: theme.textTheme.titleLarge?.color)),\n        backgroundColor: theme.appBarTheme.backgroundColor ?? theme.scaffoldBackgroundColor,\n        elevation: theme.appBarTheme.elevation ?? 0,\n        foregroundColor: theme.appBarTheme.foregroundColor ?? theme.colorScheme.primary,\n        actions: [\n          // --- أيقونة البحث ---\n          IconButton(\n            icon: Icon(Icons.search),\n            tooltip: 'بحث',\n            onPressed: () {\n              Get.to(() => SearchScreen(), transition: Transition.downToUp );\n            },\n          ),\n\n          // --- أيقونة الفلاتر الجديدة ---\n          Obx(() => AnimatedContainer(\n            duration: const Duration(milliseconds: 300),\n            margin: const EdgeInsets.only(right: 8),\n            decoration: BoxDecoration(\n              borderRadius: BorderRadius.circular(12),\n              color: showFilters.value \n                  ? theme.primaryColor.withValues(alpha: 0.1)\n                  : Colors.transparent,\n            ),\n            child: IconButton(\n              icon: AnimatedRotation(\n                duration: const Duration(milliseconds: 300),\n                turns: showFilters.value ? 0.5 : 0,\n                child: Icon(\n                  Icons.tune,\n                  color: showFilters.value \n                      ? theme.primaryColor \n                      : theme.appBarTheme.foregroundColor,\n                ),\n              ),\n              tooltip: 'فلاتر البحث',\n              onPressed: () {\n                showFilters.value = !showFilters.value;\n              },\n            ),\n          )),\n\n          // --- أيقونة البحث بالباركود ---\n          Obx(() => IconButton(\n            icon: Icon(\n              Icons.qr_code_scanner,\n              color: barcodeCtrl.hasActiveFilter \n                  ? theme.colorScheme.primary \n                  : theme.appBarTheme.foregroundColor,\n            ),\n            tooltip: 'البحث بالباركود',\n            onPressed: () {\n              if (barcodeCtrl.hasActiveFilter) {\n                barcodeCtrl.clearCurrentBarcode();\n              } else {\n                if (brandCtrl.isBrandModeActive.value) {\n                  brandCtrl.deactivateBrandMode();\n                }\n                barcodeCtrl.activateBarcodeSearch();\n              }\n            },\n          )),\n\n          IconButton(\n            icon: Icon(Icons.favorite_border_rounded),\n            tooltip: 'المفضلة',\n            onPressed: () {\n              Get.to(() => FavoritesScreen());\n            },\n          ),\n          \n          // --- أيقونة الترتيب ---\n          PopupMenuButton<SortOption>(\n            icon: Icon(Icons.sort),\n            tooltip: 'ترتيب حسب',\n            onSelected: (SortOption result) {\n              searchCtrl.changeSortOption(result);\n            },\n            itemBuilder: (BuildContext context) => <PopupMenuEntry<SortOption>>[\n              for (final option in SortOption.values)\n                PopupMenuItem<SortOption>(\n                  value: option,\n                  child: Obx(() => Text(\n                    option.label,\n                    style: TextStyle(\n                      fontWeight: searchCtrl.currentSortOption.value == option\n                          ? FontWeight.bold\n                          : FontWeight.normal,\n                    ),\n                  )),\n                ),\n            ],\n            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),\n          ),\n        ],\n      ),\n      body: RefreshIndicator(\n        onRefresh: () async {\n          debugPrint(\"Refreshing...\");\n          await Future.delayed(Duration(seconds: 1));\n        },\n        child: ListView(\n          children: [\n             SizedBox(height: hi/70),\n            // عروض - مرر الـ pageController من searchController\n            StreamBuilder(\n              stream: FirebaseFirestore.instance\n                  .collection(FirebaseX.offersCollection)\n                  .where('appName', isEqualTo: FirebaseX.appName)\n                  .limit(10)\n                  .snapshots(),\n              builder: (context, snapshot) {\n                if (snapshot.connectionState == ConnectionState.waiting) {\n                  // يمكنك إرجاع شيمر أو لا شيء حسب رغبتك\n                  return SizedBox.shrink();\n                }\n                final docs = snapshot.data?.docs ?? [];\n                if (docs.isEmpty) {\n                  // لا يوجد عروض: لا ترجع أي ويدجت (لا تأخذ أي مساحة)\n                  return SizedBox.shrink();\n                }\n                // يوجد عروض: أظهر ويدجت العروض\n                return OffersCarouselWidget();\n              },\n            ),\n\n             SizedBox(height: hi/70),\n            const Divider(),\n\n            // الفلاتر المخفية/المظهرة مع انيميشن احترافي\n            Obx(() => AnimatedSize(\n              duration: const Duration(milliseconds: 500),\n              curve: Curves.easeInOutCubic,\n              child: AnimatedContainer(\n                duration: const Duration(milliseconds: 400),\n                height: showFilters.value ? null : 0,\n                child: showFilters.value \n                    ? AnimatedOpacity(\n                        duration: const Duration(milliseconds: 600),\n                        opacity: showFilters.value ? 1.0 : 0.0,\n                        child: SlideTransition(\n                          position: Tween<Offset>(\n                            begin: const Offset(0, -0.3),\n                            end: Offset.zero,\n                          ).animate(CurvedAnimation(\n                            parent: AlwaysStoppedAnimation(1.0),\n                            curve: Curves.easeOutBack,\n                          )),\n                          child: Container(\n                            margin: const EdgeInsets.symmetric(horizontal: 16),\n                            padding: const EdgeInsets.all(16),\n                            decoration: BoxDecoration(\n                              color: theme.cardColor,\n                              borderRadius: BorderRadius.circular(20),\n                              boxShadow: [\n                                BoxShadow(\n                                  color: theme.primaryColor.withValues(alpha: 0.1),\n                                  blurRadius: 20,\n                                  offset: const Offset(0, 10),\n                                  spreadRadius: 2,\n                                ),\n                                BoxShadow(\n                                  color: Colors.black.withValues(alpha: 0.05),\n                                  blurRadius: 10,\n                                  offset: const Offset(0, 5),\n                                ),\n                              ],\n                            ),\n                            child: Column(\n                              children: [\n                                // عنوان القسم مع رسوم متحركة\n                                Row(\n                                  children: [\n                                    AnimatedContainer(\n                                      duration: const Duration(milliseconds: 400),\n                                      width: 40,\n                                      height: 40,\n                                      decoration: BoxDecoration(\n                                        color: theme.primaryColor.withValues(alpha: 0.1),\n                                        borderRadius: BorderRadius.circular(12),\n                                      ),\n                                      child: Icon(\n                                        Icons.filter_alt,\n                                        color: theme.primaryColor,\n                                        size: 24,\n                                      ),\n                                    ),\n                                    const SizedBox(width: 12),\n                                    Text(\n                                      'فلاتر البحث المتقدمة',\n                                      style: TextStyle(\n                                        fontSize: 18,\n                                        fontWeight: FontWeight.bold,\n                                        color: theme.primaryColor,\n                                      ),\n                                    ),\n                                    const Spacer(),\n                                    // زر الإغلاق\n                                    InkWell(\n                                      onTap: () => showFilters.value = false,\n                                      borderRadius: BorderRadius.circular(20),\n                                      child: Container(\n                                        padding: const EdgeInsets.all(8),\n                                        child: Icon(\n                                          Icons.keyboard_arrow_up,\n                                          color: theme.primaryColor,\n                                        ),\n                                      ),\n                                    ),\n                                  ],\n                                ),\n                                \n                                const SizedBox(height: 16),\n                                \n                                // محتوى الفلاتر\n                                const BrandFilterWidget(),\n                              ],\n                            ),\n                          ),\n                        ),\n                      )\n                    : const SizedBox.shrink(),\n              ),\n            )),\n\n            // ويدجت البحث من خلال البراند والباركود\n            // تم نقلها للأعلى في الفلاتر المخفية\n            const Divider(),\n             SizedBox(height: hi/70),\n\n            // عرض الأقسام (النظام الجديد أو القديم)\n            Obx(() => (brandCtrl.isBrandModeActive.value || barcodeCtrl.isBarcodeSearchActive.value)\n                ? const SizedBox.shrink()\n                : _buildCategoriesWidget()),\n            const Divider(),\n\n\n\n            SizedBox(height: hi/70),\n\n            // شبكة المنتجات مع الفلترة المحسنة\n            Obx(() {\n              String filterKey = 'all_items'; // القيمة الافتراضية\n              \n              if (barcodeCtrl.hasActiveFilter) {\n                filterKey = barcodeCtrl.getFilterKey();\n              } else if (brandCtrl.isBrandModeActive.value) {\n                filterKey = brandCtrl.getFilterKey();\n              } else {\n                // محاولة استخدام النظام الجديد أولاً\n                try {\n                  final filterCtrl = Get.find<EnhancedCategoryFilterController>();\n                  filterKey = filterCtrl.getFilterKey();\n                                 } catch (e) {\n                   // إذا فشل، استخدم النظام المبسط\n                   try {\n                     final categoryFilterCtrl = Get.find<EnhancedCategoryFilterController>();\n                     filterKey = categoryFilterCtrl.getFilterKey();\n                   } catch (e2) {\n                     // إبقاء القيمة الافتراضية\n                   }\n                 }\n              }\n              \n              final selectedSort = searchCtrl.currentSortOption.value;\n\n              debugPrint(\"Rebuilding Product Grid: Filter='$filterKey', Sort='${selectedSort.label}'\");\n              debugPrint(\"Brand Mode Active: ${brandCtrl.isBrandModeActive.value}\");\n              debugPrint(\"Barcode Search Active: ${barcodeCtrl.hasActiveFilter}\");\n\n              return ProductGridWidgetOption(\n                selectedSubtypeKey: filterKey,\n              );\n            }),\n\n            const SizedBox(height: 20),\n          ],\n        ),\n      ),\n    );\n  }\n\n     // بناء ويدجت الأقسام (جديد أو مبسط)\n   Widget _buildCategoriesWidget() {\n     try {\n       Get.find<EnhancedCategoryFilterController>();\n       // إذا وُجد النظام الجديد، استخدمه\n       return const SimpleMainCategoriesWidget();\n     } catch (e) {\n       // إذا لم يوجد النظام الجديد، استخدم النظام المبسط\n       return const SimpleMainCategoriesWidget();\n     }\n   }\n}\n\n// --- شاشة البحث المنفصلة (مثال بسيط) ---\nclass SearchScreen extends StatelessWidget {\n  const SearchScreen({super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    // الحصول على نفس المتحكم الرئيسي أو إنشاء متحكم بحث خاص\n    final GetSearchController searchController = Get.find<GetSearchController>();\n    // أو إنشاء واحد جديد: Get.put(SearchScreenController());\n\n    return Scaffold(\n      appBar: AppBar(\n        // --- حقل البحث في AppBar ---\n        title: TextField(\n          controller: searchController.searchFieldController, // ربط المتحكم\n          autofocus: true, // فتح لوحة المفاتيح تلقائياً\n          decoration: InputDecoration(\n            hintText: \"ابحث عن المنتجات...\", // <<-- تعريب\n            border: InputBorder.none,\n            hintStyle: TextStyle(color: Colors.grey[600]),\n          ),\n          style: TextStyle(color: Theme.of(context).textTheme.bodyLarge?.color, fontSize: 18),\n          onChanged: (value) {\n            // قيمة البحث تتحدث تلقائياً في RxString في المتحكم بفضل المستمع\n            // searchController.searchQuery.value = value; // لا حاجة لهذا السطر إذا كان المستمع يعمل\n          },\n        ),\n        backgroundColor: Theme.of(context).appBarTheme.backgroundColor,\n        foregroundColor: Theme.of(context).appBarTheme.foregroundColor,\n      ),\n      body: Obx(() { // مراقبة searchQuery\n        // --- عرض النتائج باستخدام Widget البحث ---\n        return SearchResultsListWidget(searchQuery: searchController.searchQuery.value);\n      }),\n    );\n  }\n}\n"
        }
    ]
}