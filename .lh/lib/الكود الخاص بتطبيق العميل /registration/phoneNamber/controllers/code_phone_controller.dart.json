{
    "sourceFile": "lib/Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ /registration/phoneNamber/controllers/code_phone_controller.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1752751503159,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1752798049975,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,276 +1,659 @@\n import 'dart:async';\n-import 'dart:typed_data';\n import 'package:cloud_firestore/cloud_firestore.dart';\n import 'package:firebase_auth/firebase_auth.dart';\n import 'package:firebase_storage/firebase_storage.dart';\n+import 'package:firebase_messaging/firebase_messaging.dart';\n import 'package:flutter/material.dart';\n+import 'package:flutter/services.dart';\n import 'package:get/get.dart';\n+import 'package:connectivity_plus/connectivity_plus.dart';\n+import 'package:permission_handler/permission_handler.dart';\n \n-import '../../../core/error_display_manager.dart';\n import '../../../services/phone_auth_service.dart';\n+import '../../../../Model/model_user.dart';\n+import '../../../../XXX/xxx_firebase.dart';\n+import '../../../bottonBar/botonBar.dart';\n \n-/// ØªØ­ÙƒÙ… Ù…ØªÙ‚Ø¯Ù… Ù„ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚\n+/// ÙƒÙˆÙ†ØªØ±ÙˆÙ„Ø± Ù…ØªÙ‚Ø¯Ù… Ù„ØµÙØ­Ø© Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚\n+/// ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©ØŒ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø°ÙƒÙŠ\n class CodePhoneController extends GetxController {\n-  // Controllers Ù„Ù„Ø­Ù‚ÙˆÙ„\n+  // ===================== Constants =====================\n+  static const int _codeLength = 6;\n+  static const int _resendTimeoutSeconds = 60;\n+  static const int _maxResendAttempts = 3;\n+  static const int _maxVerificationAttempts = 5;\n+\n+  // ===================== Controllers & Focus Nodes =====================\n   final List<TextEditingController> codeControllers = List.generate(\n-    6,\n+    _codeLength,\n     (index) => TextEditingController(),\n   );\n \n-  // FocusNodes Ù„Ù„Ø­Ù‚ÙˆÙ„\n-  final List<FocusNode> focusNodes = List.generate(6, (index) => FocusNode());\n+  final List<FocusNode> focusNodes = List.generate(\n+    _codeLength,\n+    (index) => FocusNode(),\n+  );\n \n-  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…\n+  // ===================== Observable States =====================\n   final RxBool isLoading = false.obs;\n   final RxBool isCodeValid = true.obs;\n   final RxBool canResend = false.obs;\n-  final RxInt resendCounter = 60.obs;\n+  final RxBool isNetworkConnected = true.obs;\n+  final RxInt resendCounter = _resendTimeoutSeconds.obs;\n+  final RxInt resendAttempts = 0.obs;\n+  final RxInt verificationAttempts = 0.obs;\n   final RxString statusMessage = ''.obs;\n+  final RxString errorMessage = ''.obs;\n   final RxDouble progress = 0.0.obs;\n+  final RxBool isAutoVerifying = false.obs;\n+  final RxString allCodeText = ''.obs;\n \n-  // Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\n+  // ===================== Services & Utilities =====================\n   late PhoneAuthService _phoneAuthService;\n-\n-  // Timer Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n   Timer? _resendTimer;\n+  Timer? _autoFillTimer;\n+  late StreamSubscription<List<ConnectivityResult>> _connectivitySubscription;\n \n-  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n+  // ===================== Pinput Controller =====================\n+  final pinController = TextEditingController();\n+\n+  // ===================== User Data =====================\n   final String phoneNumber;\n   final Uint8List userImage;\n   final String name;\n   final String email;\n   final String password;\n-  final bool hasPassword;\n+  String? verificationId;\n+  int? forceResendingToken;\n \n+  // ===================== Constructor =====================\n   CodePhoneController({\n     required this.phoneNumber,\n     required this.userImage,\n     required this.name,\n     required this.email,\n     required this.password,\n-    required this.hasPassword,\n+    this.verificationId,\n+    this.forceResendingToken,\n   });\n \n+  // ===================== Lifecycle Methods =====================\n   @override\n   void onInit() {\n     super.onInit();\n-    _initializeService();\n-    _startResendTimer();\n-    _setupFocusListeners();\n+    _initializeController();\n+  }\n \n-    print('CodePhoneController initialized for $phoneNumber');\n+  @override\n+  void onClose() {\n+    _disposeResources();\n+    super.onClose();\n   }\n \n-  /// ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\n-  void _initializeService() {\n+  // ===================== Initialization =====================\n+  Future<void> _initializeController() async {\n     try {\n-      if (!Get.isRegistered<PhoneAuthService>()) {\n-        Get.put(PhoneAuthService());\n-      }\n-      _phoneAuthService = Get.find<PhoneAuthService>();\n+      await _initializeService();\n+      _setupNetworkMonitoring();\n+      _setupFocusListeners();\n+      _setupCodeValidation();\n+      _startResendTimer();\n+      _setupAutoFill();\n+\n+      statusMessage.value = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ $phoneNumber';\n+\n+      // ØªØ´Ø®ÙŠØµ Firebase ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\n+      await sendVerificationCodeWithDiagnosis();\n     } catch (e) {\n-      print('ERROR: Failed to initialize PhoneAuthService: $e');\n-      ErrorDisplayManager.showError(\n-        'ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©',\n-        details: e.toString(),\n-      );\n+      _handleError('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', e);\n     }\n   }\n \n-  /// Ø¥Ø¹Ø¯Ø§Ø¯ listeners Ù„Ù„Ø­Ù‚ÙˆÙ„\n+  Future<void> _initializeService() async {\n+    _phoneAuthService = Get.find<PhoneAuthService>();\n+  }\n+\n+  void _setupNetworkMonitoring() {\n+    _connectivitySubscription = Connectivity().onConnectivityChanged.listen((\n+      List<ConnectivityResult> results,\n+    ) {\n+      final isConnected = results.any(\n+        (result) => result != ConnectivityResult.none,\n+      );\n+      isNetworkConnected.value = isConnected;\n+\n+      if (isConnected) {\n+        statusMessage.value = 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';\n+      } else {\n+        statusMessage.value = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';\n+      }\n+    });\n+  }\n+\n   void _setupFocusListeners() {\n     for (int i = 0; i < focusNodes.length; i++) {\n-      codeControllers[i].addListener(() {\n-        if (codeControllers[i].text.length == 1) {\n-          if (i < focusNodes.length - 1) {\n-            focusNodes[i + 1].requestFocus();\n-          } else {\n-            focusNodes[i].unfocus();\n-          }\n+      focusNodes[i].addListener(() {\n+        if (focusNodes[i].hasFocus) {\n+          HapticFeedback.selectionClick();\n         }\n       });\n     }\n   }\n \n-  /// Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n+  void _setupCodeValidation() {\n+    for (int i = 0; i < codeControllers.length; i++) {\n+      codeControllers[i].addListener(() {\n+        _validateInput(i);\n+      });\n+    }\n+  }\n+\n   void _startResendTimer() {\n     canResend.value = false;\n-    resendCounter.value = 60;\n+    resendCounter.value = _resendTimeoutSeconds;\n \n+    _resendTimer?.cancel();\n     _resendTimer = Timer.periodic(const Duration(seconds: 1), (timer) {\n       if (resendCounter.value > 0) {\n         resendCounter.value--;\n       } else {\n         canResend.value = true;\n         timer.cancel();\n-        print('Resend code is now available');\n       }\n     });\n   }\n \n-  /// Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\n-  Future<void> resendCode() async {\n-    if (!canResend.value) return;\n+  void _setupAutoFill() {\n+    _requestSmsListenPermission();\n+    _setupPinputController();\n+  }\n \n+  // ===================== Pinput Setup =====================\n+  void _setupPinputController() {\n+    pinController.addListener(() {\n+      final text = pinController.text;\n+      if (text.length == _codeLength) {\n+        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…\n+        Future.delayed(const Duration(milliseconds: 300), () {\n+          if (pinController.text.length == _codeLength) {\n+            verifyCode();\n+          }\n+        });\n+      }\n+    });\n+  }\n+\n+  // ===================== Pinput Helper Methods =====================\n+  void clearPinput() {\n+    pinController.clear();\n+    isCodeValid.value = true;\n+    errorMessage.value = '';\n+  }\n+\n+  void setPinputCode(String code) {\n+    pinController.text = code;\n+  }\n+\n+  String getPinputCode() {\n+    return pinController.text;\n+  }\n+\n+  bool get isPinputComplete => pinController.text.length == _codeLength;\n+\n+  // ===================== Pinput Code Validation =====================\n+  bool validatePinputCode() {\n+    final code = pinController.text;\n+\n+    if (code.length != _codeLength) {\n+      _showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ÙƒØ§Ù…Ù„Ø§Ù‹');\n+      return false;\n+    }\n+\n+    if (!RegExp(r'^[0-9]+$').hasMatch(code)) {\n+      _showError('Ø§Ù„Ø±Ù…Ø² ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');\n+      return false;\n+    }\n+\n+    return true;\n+  }\n+\n+  // ===================== Pinput Verification =====================\n+  Future<void> verifyCodeFromPinput() async {\n+    final code = pinController.text;\n+\n+    if (code.length != _codeLength) {\n+      _showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ÙƒØ§Ù…Ù„Ø§Ù‹');\n+      return;\n+    }\n+\n+    if (!RegExp(r'^[0-9]+$').hasMatch(code)) {\n+      _showError('Ø§Ù„Ø±Ù…Ø² ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');\n+      return;\n+    }\n+\n+    verificationAttempts.value++;\n+\n+    if (verificationAttempts.value > _maxVerificationAttempts) {\n+      _handleError('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');\n+      return;\n+    }\n+\n     try {\n       isLoading.value = true;\n-      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...';\n+      statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';\n \n-      final result = await _phoneAuthService.sendVerificationCode(phoneNumber);\n+      final result = await _phoneAuthService.verifyCode(code);\n \n       if (result.isSuccess) {\n-        ErrorDisplayManager.showSuccess('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­');\n-        _startResendTimer();\n-        _clearCodeFields();\n+        await _handleSuccessfulVerification(result.user);\n       } else {\n-        ErrorDisplayManager.showError(\n-          'ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²',\n-          details: result.error?.toString(),\n-        );\n+        _handleVerificationError(result.error ?? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²');\n       }\n     } catch (e) {\n-      print('ERROR in resendCode: $e');\n-      ErrorDisplayManager.showError(\n-        'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',\n-        details: e.toString(),\n-      );\n+      _handleVerificationError(e);\n     } finally {\n       isLoading.value = false;\n-      statusMessage.value = '';\n     }\n   }\n \n-  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„Ù‡\n-  void checkCodeOnComplete() {\n-    final code = codeControllers.map((c) => c.text).join();\n-    if (code.length == 6) {\n-      verifyCode(code);\n+  // ===================== SMS Permission (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ) =====================\n+  Future<void> _requestSmsListenPermission() async {\n+    try {\n+      // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„\n+      final status = await Permission.sms.request();\n+\n+      if (status.isGranted) {\n+        statusMessage.value =\n+            'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù„Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';\n+      } else {\n+        statusMessage.value = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹';\n+      }\n+    } catch (e) {\n+      print('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: $e');\n+      statusMessage.value = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹';\n     }\n   }\n \n-  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²\n-  Future<void> verifyCode(String code) async {\n-    if (code.length != 6) {\n-      isCodeValid.value = false;\n-      ErrorDisplayManager.showError('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…');\n+  // ===================== Success Handling =====================\n+\n+  // ===================== Core Verification Logic =====================\n+  Future<void> sendVerificationCodeWithDiagnosis() async {\n+    if (!isNetworkConnected.value) {\n+      _handleError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');\n       return;\n     }\n \n     try {\n       isLoading.value = true;\n-      isCodeValid.value = true;\n-      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';\n-      progress.value = 0.2;\n+      statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚...';\n \n-      final result = await _phoneAuthService.verifyCode(code);\n-      progress.value = 0.6;\n+      final result = await _phoneAuthService.sendVerificationCode(phoneNumber);\n \n-      if (result.isSuccess && result.user != null) {\n-        statusMessage.value = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';\n-        progress.value = 0.8;\n+      if (result.isSuccess) {\n+        if (result.type == PhoneAuthResultType.codeSent) {\n+          verificationId = result.verificationId;\n+          statusMessage.value = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­';\n+        } else if (result.type == PhoneAuthResultType.autoVerified) {\n+          await _handleSuccessfulVerification(result.user);\n+          return;\n+        }\n+      } else {\n+        _handleError(\n+          'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚',\n+          result.error ?? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',\n+        );\n+      }\n+    } catch (e) {\n+      _handleError('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚', e);\n+    } finally {\n+      isLoading.value = false;\n+    }\n+  }\n \n-        await _completeUserRegistration(result.user!);\n-        progress.value = 1.0;\n+  Future<void> verifyCode() async {\n+    if (!_validateAllInputs()) return;\n \n-        ErrorDisplayManager.showSuccess('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');\n+    verificationAttempts.value++;\n \n-        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n-        Get.offAllNamed('/home');\n+    if (verificationAttempts.value > _maxVerificationAttempts) {\n+      _handleError('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');\n+      return;\n+    }\n+\n+    final code = _getCompleteCode();\n+\n+    try {\n+      isLoading.value = true;\n+      statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';\n+\n+      final result = await _phoneAuthService.verifyCode(code);\n+\n+      if (result.isSuccess) {\n+        await _handleSuccessfulVerification(result.user);\n       } else {\n-        isCodeValid.value = false;\n-        ErrorDisplayManager.showError(\n-          'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­',\n-          details: result.error?.toString(),\n-        );\n+        _handleVerificationError(result.error ?? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²');\n       }\n     } catch (e) {\n-      print('ERROR in verifyCode: $e');\n-      isCodeValid.value = false;\n-      ErrorDisplayManager.showError(\n-        'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²',\n-        details: e.toString(),\n-      );\n+      _handleVerificationError(e);\n     } finally {\n       isLoading.value = false;\n-      statusMessage.value = '';\n-      progress.value = 0.0;\n     }\n   }\n \n-  /// Ø¥ÙƒÙ…Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n-  Future<void> _completeUserRegistration(User user) async {\n-    try {\n-      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...';\n+  Future<void> resendCode() async {\n+    if (!canResend.value || resendAttempts.value >= _maxResendAttempts) {\n+      statusMessage.value = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';\n+      return;\n+    }\n \n-      final imageUrl = await _uploadUserImage(user.uid);\n+    resendAttempts.value++;\n+    _clearAllInputs();\n+    await sendVerificationCodeWithDiagnosis();\n+    _startResendTimer();\n+  }\n \n-      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...';\n+  // ===================== Input Validation & Management =====================\n+  void _validateInput(int index) {\n+    final text = codeControllers[index].text;\n \n-      // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n-      final userData = {\n-        'uid': user.uid,\n-        'name': name,\n-        'email': email,\n-        'phone': phoneNumber,\n-        'profileImage': imageUrl,\n-        'isVerified': true,\n-        'createdAt': DateTime.now().toIso8601String(),\n-        'appName': 'Codora',\n-      };\n+    if (text.isNotEmpty &&\n+        text.length == 1 &&\n+        RegExp(r'[0-9]').hasMatch(text)) {\n+      isCodeValid.value = true;\n+      errorMessage.value = '';\n+      _moveToNextField(index);\n+    } else if (text.length > 1) {\n+      codeControllers[index].text = text[text.length - 1];\n+    }\n \n-      await FirebaseFirestore.instance\n-          .collection('users') // FirebaseX.collectionApp replacement\n-          .doc(user.uid)\n-          .set(userData);\n+    _updateAllCodeText();\n+    _checkAutoVerification();\n+  }\n \n-      print('User registration completed successfully');\n-    } catch (e) {\n-      print('ERROR in _completeUserRegistration: $e');\n-      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');\n+  void _moveToNextField(int currentIndex) {\n+    Future.delayed(const Duration(milliseconds: 50), () {\n+      if (currentIndex < _codeLength - 1) {\n+        focusNodes[currentIndex + 1].requestFocus();\n+        HapticFeedback.lightImpact();\n+      } else {\n+        focusNodes[currentIndex].unfocus();\n+      }\n+    });\n+  }\n+\n+  void _moveToPreviousField(int currentIndex) {\n+    if (currentIndex > 0) {\n+      focusNodes[currentIndex - 1].requestFocus();\n+      HapticFeedback.lightImpact();\n     }\n   }\n \n-  /// Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n-  Future<String> _uploadUserImage(String userId) async {\n-    try {\n-      final storageRef = FirebaseStorage.instance\n-          .ref('user_images') // FirebaseX.StorgeApp replacement\n-          .child('$userId.jpg');\n+  void _updateAllCodeText() {\n+    allCodeText.value = codeControllers.map((c) => c.text).join();\n+  }\n \n-      final uploadTask = storageRef.putData(userImage);\n+  void _checkAutoVerification() {\n+    if (allCodeText.value.length == _codeLength &&\n+        allCodeText.value\n+            .split('')\n+            .every((char) => RegExp(r'[0-9]').hasMatch(char))) {\n+      _autoFillTimer?.cancel();\n+      _autoFillTimer = Timer(const Duration(milliseconds: 500), () {\n+        if (!isLoading.value) {\n+          verifyCode();\n+        }\n+      });\n+    }\n+  }\n \n-      final snapshot = await uploadTask;\n-      final downloadUrl = await snapshot.ref.getDownloadURL();\n+  bool _validateAllInputs() {\n+    final code = _getCompleteCode();\n \n-      print('Image uploaded successfully: $downloadUrl');\n-      return downloadUrl;\n-    } catch (e) {\n-      print('ERROR in _uploadUserImage: $e');\n-      throw Exception('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: $e');\n+    if (code.length != _codeLength) {\n+      _showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ÙƒØ§Ù…Ù„Ø§Ù‹');\n+      return false;\n     }\n+\n+    if (!RegExp(r'^[0-9]+$').hasMatch(code)) {\n+      _showError('Ø§Ù„Ø±Ù…Ø² ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');\n+      return false;\n+    }\n+\n+    return true;\n   }\n \n-  /// Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù…Ø²\n-  void _clearCodeFields() {\n+  String _getCompleteCode() {\n+    return codeControllers.map((controller) => controller.text).join();\n+  }\n+\n+  void _clearAllInputs() {\n     for (var controller in codeControllers) {\n       controller.clear();\n     }\n-    isCodeValid.value = true;\n+    allCodeText.value = '';\n     focusNodes[0].requestFocus();\n+    HapticFeedback.mediumImpact();\n   }\n \n-  @override\n-  void onClose() {\n+  // ===================== Success Handling =====================\n+  Future<void> _handleSuccessfulVerification(User? user) async {\n+    if (user == null) {\n+      _handleError('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚', 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');\n+      return;\n+    }\n+\n+    try {\n+      statusMessage.value = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';\n+\n+      await _saveUserDataToFirestore(user);\n+\n+      _showSuccessMessage();\n+      _navigateToBottomBar();\n+    } catch (e) {\n+      _handleError('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', e);\n+    }\n+  }\n+\n+  Future<void> _saveUserDataToFirestore(User user) async {\n+    try {\n+      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ FCM Token\n+      String fcmToken = '';\n+      try {\n+        fcmToken = await FirebaseMessaging.instance.getToken() ?? '';\n+        print('FCM Token: $fcmToken');\n+      } catch (e) {\n+        print('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ FCM Token: $e');\n+      }\n+\n+      // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·\n+      String profileImageUrl = '';\n+      try {\n+        final storageRef = FirebaseStorage.instance\n+            .ref()\n+            .child(FirebaseX.StorgeApp)\n+            .child('${user.uid}.jpg');\n+\n+        await storageRef.putData(userImage);\n+        profileImageUrl = await storageRef.getDownloadURL();\n+      } catch (e) {\n+        print('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: $e');\n+        profileImageUrl = ImageX.ImageOfPerson; // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n+      }\n+\n+      // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ FCM Token\n+      final userModel = UserModel(\n+        uid: user.uid,\n+        name: name,\n+        email: email,\n+        password: password, // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬\n+        phoneNumber: phoneNumber,\n+        token: fcmToken, // Ø­ÙØ¸ FCM Token\n+        url: profileImageUrl,\n+        appName: FirebaseX.appName,\n+      );\n+\n+      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… UserModel Ùˆ FirebaseX\n+      await FirebaseFirestore.instance\n+          .collection(FirebaseX.collectionApp)\n+          .doc(user.uid)\n+          .set({\n+            ...userModel.toMap(),\n+            'createdAt': FieldValue.serverTimestamp(),\n+            'lastLoginAt': FieldValue.serverTimestamp(),\n+            'isPhoneVerified': true,\n+            'userType': 'customer',\n+          });\n+\n+      print('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ: ${FirebaseX.collectionApp}');\n+      print('FCM Token Ù…Ø­ÙÙˆØ¸: $fcmToken');\n+    } catch (e) {\n+      print('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');\n+      throw e;\n+    }\n+  }\n+\n+  void _showSuccessMessage() {\n+    statusMessage.value = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­!';\n+    HapticFeedback.heavyImpact();\n+  }\n+\n+  void _navigateToBottomBar() {\n+    Future.delayed(const Duration(milliseconds: 1000), () {\n+      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ BottomBar Ù…Ø¹ initialIndex = 0\n+      Get.offAll(() => const BottomBar(initialIndex: 0));\n+    });\n+  }\n+\n+  // ===================== Error Handling =====================\n+  void _handleVerificationError(dynamic error) {\n+    String message = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²';\n+\n+    if (error is String) {\n+      message = error;\n+    } else if (error is FirebaseAuthException) {\n+      switch (error.code) {\n+        case 'invalid-verification-code':\n+          message = 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­';\n+          _clearAllInputs();\n+          break;\n+        case 'invalid-verification-id':\n+          message = 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­';\n+          break;\n+        case 'session-expired':\n+          message = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';\n+          break;\n+        case 'too-many-requests':\n+          message = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª';\n+          break;\n+        default:\n+          message = error.message ?? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';\n+      }\n+    } else {\n+      message = error.toString();\n+    }\n+\n+    _showError(message);\n+  }\n+\n+  void _handleError(String title, dynamic error) {\n+    final errorMsg = error.toString();\n+    print('Ø®Ø·Ø£ ÙÙŠ $title: $errorMsg');\n+\n+    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·Ø©\n+    Get.snackbar(\n+      title,\n+      errorMsg,\n+      snackPosition: SnackPosition.TOP,\n+      backgroundColor: Colors.red.withOpacity(0.1),\n+      colorText: Colors.red,\n+    );\n+\n+    statusMessage.value = title;\n+  }\n+\n+  void _showError(String message) {\n+    errorMessage.value = message;\n+    isCodeValid.value = false;\n+    HapticFeedback.heavyImpact();\n+\n+    Future.delayed(const Duration(seconds: 3), () {\n+      errorMessage.value = '';\n+      isCodeValid.value = true;\n+    });\n+  }\n+\n+  // ===================== Resource Management =====================\n+  void _disposeResources() {\n     _resendTimer?.cancel();\n+    _autoFillTimer?.cancel();\n+    _connectivitySubscription.cancel();\n+    pinController.dispose();\n \n     for (var controller in codeControllers) {\n       controller.dispose();\n     }\n \n-    for (var focusNode in focusNodes) {\n-      focusNode.dispose();\n+    for (var node in focusNodes) {\n+      node.dispose();\n     }\n+  }\n \n-    super.onClose();\n+  // ===================== Public Methods for UI =====================\n+  void moveToNextField(int currentIndex) {\n+    _moveToNextField(currentIndex);\n   }\n+\n+  void handlePastedText(String text, int startIndex) {\n+    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ - Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…\n+    final cleanText = text.replaceAll(RegExp(r'[^0-9]'), '');\n+\n+    // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø³ÙˆØ®\n+    for (\n+      int i = 0;\n+      i < cleanText.length && (startIndex + i) < _codeLength;\n+      i++\n+    ) {\n+      codeControllers[startIndex + i].text = cleanText[i];\n+    }\n+\n+    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨\n+    final nextIndex = (startIndex + cleanText.length).clamp(0, _codeLength - 1);\n+    if (nextIndex < _codeLength) {\n+      focusNodes[nextIndex].requestFocus();\n+    }\n+\n+    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ØªÙ… Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„\n+    _updateAllCodeText();\n+    _checkAutoVerification();\n+  }\n+\n+  // ===================== Utility Methods =====================\n+  void onBackspacePressed(int index) {\n+    if (codeControllers[index].text.isEmpty && index > 0) {\n+      _moveToPreviousField(index);\n+    } else {\n+      codeControllers[index].clear();\n+    }\n+  }\n+\n+  void onFieldTapped(int index) {\n+    focusNodes[index].requestFocus();\n+    HapticFeedback.selectionClick();\n+  }\n+\n+  double get verificationProgress {\n+    final filledFields = codeControllers.where((c) => c.text.isNotEmpty).length;\n+    return filledFields / _codeLength;\n+  }\n+\n+  String get resendButtonText {\n+    if (canResend.value) {\n+      return 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²';\n+    } else {\n+      return 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø®Ù„Ø§Ù„ ${resendCounter.value}s';\n+    }\n+  }\n+\n+  bool get isResendEnabled =>\n+      canResend.value && resendAttempts.value < _maxResendAttempts;\n }\n"
                },
                {
                    "date": 1752832216762,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -507,9 +507,9 @@\n       print('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ: ${FirebaseX.collectionApp}');\n       print('FCM Token Ù…Ø­ÙÙˆØ¸: $fcmToken');\n     } catch (e) {\n       print('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');\n-      throw e;\n+      rethrow;\n     }\n   }\n \n   void _showSuccessMessage() {\n"
                },
                {
                    "date": 1752858134127,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,8 +47,14 @@\n   final RxDouble progress = 0.0.obs;\n   final RxBool isAutoVerifying = false.obs;\n   final RxString allCodeText = ''.obs;\n \n+  // ===================== Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© =====================\n+  bool _isCodeSendingInProgress = false;\n+  DateTime? _lastCodeSendTime;\n+  bool _hasInitialCodeBeenSent = false;\n+  static const int _minimumSendInterval = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ\n+\n   // ===================== Services & Utilities =====================\n   late PhoneAuthService _phoneAuthService;\n   Timer? _resendTimer;\n   Timer? _autoFillTimer;\n@@ -101,10 +107,15 @@\n       _setupAutoFill();\n \n       statusMessage.value = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ $phoneNumber';\n \n-      // ØªØ´Ø®ÙŠØµ Firebase ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\n-      await sendVerificationCodeWithDiagnosis();\n+      // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ù† Ù‚Ø¨Ù„\n+      if (!_hasInitialCodeBeenSent) {\n+        await sendVerificationCodeWithDiagnosis();\n+      } else {\n+        print('â„¹ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² - ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹');\n+        statusMessage.value = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚';\n+      }\n     } catch (e) {\n       _handleError('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', e);\n     }\n   }\n@@ -273,18 +284,60 @@\n       statusMessage.value = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹';\n     }\n   }\n \n-  // ===================== Success Handling =====================\n+  // ===================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© =====================\n+  \n+  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯\n+  bool _canSendNewCode() {\n+    if (_isCodeSendingInProgress) {\n+      print('âš ï¸ Ø·Ù„Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø§Ù„ÙØ¹Ù„');\n+      return false;\n+    }\n+    \n+    if (_lastCodeSendTime != null) {\n+      final timeSinceLastSend = DateTime.now().difference(_lastCodeSendTime!).inMilliseconds;\n+      if (timeSinceLastSend < _minimumSendInterval) {\n+        final waitTime = _minimumSendInterval - timeSinceLastSend;\n+        print('âš ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${(waitTime / 1000).ceil()} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯');\n+        statusMessage.value = 'ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${(waitTime / 1000).ceil()} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';\n+        return false;\n+      }\n+    }\n+    \n+    return true;\n+  }\n+  \n+  /// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\n+  void _updateCodeSendingState(bool isInProgress) {\n+    _isCodeSendingInProgress = isInProgress;\n+    if (isInProgress) {\n+      _lastCodeSendTime = DateTime.now();\n+    }\n+  }\n+  \n+  /// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©\n+  void _resetDuplicateProtection() {\n+    _isCodeSendingInProgress = false;\n+    _lastCodeSendTime = null;\n+    _hasInitialCodeBeenSent = false;\n+  }\n \n-  // ===================== Core Verification Logic =====================\n+  // ===================== Main Controller Methods =====================\n   Future<void> sendVerificationCodeWithDiagnosis() async {\n+    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©\n+    if (!_canSendNewCode()) {\n+      return;\n+    }\n+\n     if (!isNetworkConnected.value) {\n       _handleError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');\n       return;\n     }\n \n     try {\n+      // âœ… ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\n+      _updateCodeSendingState(true);\n       isLoading.value = true;\n       statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚...';\n \n       final result = await _phoneAuthService.sendVerificationCode(phoneNumber);\n@@ -292,8 +345,9 @@\n       if (result.isSuccess) {\n         if (result.type == PhoneAuthResultType.codeSent) {\n           verificationId = result.verificationId;\n           statusMessage.value = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­';\n+          _hasInitialCodeBeenSent = true;\n         } else if (result.type == PhoneAuthResultType.autoVerified) {\n           await _handleSuccessfulVerification(result.user);\n           return;\n         }\n@@ -305,8 +359,10 @@\n       }\n     } catch (e) {\n       _handleError('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚', e);\n     } finally {\n+      // âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\n+      _updateCodeSendingState(false);\n       isLoading.value = false;\n     }\n   }\n \n@@ -340,13 +396,18 @@\n     }\n   }\n \n   Future<void> resendCode() async {\n+    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©\n     if (!canResend.value || resendAttempts.value >= _maxResendAttempts) {\n       statusMessage.value = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';\n       return;\n     }\n \n+    if (!_canSendNewCode()) {\n+      return;\n+    }\n+\n     resendAttempts.value++;\n     _clearAllInputs();\n     await sendVerificationCodeWithDiagnosis();\n     _startResendTimer();\n@@ -588,8 +649,11 @@\n     _autoFillTimer?.cancel();\n     _connectivitySubscription.cancel();\n     pinController.dispose();\n \n+    // âœ… ØªÙ†Ø¸ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©\n+    _resetDuplicateProtection();\n+\n     for (var controller in codeControllers) {\n       controller.dispose();\n     }\n \n"
                },
                {
                    "date": 1753181639034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,8 +9,9 @@\n import 'package:connectivity_plus/connectivity_plus.dart';\n import 'package:permission_handler/permission_handler.dart';\n \n import '../../../services/phone_auth_service.dart';\n+import '../../../services/firebase_phone_helper.dart';\n import '../../../../Model/model_user.dart';\n import '../../../../XXX/xxx_firebase.dart';\n import '../../../bottonBar/botonBar.dart';\n \n@@ -54,9 +55,9 @@\n   bool _hasInitialCodeBeenSent = false;\n   static const int _minimumSendInterval = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ\n \n   // ===================== Services & Utilities =====================\n-  late PhoneAuthService _phoneAuthService;\n+  PhoneAuthService? _phoneAuthService;\n   Timer? _resendTimer;\n   Timer? _autoFillTimer;\n   late StreamSubscription<List<ConnectivityResult>> _connectivitySubscription;\n \n@@ -107,8 +108,15 @@\n       _setupAutoFill();\n \n       statusMessage.value = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ $phoneNumber';\n \n+      // âœ… ÙØ­Øµ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n+      final systemReady = await _checkSystemReadiness();\n+      if (!systemReady) {\n+        statusMessage.value = 'ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...';\n+        await Future.delayed(Duration(seconds: 2));\n+      }\n+\n       // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ù† Ù‚Ø¨Ù„\n       if (!_hasInitialCodeBeenSent) {\n         await sendVerificationCodeWithDiagnosis();\n       } else {\n@@ -119,10 +127,94 @@\n       _handleError('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', e);\n     }\n   }\n \n+  /// ÙØ­Øµ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…\n+  Future<bool> _checkSystemReadiness() async {\n+    try {\n+      debugPrint(\"ğŸ” ÙØ­Øµ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…...\");\n+\n+      // 1. ÙØ­Øµ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\n+      if (_phoneAuthService == null) {\n+        debugPrint(\"âŒ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©\");\n+        return false;\n+      }\n+\n+      // 2. ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©\n+      if (!isNetworkConnected.value) {\n+        debugPrint(\"âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª\");\n+        return false;\n+      }\n+\n+      // 3. ØªØ´Ø®ÙŠØµ Firebase\n+      final diagnosis = await FirebasePhoneHelper.comprehensiveDiagnosis();\n+      if (diagnosis.containsKey('error')) {\n+        debugPrint(\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´Ø®ÙŠØµ Firebase: ${diagnosis['error']}\");\n+        return false;\n+      }\n+\n+      // 4. ÙØ­Øµ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n+      final phoneValidation = FirebasePhoneHelper.validatePhoneNumberAdvanced(\n+        phoneNumber,\n+      );\n+      final suggestions = phoneValidation['suggestions'] as List<String>;\n+      if (suggestions.isNotEmpty && suggestions.first != 'Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ùˆ ØµØ­ÙŠØ­Ø§Ù‹') {\n+        debugPrint(\"âš ï¸ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${suggestions.join(', ')}\");\n+        statusMessage.value = \"ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${suggestions.first}\";\n+        return false;\n+      }\n+\n+      debugPrint(\"âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„\");\n+      return true;\n+    } catch (e) {\n+      debugPrint(\"âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…: $e\");\n+      return false;\n+    }\n+  }\n+\n   Future<void> _initializeService() async {\n-    _phoneAuthService = Get.find<PhoneAuthService>();\n+    try {\n+      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹\n+      if (!Get.isRegistered<PhoneAuthService>()) {\n+        debugPrint(\"âš ï¸ PhoneAuthService ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...\");\n+        Get.put(PhoneAuthService(), permanent: true);\n+        await Future.delayed(Duration(milliseconds: 500)); // Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„ØªÙ‡ÙŠØ¦Ø©\n+      }\n+\n+      _phoneAuthService = Get.find<PhoneAuthService>();\n+\n+      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©\n+      if (_phoneAuthService != null && !_phoneAuthService!.canMakeRequest) {\n+        debugPrint(\"âš ï¸ Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†...\");\n+        _phoneAuthService!.resetRequestState();\n+      }\n+\n+      debugPrint(\"âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© PhoneAuthService Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ÙƒÙ†ØªØ±ÙˆÙ„Ø±\");\n+\n+      // Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø®Ø¯Ù…Ø©\n+      if (_phoneAuthService != null) {\n+        final report = _phoneAuthService!.getServiceReport();\n+        debugPrint(\"ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„ÙƒÙ†ØªØ±ÙˆÙ„Ø±: ${report['status']}\");\n+      }\n+    } catch (e) {\n+      debugPrint(\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© PhoneAuthService: $e\");\n+\n+      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©\n+      try {\n+        debugPrint(\"ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...\");\n+        Get.delete<PhoneAuthService>(force: true);\n+        await Future.delayed(Duration(milliseconds: 200));\n+\n+        Get.put(PhoneAuthService(), permanent: true);\n+        await Future.delayed(Duration(milliseconds: 500));\n+\n+        _phoneAuthService = Get.find<PhoneAuthService>();\n+        debugPrint(\"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©\");\n+      } catch (retryError) {\n+        debugPrint(\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©: $retryError\");\n+        throw Exception(\"ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: $retryError\");\n+      }\n+    }\n   }\n \n   void _setupNetworkMonitoring() {\n     _connectivitySubscription = Connectivity().onConnectivityChanged.listen((\n@@ -252,10 +344,14 @@\n     try {\n       isLoading.value = true;\n       statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';\n \n-      final result = await _phoneAuthService.verifyCode(code);\n+      if (_phoneAuthService == null) {\n+        throw Exception('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©');\n+      }\n \n+      final result = await _phoneAuthService!.verifyCode(code);\n+\n       if (result.isSuccess) {\n         await _handleSuccessfulVerification(result.user);\n       } else {\n         _handleVerificationError(result.error ?? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²');\n@@ -285,85 +381,175 @@\n     }\n   }\n \n   // ===================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© =====================\n-  \n+\n   /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯\n   bool _canSendNewCode() {\n     if (_isCodeSendingInProgress) {\n       print('âš ï¸ Ø·Ù„Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø§Ù„ÙØ¹Ù„');\n       return false;\n     }\n-    \n+\n     if (_lastCodeSendTime != null) {\n-      final timeSinceLastSend = DateTime.now().difference(_lastCodeSendTime!).inMilliseconds;\n+      final timeSinceLastSend =\n+          DateTime.now().difference(_lastCodeSendTime!).inMilliseconds;\n       if (timeSinceLastSend < _minimumSendInterval) {\n         final waitTime = _minimumSendInterval - timeSinceLastSend;\n-        print('âš ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${(waitTime / 1000).ceil()} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯');\n-        statusMessage.value = 'ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${(waitTime / 1000).ceil()} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';\n+        print(\n+          'âš ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${(waitTime / 1000).ceil()} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯',\n+        );\n+        statusMessage.value =\n+            'ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${(waitTime / 1000).ceil()} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';\n         return false;\n       }\n     }\n-    \n+\n     return true;\n   }\n-  \n+\n   /// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\n   void _updateCodeSendingState(bool isInProgress) {\n     _isCodeSendingInProgress = isInProgress;\n     if (isInProgress) {\n       _lastCodeSendTime = DateTime.now();\n     }\n   }\n-  \n+\n   /// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©\n   void _resetDuplicateProtection() {\n     _isCodeSendingInProgress = false;\n     _lastCodeSendTime = null;\n     _hasInitialCodeBeenSent = false;\n   }\n \n   // ===================== Main Controller Methods =====================\n+  /// Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„\n   Future<void> sendVerificationCodeWithDiagnosis() async {\n-    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©\n+    debugPrint(\"ğŸ” Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰: $phoneNumber\");\n+\n+    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹\n+    if (_phoneAuthService == null) {\n+      try {\n+        await _initializeService();\n+      } catch (e) {\n+        _handleError(\"ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\", e);\n+        return;\n+      }\n+    }\n+\n+    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ù…Ø¹ Ù…Ø±ÙˆÙ†Ø© Ø£ÙƒØ¨Ø±\n     if (!_canSendNewCode()) {\n-      return;\n+      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚ØŒ Ø§Ù…Ù†Ø­ ÙØ±ØµØ© Ø¬Ø¯ÙŠØ¯Ø©\n+      if (_hasInitialCodeBeenSent && !canResend.value) {\n+        debugPrint(\"âš ï¸ Ø¥Ø¹Ø·Ø§Ø¡ ÙØ±ØµØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚\");\n+        _hasInitialCodeBeenSent = false;\n+        _resetDuplicateProtection();\n+      } else {\n+        return;\n+      }\n     }\n \n     if (!isNetworkConnected.value) {\n       _handleError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');\n       return;\n     }\n \n     try {\n+      // âœ… ØªØ´Ø®ÙŠØµ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø³Ù†\n+      debugPrint(\"ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...\");\n+\n+      if (_phoneAuthService == null) {\n+        throw Exception('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©');\n+      }\n+\n+      // ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯\n+      final comprehensiveDiagnosis =\n+          await FirebasePhoneHelper.comprehensiveDiagnosis();\n+      debugPrint(\n+        \"ğŸ“Š ØªØ´Ø®ÙŠØµ Firebase Ø§Ù„Ø´Ø§Ù…Ù„: ${comprehensiveDiagnosis['firebase']}\",\n+      );\n+\n+      // ÙØ­Øµ ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ø³Ù†\n+      final phoneValidation = FirebasePhoneHelper.validatePhoneNumberAdvanced(\n+        phoneNumber,\n+      );\n+      debugPrint(\"ğŸ“ ÙØ­Øµ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ø³Ù†: ${phoneValidation['type']}\");\n+\n+      // Ø·Ø¨Ø§Ø¹Ø© Ù†ØµØ§Ø¦Ø­ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù…Ø§Ù‹ ØªØ¬Ø±ÙŠØ¨ÙŠØ§Ù‹\n+      if (phoneValidation['type']['is_test_number'] == true) {\n+        debugPrint(\n+          \"ğŸ§ª Ø±Ù‚Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…ÙƒØªØ´Ù: ${phoneValidation['type']['test_note']}\",\n+        );\n+      }\n+\n+      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª\n+      final suggestions = phoneValidation['suggestions'] as List<String>;\n+      if (suggestions.isNotEmpty && suggestions.first != 'Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ùˆ ØµØ­ÙŠØ­Ø§Ù‹') {\n+        debugPrint(\"ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø±Ù‚Ù…: ${suggestions.join(', ')}\");\n+        statusMessage.value = \"Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: ${suggestions.first}\";\n+        await Future.delayed(Duration(seconds: 2));\n+      }\n+\n+      if (phoneValidation['basic']['is_numeric_only'] != true) {\n+        final suggestions = phoneValidation['suggestions'] as List<String>;\n+        _handleError(\"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­\", suggestions.join('\\n'));\n+        return;\n+      }\n+\n       // âœ… ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\n       _updateCodeSendingState(true);\n       isLoading.value = true;\n       statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚...';\n+      progress.value = 0.2;\n \n-      final result = await _phoneAuthService.sendVerificationCode(phoneNumber);\n+      debugPrint(\"ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Firebase...\");\n+      final result = await _phoneAuthService!.sendVerificationCode(phoneNumber);\n \n+      progress.value = 0.8;\n+\n       if (result.isSuccess) {\n         if (result.type == PhoneAuthResultType.codeSent) {\n           verificationId = result.verificationId;\n           statusMessage.value = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­';\n           _hasInitialCodeBeenSent = true;\n+          progress.value = 1.0;\n+\n+          debugPrint(\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­\");\n+          debugPrint(\"ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚: ${verificationId?.substring(0, 10)}...\");\n+\n+          // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¥Ù† ÙˆØ¬Ø¯Øª\n+          errorMessage.value = '';\n         } else if (result.type == PhoneAuthResultType.autoVerified) {\n+          debugPrint(\"âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ\");\n           await _handleSuccessfulVerification(result.user);\n           return;\n         }\n       } else {\n-        _handleError(\n-          'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚',\n-          result.error ?? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',\n-        );\n+        final errorMsg = result.error ?? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²';\n+        debugPrint(\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²: $errorMsg\");\n+\n+        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ Ù„Ø¥ØªØ§Ø­Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰\n+        _hasInitialCodeBeenSent = false;\n+        _resetDuplicateProtection();\n+\n+        _handleError('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚', errorMsg);\n       }\n     } catch (e) {\n+      debugPrint(\"ğŸš¨ Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚: $e\");\n+\n+      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡\n+      _hasInitialCodeBeenSent = false;\n+      _resetDuplicateProtection();\n+\n       _handleError('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚', e);\n     } finally {\n       // âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\n       _updateCodeSendingState(false);\n       isLoading.value = false;\n+      progress.value = 0.0;\n+\n+      debugPrint(\"ğŸ”„ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\");\n     }\n   }\n \n   Future<void> verifyCode() async {\n@@ -381,10 +567,14 @@\n     try {\n       isLoading.value = true;\n       statusMessage.value = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';\n \n-      final result = await _phoneAuthService.verifyCode(code);\n+      if (_phoneAuthService == null) {\n+        throw Exception('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©');\n+      }\n \n+      final result = await _phoneAuthService!.verifyCode(code);\n+\n       if (result.isSuccess) {\n         await _handleSuccessfulVerification(result.user);\n       } else {\n         _handleVerificationError(result.error ?? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²');\n@@ -595,17 +785,27 @@\n       switch (error.code) {\n         case 'invalid-verification-code':\n           message = 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­';\n           _clearAllInputs();\n+\n+          // Ø¥Ø¶Ø§ÙØ© Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©\n+          final phoneValidation =\n+              FirebasePhoneHelper.validatePhoneNumberAdvanced(phoneNumber);\n+          if (phoneValidation['type']['is_test_number'] == true) {\n+            message +=\n+                '\\n\\nğŸ’¡ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Firebase Console ØªØ­Øª \"Phone numbers for testing\"';\n+          } else {\n+            message += '\\n\\nğŸ’¡ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙØ±Ø³Ù„ Ø¹Ø¨Ø± SMS';\n+          }\n           break;\n         case 'invalid-verification-id':\n-          message = 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­';\n+          message = 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­ - Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯';\n           break;\n         case 'session-expired':\n-          message = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';\n+          message = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯';\n           break;\n         case 'too-many-requests':\n-          message = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª';\n+          message = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª - Ø§Ù†ØªØ¸Ø± Ø¨Ø¶Ø¹ Ø¯Ù‚Ø§Ø¦Ù‚';\n           break;\n         default:\n           message = error.message ?? 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';\n       }\n@@ -613,21 +813,48 @@\n       message = error.toString();\n     }\n \n     _showError(message);\n+\n+    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©\n+    final solutions = FirebasePhoneHelper.getCommonSolutions();\n+    if (message.contains('ØºÙŠØ± ØµØ­ÙŠØ­')) {\n+      Future.delayed(Duration(seconds: 3), () {\n+        statusMessage.value =\n+            'Ù†ØµØ§Ø¦Ø­: ${solutions['Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­']?.first ?? ''}';\n+      });\n+    }\n   }\n \n   void _handleError(String title, dynamic error) {\n     final errorMsg = error.toString();\n     print('Ø®Ø·Ø£ ÙÙŠ $title: $errorMsg');\n \n-    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·Ø©\n+    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯\n+    final solutions = FirebasePhoneHelper.getCommonSolutions();\n+    String solutionText = '';\n+\n+    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù„ Ù…Ù†Ø§Ø³Ø¨\n+    if (title.contains('Ø¥Ø±Ø³Ø§Ù„')) {\n+      solutionText =\n+          '\\nØ­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©:\\n${solutions['ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²']?.take(3).join('\\nâ€¢ ') ?? ''}';\n+    } else if (errorMsg.contains('internal-error')) {\n+      solutionText =\n+          '\\nØ­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©:\\n${solutions['Ø®Ø·Ø£ internal-error']?.take(3).join('\\nâ€¢ ') ?? ''}';\n+    } else if (errorMsg.contains('too-many-requests')) {\n+      solutionText =\n+          '\\nØ­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©:\\n${solutions['Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨Ø§Øª']?.take(3).join('\\nâ€¢ ') ?? ''}';\n+    }\n+\n+    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø¹ Ø§Ù„Ø­Ù„ÙˆÙ„\n     Get.snackbar(\n       title,\n-      errorMsg,\n+      errorMsg + solutionText,\n       snackPosition: SnackPosition.TOP,\n       backgroundColor: Colors.red.withOpacity(0.1),\n       colorText: Colors.red,\n+      duration: Duration(seconds: 8), // Ù…Ø¯Ø© Ø£Ø·ÙˆÙ„ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ù„ÙˆÙ„\n+      maxWidth: Get.width * 0.95,\n     );\n \n     statusMessage.value = title;\n   }\n"
                }
            ],
            "date": 1752751503159,
            "name": "Commit-0",
            "content": "import 'dart:async';\nimport 'dart:typed_data';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:firebase_storage/firebase_storage.dart';\nimport 'package:flutter/material.dart';\nimport 'package:get/get.dart';\n\nimport '../../../core/error_display_manager.dart';\nimport '../../../services/phone_auth_service.dart';\n\n/// ØªØ­ÙƒÙ… Ù…ØªÙ‚Ø¯Ù… Ù„ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚\nclass CodePhoneController extends GetxController {\n  // Controllers Ù„Ù„Ø­Ù‚ÙˆÙ„\n  final List<TextEditingController> codeControllers = List.generate(\n    6,\n    (index) => TextEditingController(),\n  );\n\n  // FocusNodes Ù„Ù„Ø­Ù‚ÙˆÙ„\n  final List<FocusNode> focusNodes = List.generate(6, (index) => FocusNode());\n\n  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…\n  final RxBool isLoading = false.obs;\n  final RxBool isCodeValid = true.obs;\n  final RxBool canResend = false.obs;\n  final RxInt resendCounter = 60.obs;\n  final RxString statusMessage = ''.obs;\n  final RxDouble progress = 0.0.obs;\n\n  // Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\n  late PhoneAuthService _phoneAuthService;\n\n  // Timer Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n  Timer? _resendTimer;\n\n  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n  final String phoneNumber;\n  final Uint8List userImage;\n  final String name;\n  final String email;\n  final String password;\n  final bool hasPassword;\n\n  CodePhoneController({\n    required this.phoneNumber,\n    required this.userImage,\n    required this.name,\n    required this.email,\n    required this.password,\n    required this.hasPassword,\n  });\n\n  @override\n  void onInit() {\n    super.onInit();\n    _initializeService();\n    _startResendTimer();\n    _setupFocusListeners();\n\n    print('CodePhoneController initialized for $phoneNumber');\n  }\n\n  /// ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©\n  void _initializeService() {\n    try {\n      if (!Get.isRegistered<PhoneAuthService>()) {\n        Get.put(PhoneAuthService());\n      }\n      _phoneAuthService = Get.find<PhoneAuthService>();\n    } catch (e) {\n      print('ERROR: Failed to initialize PhoneAuthService: $e');\n      ErrorDisplayManager.showError(\n        'ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©',\n        details: e.toString(),\n      );\n    }\n  }\n\n  /// Ø¥Ø¹Ø¯Ø§Ø¯ listeners Ù„Ù„Ø­Ù‚ÙˆÙ„\n  void _setupFocusListeners() {\n    for (int i = 0; i < focusNodes.length; i++) {\n      codeControllers[i].addListener(() {\n        if (codeControllers[i].text.length == 1) {\n          if (i < focusNodes.length - 1) {\n            focusNodes[i + 1].requestFocus();\n          } else {\n            focusNodes[i].unfocus();\n          }\n        }\n      });\n    }\n  }\n\n  /// Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n  void _startResendTimer() {\n    canResend.value = false;\n    resendCounter.value = 60;\n\n    _resendTimer = Timer.periodic(const Duration(seconds: 1), (timer) {\n      if (resendCounter.value > 0) {\n        resendCounter.value--;\n      } else {\n        canResend.value = true;\n        timer.cancel();\n        print('Resend code is now available');\n      }\n    });\n  }\n\n  /// Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²\n  Future<void> resendCode() async {\n    if (!canResend.value) return;\n\n    try {\n      isLoading.value = true;\n      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...';\n\n      final result = await _phoneAuthService.sendVerificationCode(phoneNumber);\n\n      if (result.isSuccess) {\n        ErrorDisplayManager.showSuccess('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­');\n        _startResendTimer();\n        _clearCodeFields();\n      } else {\n        ErrorDisplayManager.showError(\n          'ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²',\n          details: result.error?.toString(),\n        );\n      }\n    } catch (e) {\n      print('ERROR in resendCode: $e');\n      ErrorDisplayManager.showError(\n        'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',\n        details: e.toString(),\n      );\n    } finally {\n      isLoading.value = false;\n      statusMessage.value = '';\n    }\n  }\n\n  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„Ù‡\n  void checkCodeOnComplete() {\n    final code = codeControllers.map((c) => c.text).join();\n    if (code.length == 6) {\n      verifyCode(code);\n    }\n  }\n\n  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²\n  Future<void> verifyCode(String code) async {\n    if (code.length != 6) {\n      isCodeValid.value = false;\n      ErrorDisplayManager.showError('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…');\n      return;\n    }\n\n    try {\n      isLoading.value = true;\n      isCodeValid.value = true;\n      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';\n      progress.value = 0.2;\n\n      final result = await _phoneAuthService.verifyCode(code);\n      progress.value = 0.6;\n\n      if (result.isSuccess && result.user != null) {\n        statusMessage.value = 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';\n        progress.value = 0.8;\n\n        await _completeUserRegistration(result.user!);\n        progress.value = 1.0;\n\n        ErrorDisplayManager.showSuccess('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');\n\n        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n        Get.offAllNamed('/home');\n      } else {\n        isCodeValid.value = false;\n        ErrorDisplayManager.showError(\n          'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­',\n          details: result.error?.toString(),\n        );\n      }\n    } catch (e) {\n      print('ERROR in verifyCode: $e');\n      isCodeValid.value = false;\n      ErrorDisplayManager.showError(\n        'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²',\n        details: e.toString(),\n      );\n    } finally {\n      isLoading.value = false;\n      statusMessage.value = '';\n      progress.value = 0.0;\n    }\n  }\n\n  /// Ø¥ÙƒÙ…Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n  Future<void> _completeUserRegistration(User user) async {\n    try {\n      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...';\n\n      final imageUrl = await _uploadUserImage(user.uid);\n\n      statusMessage.value = 'Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...';\n\n      // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n      final userData = {\n        'uid': user.uid,\n        'name': name,\n        'email': email,\n        'phone': phoneNumber,\n        'profileImage': imageUrl,\n        'isVerified': true,\n        'createdAt': DateTime.now().toIso8601String(),\n        'appName': 'Codora',\n      };\n\n      await FirebaseFirestore.instance\n          .collection('users') // FirebaseX.collectionApp replacement\n          .doc(user.uid)\n          .set(userData);\n\n      print('User registration completed successfully');\n    } catch (e) {\n      print('ERROR in _completeUserRegistration: $e');\n      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');\n    }\n  }\n\n  /// Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n  Future<String> _uploadUserImage(String userId) async {\n    try {\n      final storageRef = FirebaseStorage.instance\n          .ref('user_images') // FirebaseX.StorgeApp replacement\n          .child('$userId.jpg');\n\n      final uploadTask = storageRef.putData(userImage);\n\n      final snapshot = await uploadTask;\n      final downloadUrl = await snapshot.ref.getDownloadURL();\n\n      print('Image uploaded successfully: $downloadUrl');\n      return downloadUrl;\n    } catch (e) {\n      print('ERROR in _uploadUserImage: $e');\n      throw Exception('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: $e');\n    }\n  }\n\n  /// Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù…Ø²\n  void _clearCodeFields() {\n    for (var controller in codeControllers) {\n      controller.clear();\n    }\n    isCodeValid.value = true;\n    focusNodes[0].requestFocus();\n  }\n\n  @override\n  void onClose() {\n    _resendTimer?.cancel();\n\n    for (var controller in codeControllers) {\n      controller.dispose();\n    }\n\n    for (var focusNode in focusNodes) {\n      focusNode.dispose();\n    }\n\n    super.onClose();\n  }\n}\n"
        }
    ]
}