{
    "sourceFile": "lib/Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ /theÙ€chosen/GetXController/GetAddAndRemove.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1753157006719,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1753157006719,
            "name": "Commit-0",
            "content": "import 'dart:async';\nimport 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\nimport 'package:flutter/material.dart';\nimport 'package:get/get.dart';\n\nimport '../../../XXX/xxx_firebase.dart';\n\n/// ÙŠØªØ­ÙƒÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø© ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©.\n/// ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯ ÙˆÙŠØ³ØªØ®Ø¯Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù…ØªÙˆØ§Ø²ÙŠØ© (Future.wait)\n/// Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹ØªÙŠ \"Item\" Ùˆ\"Itemoffer\".\nclass GetAddAndRemove extends GetxController {\n  // ÙŠØ®Ø²Ù† Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… uidOfDoc ÙƒÙ…ÙØªØ§Ø­\n  final Map<String, int> _itemQuantities = {};\n  RxInt totalCartItemCount = 0.obs;\n\n  // Ù…ØªØºÙŠØ±Ø§Øª Rx Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±\n  RxInt total = 0.obs;\n  RxInt totalPriceOfItem = 0.obs;\n  RxInt totalPriceOfofferItem = 0.obs;\n  RxInt totalPrice = 0.obs;\n\n  /// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ù…Ø¹ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„Ø§ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ØªÙŠÙ†\n\n  Future<void> calculateTotals() async {\n    final String userId = FirebaseAuth.instance.currentUser!.uid;\n    debugPrint('ğŸ”¥ Starting calculateTotals for user: $userId');\n\n    try {\n      totalPriceOfItem.value = 0;\n      totalPriceOfofferItem.value = 0;\n      int currentTotalItems = 0; // For sum of quantities\n\n      QuerySnapshot querySnapshot =\n          await FirebaseFirestore.instance\n              .collection('the-chosen')\n              .doc(userId)\n              .collection(FirebaseX.appName)\n              .get();\n\n      debugPrint('ğŸ›’ Found ${querySnapshot.docs.length} items in cart');\n\n      // Clear local quantities before recalculating\n      _itemQuantities.clear();\n\n      List<Future<void>> priceFutures = [];\n\n      for (var doc in querySnapshot.docs) {\n        final data = doc.data() as Map<String, dynamic>?;\n        if (data == null) continue;\n\n        int itemCount = data['number'] as int? ?? 0;\n        currentTotalItems += itemCount; // Summing up quantities\n        final uidItem = data['uidItem'] as String? ?? \"\";\n        final bool isOffer = data['isOfer'] as bool? ?? false;\n\n        debugPrint(\n          'ğŸ“¦ Processing item: $uidItem, quantity: $itemCount, isOffer: $isOffer',\n        );\n\n        if (uidItem.isEmpty) continue;\n\n        _itemQuantities[doc.id] = itemCount;\n\n        // Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ¹Ù„ÙŠ\n        priceFutures.add(\n          Future.wait([\n            FirebaseFirestore.instance\n                .collection(FirebaseX.itemsCollection)\n                .doc(uidItem)\n                .get(),\n            FirebaseFirestore.instance\n                .collection(FirebaseX.offersCollection)\n                .doc(uidItem)\n                .get(),\n          ]).then((List<DocumentSnapshot> snapshots) {\n            final productSnapshot = snapshots[0];\n            final offerSnapshot = snapshots[1];\n            int priceNormal = 0;\n            int priceOffer = 0;\n\n            debugPrint('ğŸª Checking product collections for item: $uidItem');\n            debugPrint('   Normal product exists: ${productSnapshot.exists}');\n            debugPrint('   Offer product exists: ${offerSnapshot.exists}');\n\n            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©\n            if (productSnapshot.exists) {\n              try {\n                // Ø§Ø³ØªØ®Ø¯Ø§Ù… suggestedRetailPrice Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… priceOfItem ÙƒØ¨Ø¯ÙŠÙ„\n                final productData =\n                    productSnapshot.data() as Map<String, dynamic>?;\n                final suggestedPriceData = productData?['suggestedRetailPrice'];\n                final regularPriceData = productSnapshot.get('priceOfItem');\n\n                final priceData = suggestedPriceData ?? regularPriceData;\n                debugPrint(\n                  '   Raw normal price data: $priceData (${priceData.runtimeType})',\n                );\n                if (priceData != null) {\n                  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªÙ„Ø· (int Ø£Ùˆ double Ø£Ùˆ string)\n                  if (priceData is num) {\n                    priceNormal = priceData.toInt();\n                  } else if (priceData is String) {\n                    priceNormal = double.tryParse(priceData)?.toInt() ?? 0;\n                  }\n                  debugPrint('   Normal price converted: $priceNormal');\n                }\n              } catch (e) {\n                debugPrint(\"âŒ Error parsing normal item price: $e\");\n              }\n            }\n\n            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©\n            if (offerSnapshot.exists) {\n              try {\n                // Ø§Ø³ØªØ®Ø¯Ø§Ù… suggestedRetailPrice Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… priceOfItem ÙƒØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø¹Ø±ÙˆØ¶ Ø£ÙŠØ¶Ø§Ù‹\n                final offerData = offerSnapshot.data() as Map<String, dynamic>?;\n                final suggestedPriceData = offerData?['suggestedRetailPrice'];\n                final regularPriceData = offerSnapshot.get('priceOfItem');\n\n                final priceData = suggestedPriceData ?? regularPriceData;\n                debugPrint(\n                  '   Raw offer price data: $priceData (${priceData.runtimeType})',\n                );\n                if (priceData != null) {\n                  // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªÙ„Ø· (int Ø£Ùˆ double Ø£Ùˆ string)\n                  if (priceData is num) {\n                    priceOffer = priceData.toInt();\n                  } else if (priceData is String) {\n                    priceOffer = double.tryParse(priceData)?.toInt() ?? 0;\n                  }\n                  debugPrint('   Offer price converted: $priceOffer');\n                }\n              } catch (e) {\n                debugPrint(\"âŒ Error parsing offer item price: $e\");\n              }\n            }\n\n            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ (Ø¹Ø±Ø¶ Ø£Ù… Ù„Ø§)\n            int finalPrice = 0;\n            if (isOffer) {\n              // Ù‡Ø°Ø§ Ù…Ù†ØªØ¬ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶\n              if (priceOffer > 0) {\n                finalPrice = priceOffer;\n                totalPriceOfofferItem.value += priceOffer * itemCount;\n                debugPrint(\n                  'ğŸ’° Added offer price: ${priceOffer * itemCount} ($priceOffer x $itemCount)',\n                );\n              } else {\n                debugPrint('âš ï¸ Offer item has no valid price: $uidItem');\n              }\n            } else {\n              // Ù‡Ø°Ø§ Ù…Ù†ØªØ¬ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©\n              if (priceNormal > 0) {\n                finalPrice = priceNormal;\n                totalPriceOfItem.value += priceNormal * itemCount;\n                debugPrint(\n                  'ğŸ’° Added normal price: ${priceNormal * itemCount} ($priceNormal x $itemCount)',\n                );\n              } else {\n                debugPrint('âš ï¸ Normal item has no valid price: $uidItem');\n              }\n            }\n\n            if (finalPrice == 0) {\n              debugPrint(\n                'ğŸš¨ NO PRICE FOUND for item: $uidItem (isOffer: $isOffer, normalPrice: $priceNormal, offerPrice: $priceOffer)',\n              );\n            }\n          }),\n        );\n      }\n\n      await Future.wait(priceFutures);\n      total.value = totalPriceOfItem.value + totalPriceOfofferItem.value;\n      totalPrice.value = total.value; // ØªØ­Ø¯ÙŠØ« totalPrice Ø£ÙŠØ¶Ø§Ù‹\n      totalCartItemCount.value =\n          currentTotalItems; // Update the total item count\n      update(); // This updates listeners to GetAddAndRemove\n\n      debugPrint('âœ… Calculate totals completed:');\n      debugPrint('   Normal items total: ${totalPriceOfItem.value}');\n      debugPrint('   Offer items total: ${totalPriceOfofferItem.value}');\n      debugPrint('   FINAL TOTAL: ${total.value}');\n      debugPrint('   Total item count: ${totalCartItemCount.value}');\n    } catch (e) {\n      debugPrint(\"âŒ Error calculating totals: $e\");\n      totalCartItemCount.value = 0; // Reset on error\n      total.value = 0;\n      totalPrice.value = 0;\n      // rethrow; // Or handle gracefully\n    }\n  }\n\n  // Method to be called by GetxAreYouSureMapOrder\n  int getTotalItemCountInCart() {\n    return totalCartItemCount.value;\n  }\n\n  /// ØªØ­Ø¯Ø« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©\n  Future<void> refreshTotals() async {\n    debugPrint('refreshTotals11111111111111111111111');\n    await calculateTotals();\n    update();\n  }\n\n  /// Ø¯Ø§Ù„Ø© Ù„Ø²ÙŠØ§Ø¯Ø© ÙƒÙ…ÙŠØ© Ø¹Ù†ØµØ± Ù…Ø¹ÙŠÙ†.\n  /// ØªÙØ­Ø¯ÙÙ‘Ø« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª.\n  Future<void> incrementItem({\n    required String uidItem,\n    required String uidOfDoc,\n    required bool isOfer,\n    required String uidAdd,\n  }) async {\n    final String userId = FirebaseAuth.instance.currentUser!.uid;\n    final docRef = FirebaseFirestore.instance\n        .collection('the-chosen')\n        .doc(userId)\n        .collection(FirebaseX.appName)\n        .doc(uidOfDoc);\n\n    int currentCount = _itemQuantities[uidOfDoc] ?? 0;\n    currentCount++;\n    _itemQuantities[uidOfDoc] = currentCount;\n\n    // ØªØ­Ø¯ÙŠØ« Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… set (insert/update)\n    await docRef.set({\n      'uidUser': userId,\n      'uidItem': uidItem,\n      'uidOfDoc': uidOfDoc,\n      'number': currentCount,\n      'isOfer': isOfer,\n      'uidAdd': uidAdd,\n    });\n\n    await refreshTotals();\n    update();\n  }\n\n  /// Ø¯Ø§Ù„Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ ÙƒÙ…ÙŠØ© Ø¹Ù†ØµØ± Ù…Ø¹ÙŠÙ†.\n  /// Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© 1 Ø£Ùˆ Ø£Ù‚Ù„ØŒ ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„.\n  Future<void> decrementItem({\n    required String uidItem,\n    required String uidOfDoc,\n    required bool isOfer,\n    required String uidAdd,\n  }) async {\n    final String userId = FirebaseAuth.instance.currentUser!.uid;\n    final docRef = FirebaseFirestore.instance\n        .collection('the-chosen')\n        .doc(userId)\n        .collection(FirebaseX.appName)\n        .doc(uidOfDoc);\n\n    int currentCount = _itemQuantities[uidOfDoc] ?? 0;\n\n    if (currentCount <= 1) {\n      await docRef.delete();\n      _itemQuantities[uidOfDoc] = 0;\n    } else {\n      currentCount--;\n      _itemQuantities[uidOfDoc] = currentCount;\n      await docRef.update({\n        'uidUser': userId,\n        'uidItem': uidItem,\n        'uidOfDoc': uidOfDoc,\n        'number': currentCount,\n        'isOfer': isOfer,\n        'uidAdd': uidAdd,\n      });\n    }\n    await refreshTotals();\n    update();\n  }\n\n  /// Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù…Ø³ØªÙ†Ø¯ Ù…Ø¹ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ uidOfDoc.\n  int getCurrentItemCount(String uidOfDoc) {\n    return _itemQuantities[uidOfDoc] ?? 0;\n  }\n\n  @override\n  void onInit() {\n    super.onInit();\n    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØ­ÙƒÙ…\n    refreshTotals();\n    // ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© migration Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ uidAdd\n    _migrateCartItemsWithSellerId();\n  }\n\n  /// Ø¯Ø§Ù„Ø© migration Ù„Ø¥Ø¶Ø§ÙØ© uidAdd Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø³Ù„Ø©\n  Future<void> _migrateCartItemsWithSellerId() async {\n    final String userId = FirebaseAuth.instance.currentUser!.uid;\n    debugPrint('ğŸ”„ Starting cart migration to add seller IDs...');\n\n    try {\n      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø©\n      QuerySnapshot cartSnapshot =\n          await FirebaseFirestore.instance\n              .collection('the-chosen')\n              .doc(userId)\n              .collection(FirebaseX.appName)\n              .get();\n\n      int migratedCount = 0;\n\n      for (var doc in cartSnapshot.docs) {\n        final data = doc.data() as Map<String, dynamic>?;\n        if (data == null) continue;\n\n        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ uidAdd\n        if (data['uidAdd'] == null || data['uidAdd'].toString().isEmpty) {\n          final String uidItem = data['uidItem'] as String? ?? \"\";\n          final bool isOffer = data['isOfer'] as bool? ?? false;\n\n          if (uidItem.isNotEmpty) {\n            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©\n            DocumentSnapshot productDoc;\n            if (isOffer) {\n              productDoc =\n                  await FirebaseFirestore.instance\n                      .collection(FirebaseX.offersCollection)\n                      .doc(uidItem)\n                      .get();\n            } else {\n              productDoc =\n                  await FirebaseFirestore.instance\n                      .collection(FirebaseX.itemsCollection)\n                      .doc(uidItem)\n                      .get();\n            }\n\n            if (productDoc.exists) {\n              final productData = productDoc.data() as Map<String, dynamic>?;\n              final String uidAdd = productData?['uidAdd'] as String? ?? \"\";\n\n              if (uidAdd.isNotEmpty) {\n                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ Ø§Ù„Ø³Ù„Ø© Ø¨Ø¥Ø¶Ø§ÙØ© uidAdd\n                await doc.reference.update({'uidAdd': uidAdd});\n                migratedCount++;\n                debugPrint('âœ… Migrated item ${doc.id} with seller ID: $uidAdd');\n              } else {\n                debugPrint('âš ï¸ Product $uidItem has no seller ID');\n              }\n            }\n          }\n        }\n      }\n\n      if (migratedCount > 0) {\n        debugPrint(\n          'âœ… Migration completed: Updated $migratedCount items with seller IDs',\n        );\n        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«\n        await refreshTotals();\n      } else {\n        debugPrint('â„¹ï¸ No items needed migration');\n      }\n    } catch (e) {\n      debugPrint('âŒ Error during cart migration: $e');\n    }\n  }\n\n  @override\n  void dispose() {\n    update();\n    _itemQuantities.clear();\n    total.value = 0;\n    totalPriceOfItem.value = 0;\n    totalPriceOfofferItem.value = 0;\n    totalPrice.value = 0;\n    super.dispose();\n  }\n}\n"
        }
    ]
}