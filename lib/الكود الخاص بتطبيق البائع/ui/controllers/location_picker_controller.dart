import 'dart:async';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:geolocator/geolocator.dart';
import 'package:geocoding/geocoding.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../../../XXX/xxx_firebase.dart';

class LocationPickerController extends GetxController {
  GoogleMapController? mapController;
  final Rx<LatLng> currentLocation = const LatLng(33.3152, 44.3661).obs; // Ø¨ØºØ¯Ø§Ø¯ ÙƒÙ…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  final RxString selectedAddress = ''.obs;
  final RxString savedAddress = ''.obs;
  final RxBool isLoading = true.obs;
  final RxBool isMapReady = false.obs; // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  final RxSet<Marker> markers = <Marker>{}.obs;
  
  @override
  void onInit() {
    super.onInit();
    _initializeLocation();
  }
  
  /// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
  Future<void> _initializeLocation() async {
    try {
      debugPrint('ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹
      await _loadSavedAddress();
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      await getCurrentLocation();
      
      debugPrint('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹: $e');
      
      // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø¨ØºØ¯Ø§Ø¯)
      selectedAddress.value = 'Ø¨ØºØ¯Ø§Ø¯ØŒ Ø§Ù„Ø¹Ø±Ø§Ù‚ (Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ)';
      _updateMarker(currentLocation.value);
    } finally {
      isLoading.value = false;
    }
  }
  
  /// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø¨Ø§Ø¦Ø¹
  Future<void> _loadSavedAddress() async {
    try {
      final String? userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId == null) return;
      
      final doc = await FirebaseFirestore.instance
          .collection(FirebaseX.collectionSeller)
          .doc(userId)
          .get();
      
      if (doc.exists) {
        final data = doc.data() as Map<String, dynamic>;
        savedAddress.value = data['shopAddressText'] ?? '';
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒÙ…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if (savedAddress.value.isNotEmpty) {
          final GeoPoint? location = data['location'] as GeoPoint?;
          if (location != null) {
            currentLocation.value = LatLng(location.latitude, location.longitude);
            selectedAddress.value = savedAddress.value;
            _updateMarker(currentLocation.value);
          }
        }
      }
    } catch (e) {
      debugPrint('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸: $e');
    }
  }
  
  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
  Future<void> getCurrentLocation() async {
    try {
      debugPrint('ğŸ“ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ...');
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      LocationPermission permission = await Geolocator.checkPermission();
      debugPrint('ğŸ” ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: $permission');
      
      if (permission == LocationPermission.denied) {
        debugPrint('ğŸ” Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
        permission = await Geolocator.requestPermission();
        if (permission == LocationPermission.denied) {
          debugPrint('âŒ ØªÙ… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹');
          Get.snackbar(
            'Ø®Ø·Ø£',
            'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹',
            snackPosition: SnackPosition.BOTTOM,
            backgroundColor: Colors.red.withOpacity(0.8),
            colorText: Colors.white,
          );
          return;
        }
      }
      
      if (permission == LocationPermission.deniedForever) {
        debugPrint('âŒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø±ÙÙˆØ¶Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹');
        Get.snackbar(
          'Ø®Ø·Ø£',
          'ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
          snackPosition: SnackPosition.BOTTOM,
          backgroundColor: Colors.red.withOpacity(0.8),
          colorText: Colors.white,
        );
        return;
      }
      
      debugPrint('âœ… ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙÙ…Ù†ÙˆØ­Ø©');
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
      bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
      if (!serviceEnabled) {
        debugPrint('âŒ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ÙÙØ¹Ù„Ø©');
        Get.snackbar(
          'Ø®Ø·Ø£',
          'ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹',
          snackPosition: SnackPosition.BOTTOM,
          backgroundColor: Colors.red.withOpacity(0.8),
          colorText: Colors.white,
        );
        return;
      }
      
      debugPrint('ğŸ›°ï¸ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ...');
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      final Position position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.high,
        timeLimit: const Duration(seconds: 10), // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ Ø²Ù…Ù†ÙŠ
      );
      
      debugPrint('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${position.latitude}, ${position.longitude}');
      
      final LatLng newLocation = LatLng(position.latitude, position.longitude);
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (savedAddress.value.isEmpty) {
        currentLocation.value = newLocation;
        await _getAddressFromCoordinates(newLocation);
        if (isMapReady.value) {
          _updateMarker(newLocation);
        }
      }
      
      // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (mapController != null && isMapReady.value) {
        await mapController!.animateCamera(
          CameraUpdate.newCameraPosition(
            CameraPosition(
              target: currentLocation.value,
              zoom: 15.0,
            ),
          ),
        );
      }
    } on TimeoutException {
      debugPrint('â° Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
      Get.snackbar(
        'ØªÙ†Ø¨ÙŠÙ‡',
        'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø¬Ø§Ø±Ù Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.orange.withOpacity(0.8),
        colorText: Colors.white,
      );
    } catch (e) {
      debugPrint('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: $e');
      Get.snackbar(
        'Ø®Ø·Ø£',
        'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.red.withOpacity(0.8),
        colorText: Colors.white,
      );
    }
  }
  
  /// Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  void onMapCreated(GoogleMapController controller) {
    debugPrint('ğŸ—ºï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­');
    mapController = controller;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
    Future.delayed(const Duration(milliseconds: 500), () {
      isMapReady.value = true;
      _updateMarker(currentLocation.value);
      
      // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (mapController != null) {
        mapController!.animateCamera(
          CameraUpdate.newCameraPosition(
            CameraPosition(
              target: currentLocation.value,
              zoom: 15.0,
            ),
          ),
        );
      }
      debugPrint('âœ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
    });
  }
  
  /// Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  Future<void> onMapTap(LatLng location) async {
    currentLocation.value = location;
    await _getAddressFromCoordinates(location);
    _updateMarker(location);
  }
  
  /// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  void _updateMarker(LatLng location) {
    markers.clear();
    markers.add(
      Marker(
        markerId: const MarkerId('selected_location'),
        position: location,
        infoWindow: InfoWindow(
          title: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
          snippet: selectedAddress.value.isNotEmpty ? selectedAddress.value : 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯',
        ),
      ),
    );
  }
  
  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
  Future<void> _getAddressFromCoordinates(LatLng location) async {
    try {
      List<Placemark> placemarks = await placemarkFromCoordinates(
        location.latitude,
        location.longitude,
      );
      
      if (placemarks.isNotEmpty) {
        final Placemark place = placemarks.first;
        selectedAddress.value = [
          place.street,
          place.subLocality,
          place.locality,
          place.administrativeArea,
          place.country,
        ].where((element) => element != null && element.isNotEmpty).join(', ');
      }
    } catch (e) {
      debugPrint('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: $e');
      selectedAddress.value = 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    }
  }
  
  /// Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸
  Future<void> useCurrentLocation() async {
    if (savedAddress.value.isEmpty) return;
    
    try {
      final String? userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId == null) return;
      
      final doc = await FirebaseFirestore.instance
          .collection(FirebaseX.collectionSeller)
          .doc(userId)
          .get();
      
      if (doc.exists) {
        final data = doc.data() as Map<String, dynamic>;
        final GeoPoint? location = data['location'] as GeoPoint?;
        
        if (location != null) {
          currentLocation.value = LatLng(location.latitude, location.longitude);
          selectedAddress.value = savedAddress.value;
          _updateMarker(currentLocation.value);
          
          // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
          if (mapController != null) {
            await mapController!.animateCamera(
              CameraUpdate.newLatLng(currentLocation.value),
            );
          }
        }
      }
    } catch (e) {
      debugPrint('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸: $e');
    }
  }
  
  /// ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
  void confirmLocation() {
    if (selectedAddress.value.isEmpty) {
      Get.snackbar(
        'Ø®Ø·Ø£',
        'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ ØµØ­ÙŠØ­',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.red.withOpacity(0.8),
        colorText: Colors.white,
      );
      return;
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
    final selectedLocationData = {
      'address': selectedAddress.value,
      'latitude': currentLocation.value.latitude,
      'longitude': currentLocation.value.longitude,
    };
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
    Get.toNamed('/order-confirmation', arguments: selectedLocationData);
  }
  
  @override
  void onClose() {
    mapController?.dispose();
    super.onClose();
  }
} 